# Story 10.5: Request Status with Offer Context

| Field | Value |
|-------|-------|
| **Story ID** | 10-5 |
| **Epic** | Epic 10: Consumer Offer Selection |
| **Title** | Request Status with Offer Context |
| **Status** | ready-for-dev |
| **Priority** | P1 (High) |
| **Points** | 5 |
| **Sprint** | TBD |

---

## User Story

As a **consumer tracking their request**,
I want **to see the selected provider's offer details on the status page**,
So that **I have the delivery information I agreed to**.

---

## Background

After a consumer selects an offer (Story 10-2), the request status page should display the selected provider's details and the confirmed delivery window. This completes the consumer tracking experience for the V2 offer model.

The status page should also show a link to view offers when the request is still pending and has offers available.

---

## Acceptance Criteria

| AC# | Criterion | Notes |
|-----|-----------|-------|
| AC10.5.1 | Status page shows timeline: Solicitado → Aceptado → En Camino → Entregado | Visual progress indicator |
| AC10.5.2 | After offer selection, page shows selected provider name and phone | Contact info for delivery coordination |
| AC10.5.3 | Page shows confirmed delivery window: "Entrega estimada: 2:00 PM - 4:00 PM" | From selected offer |
| AC10.5.4 | "Llamar al repartidor" button with tel: link | Click-to-call functionality |
| AC10.5.5 | "Cancelar" button visible if request still cancellable | Before provider marks in_transit |
| AC10.5.6 | When no offer selected yet (pending), show "Ver Ofertas" button | Link to offers page |
| AC10.5.7 | Show offer count badge: "3 ofertas disponibles" | Encourage offer viewing |
| AC10.5.8 | Real-time status updates via Supabase Realtime | Status changes appear instantly |

---

## Atlas Workflow Analysis

> This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Consumer Water Request (V2)**: Completes the tracking view for V2 flow with offer context
- **Request Status Tracking**: Enhances existing tracking with provider/offer details

### Downstream Effects to Consider

- Existing consumer tracking tests may need updates
- Provider phone must be available from profile (from Epic 7)
- Cancellation flow (Story 4-5) may need adjustment for offer context

### Testing Implications

- **Existing tests to verify:** `consumer-tracking.spec.ts`, `consumer-request-status.spec.ts`
- **New scenarios to add:** Provider info display, delivery window display, offer count badge

### Workflow Chain Visualization

```
[Offer Selected (10-2)] → [THIS STORY: Status with Offer Context] → [Provider Delivers (3-6)] → [Complete]
                                        ↓
                              [Consumer can call provider]
```

---

## Tasks / Subtasks

- [ ] **Task 1: Status Timeline Component** (AC: 10.5.1)
  - [ ] Create or update `src/components/consumer/status-timeline.tsx`
  - [ ] Steps: Solicitado → Aceptado → En Camino → Entregado
  - [ ] Current step highlighted, future steps grayed
  - [ ] Map request.status to timeline step

- [ ] **Task 2: Provider Info Section** (AC: 10.5.2, 10.5.3, 10.5.4)
  - [ ] Create `src/components/consumer/provider-info-card.tsx`
  - [ ] Query provider profile with request (name, phone, avatar)
  - [ ] Display delivery window from request (copied from offer)
  - [ ] "Llamar al repartidor" button with `href="tel:${phone}"`
  - [ ] Handle missing phone gracefully

- [ ] **Task 3: Update Request Status Page** (AC: ALL)
  - [ ] Update `src/app/(consumer)/request/[id]/page.tsx`
  - [ ] Fetch selected offer and provider data
  - [ ] Conditionally render provider info (only if status >= 'accepted')
  - [ ] Show offer count and "Ver Ofertas" link when pending
  - [ ] Subscribe to Realtime for status changes

- [ ] **Task 4: Offer Count Badge** (AC: 10.5.6, 10.5.7)
  - [ ] Query active offers count for pending requests
  - [ ] Display badge: "{n} ofertas disponibles" / "{n} oferta disponible"
  - [ ] "Ver Ofertas" button linking to `/request/[id]/offers`
  - [ ] Hide when status is not 'pending'

- [ ] **Task 5: Cancellation Button Logic** (AC: 10.5.5)
  - [ ] Show "Cancelar" button only when cancellable
  - [ ] Cancellable: status in ['pending', 'accepted']
  - [ ] Not cancellable: status in ['in_transit', 'delivered', 'cancelled', 'no_offers']
  - [ ] Reuse cancellation action from Story 4-5

- [ ] **Task 6: Realtime Status Updates** (AC: 10.5.8)
  - [ ] Subscribe to water_requests changes for this request ID
  - [ ] Update UI immediately when status changes
  - [ ] Handle offer count updates (new offers while viewing)

- [ ] **Task 7: Guest Consumer Support** (AC: ALL)
  - [ ] Validate tracking_token for guest access
  - [ ] Show same content for guests and registered users
  - [ ] Guest can call provider (phone visible)

- [ ] **Task 8: E2E Tests** (AC: ALL)
  - [ ] Status timeline displays correct step
  - [ ] Provider info shows after offer selection
  - [ ] Delivery window displays correctly
  - [ ] "Llamar al repartidor" has correct tel: link
  - [ ] "Cancelar" button shows when cancellable
  - [ ] "Ver Ofertas" button shows for pending requests
  - [ ] Offer count badge displays correctly
  - [ ] Guest consumer sees all content

---

## Dev Notes

### Architecture Alignment

Per tech spec Epic 10:
- Page: `src/app/(consumer)/request/[id]/page.tsx` (UPDATE)
- Components: `status-timeline.tsx`, `provider-info-card.tsx` (CREATE)

### Data Query

```typescript
// Fetch request with provider and offer details
const { data: request } = await supabase
  .from('water_requests')
  .select(`
    *,
    provider:profiles!water_requests_provider_id_fkey(
      id,
      name,
      phone,
      avatar_url
    ),
    offers!water_requests_id_fkey(
      id,
      status
    )
  `)
  .eq('id', requestId)
  .single();

// Count active offers
const activeOfferCount = request.offers?.filter(o => o.status === 'active').length ?? 0;
```

### Status-to-Timeline Mapping

| Request Status | Timeline Step | Step Index |
|----------------|---------------|------------|
| pending | Solicitado | 0 |
| accepted | Aceptado | 1 |
| in_transit | En Camino | 2 |
| delivered | Entregado | 3 |
| cancelled | (Show cancelled state) | - |
| no_offers | (Show no offers state) | - |

### Component Hierarchy

```
RequestStatusPage
├── RequestSummary (amount, address, urgency)
├── StatusTimeline (4 steps)
├── ProviderInfoCard (if accepted)
│   ├── Avatar + Name
│   ├── Delivery Window
│   └── Call Button
├── OfferSection (if pending)
│   ├── Offer Count Badge
│   └── "Ver Ofertas" Button
└── ActionButtons
    ├── Cancelar (if cancellable)
    └── Nueva Solicitud (if terminal)
```

### Spanish Copy

| Element | Text |
|---------|------|
| Timeline step 1 | "Solicitado" |
| Timeline step 2 | "Aceptado" |
| Timeline step 3 | "En Camino" |
| Timeline step 4 | "Entregado" |
| Delivery window | "Entrega estimada: {start} - {end}" |
| Call button | "Llamar al repartidor" |
| Cancel button | "Cancelar" |
| View offers | "Ver Ofertas" |
| Offer count (plural) | "{n} ofertas disponibles" |
| Offer count (singular) | "1 oferta disponible" |

### Pattern Reuse

| Pattern | Source | Application |
|---------|--------|-------------|
| Status tracking | Story 2-5, 2-6 | Timeline component |
| Cancel flow | Story 4-5 | Cancellation action |
| Provider profile | Epic 7 | Phone, avatar display |
| Realtime | Epic 8 | Status updates |

### Click-to-Call

```typescript
// Provider info card
<Button asChild variant="outline" className="w-full">
  <a href={`tel:${provider.phone}`}>
    <Phone className="h-4 w-4 mr-2" />
    Llamar al repartidor
  </a>
</Button>
```

### Cancellation Rules

Per Story 4-5:
- Consumer can cancel when status is 'pending' or 'accepted'
- After 'in_transit', cancellation requires provider action
- Show explanation when not cancellable

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-10.md#4.5-Component-Structure]
- [Source: docs/epics.md#Story-10.5]
- [Source: docs/sprint-artifacts/epic2/2-6-request-status-page-consumer-view.md]
- [Source: docs/sprint-artifacts/epic4/4-5-cancel-pending-request.md]

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-19 | Story created with Atlas workflow analysis | Claude Opus 4.5 |
