# Story 10.1: Offer List View for Consumers

| Field | Value |
|-------|-------|
| **Story ID** | 10-1 |
| **Epic** | Epic 10: Consumer Offer Selection |
| **Title** | Offer List View for Consumers |
| **Status** | done |
| **Priority** | P0 (Critical) |
| **Points** | 5 |
| **Sprint** | TBD |

---

## User Story

As a **consumer with a pending request**,
I want **to view all offers submitted by providers**,
So that **I can compare options and choose the best fit for my needs**.

---

## Background

This is the foundation story for Epic 10's Consumer Offer Selection feature. It enables consumers to view offers submitted by providers on their water requests, completing the Consumer-Choice Offer Model (ADR-006).

Per Architecture V2, this transforms the consumer experience:
```
Consumer creates request → Providers submit offers → Consumer views offers → Consumer selects
```

This story implements the viewing portion - the consumer-side counterpart to Epic 8's provider offer submission.

---

## Acceptance Criteria

| AC# | Criterion | Notes |
|-----|-----------|-------|
| AC10.1.1 | Consumer sees "Ofertas Recibidas" section with count badge on request status page | Badge shows number of active offers |
| AC10.1.2 | Each offer card shows: provider name, avatar, delivery window, price, expiration countdown, "Seleccionar" button | Follow mockup layout |
| AC10.1.3 | Offers sorted by delivery window (soonest first) | User sees most immediate options first |
| AC10.1.4 | List updates in real-time via Supabase Realtime | New offers appear without page refresh |
| AC10.1.5 | Empty state shows "Esperando ofertas de repartidores..." with appropriate messaging | Include timeout notice: "Si no recibes ofertas en 4 horas, te notificaremos" |
| AC10.1.6 | Guest consumers can view offers using their tracking token | Reuse existing guest access pattern from Epic 2 |

---

## Atlas Workflow Analysis

> This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Consumer Water Request (V2)**: This story implements step 4 of the V2 consumer journey: "Offers Received → Compare"
- **Provider Offer Flow**: Creates downstream dependency - providers' active offers now visible to consumers

### Downstream Effects to Consider

- Story 10-2 (Select Offer) depends on this for the offer cards to have "Seleccionar" buttons
- Story 10-3 (Countdown Timer) integrates into offer cards created here
- Consumer tracking page (Story 2.6) needs navigation to offer list

### Testing Implications

- **Existing tests to verify:** `consumer-tracking.spec.ts`, `consumer-request-status.spec.ts`
- **New scenarios to add:** Consumer views offer list, realtime offer updates, guest access via token

### Workflow Chain Visualization

```
[Request Created] → [Provider Submits Offer (8-2)] → [THIS STORY: Offer List View] → [Consumer Selects (10-2)]
```

---

## Tasks / Subtasks

- [x] **Task 1: Create Consumer Offers Hook** (AC: 10.1.3, 10.1.4)
  - [x] Create `src/hooks/use-consumer-offers.ts`
  - [x] Query offers with provider profile data: `SELECT *, profiles:provider_id(name, avatar_url)`
  - [x] Filter by `request_id` and `status IN ('active', 'expired')`
  - [x] Sort by `delivery_window_start ASC`
  - [x] Subscribe to Supabase Realtime for INSERT/UPDATE events

- [x] **Task 2: Create Offer Card Component** (AC: 10.1.2)
  - [x] Create `src/components/consumer/offer-card.tsx`
  - [x] Display provider avatar with fallback to initials
  - [x] Display provider name
  - [x] Display delivery window: "Entrega: 2:00 PM - 4:00 PM"
  - [x] Display price (use `getDeliveryPrice()` from commission utils)
  - [x] Include countdown timer slot (integrated in Story 10-3)
  - [x] "Seleccionar" button (handler in Story 10-2)

- [x] **Task 3: Create Offer List Component** (AC: 10.1.1, 10.1.5)
  - [x] Create `src/components/consumer/offer-list.tsx`
  - [x] Header with "Ofertas Recibidas" and count badge
  - [x] Map offers to OfferCard components
  - [x] Empty state component with waiting messaging
  - [x] Include timeout notice about 4-hour window

- [x] **Task 4: Create Offer List Page** (AC: 10.1.6)
  - [x] Create `src/app/(consumer)/request/[id]/offers/page.tsx`
  - [x] Server component for initial data fetch
  - [x] Validate consumer ownership OR guest access via tracking token
  - [x] Pass request summary data to client component
  - [x] Handle request not found (404)

- [x] **Task 5: Client Component Integration** (AC: ALL)
  - [x] Create `src/app/(consumer)/request/[id]/offers/offers-client.tsx`
  - [x] Integrate useConsumerOffers hook
  - [x] Display request summary at top (amount, address, urgency)
  - [x] Render OfferList component
  - [x] Handle loading and error states

- [x] **Task 6: Update Request Status Page Navigation** (AC: 10.1.1)
  - [x] Update `src/app/(consumer)/request/[id]/page.tsx` (pending page not request page)
  - [x] Add "Ver Ofertas" button/link when request is pending
  - [x] Link to `/request/[id]/offers`
  - [x] Updated guest tracking page with "Ver Ofertas" button

- [x] **Task 7: E2E Tests** (AC: ALL)
  - [x] Consumer views offer list with active offers
  - [x] Offer cards display correct provider info
  - [x] Empty state displays when no offers
  - [x] Guest consumer accesses via tracking token
  - [x] Offers sorted by delivery window (tests written)

---

## Dev Notes

### Architecture Alignment

Per tech spec Epic 10, components are located at:
- Page: `src/app/(consumer)/request/[id]/offers/page.tsx`
- Hook: `src/hooks/use-consumer-offers.ts`
- Components: `src/components/consumer/offer-list.tsx`, `offer-card.tsx`

### Pattern Reuse from Epic 8

| Pattern | Source | Application |
|---------|--------|-------------|
| Realtime Subscriptions | `use-realtime-requests.ts` | Consumer offer updates |
| Offer Card Layout | `request-card.tsx` | Similar card structure |
| Status Badges | Epic 2 components | Offer count badge |

### Database Query

```sql
SELECT
  o.*,
  p.name as provider_name,
  p.avatar_url as provider_avatar
FROM offers o
JOIN profiles p ON o.provider_id = p.id
WHERE o.request_id = $1
  AND o.status IN ('active', 'expired')
ORDER BY o.delivery_window_start ASC
```

### Security Constraints

- RLS: Consumers can only view offers on their own requests
- Guest Access: Validate tracking_token matches request
- No provider contact info shown until offer is selected

### Spanish Copy

| Element | Text |
|---------|------|
| Section header | "Ofertas Recibidas" |
| Count badge | "{n} ofertas" / "{n} oferta" |
| Delivery window | "Entrega: {start} - {end}" |
| Empty state heading | "Esperando ofertas de repartidores..." |
| Empty state detail | "Tu solicitud fue enviada a los aguateros de la zona" |
| Timeout notice | "Si no recibes ofertas en 4 horas, te notificaremos" |
| Select button | "Seleccionar" |

### Project Structure Notes

- Follows existing consumer route patterns from Epic 2/4
- Nested under `(consumer)` route group
- Reuses consumer layout with mobile-first design

### Performance Requirements

- Offer list load: < 1s (per tech spec)
- Realtime update latency: < 500ms
- Works on 3G connection per NFR3

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-10.md#4.4-Realtime-Subscriptions]
- [Source: docs/epics.md#Story-10.1]
- [Source: docs/architecture.md#ADR-006-Consumer-Choice-Offer-Model]
- [Source: docs/ux-mockups/00-consolidated-consumer-flow.html]

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A

### Completion Notes List

- All 7 tasks completed successfully
- Build passes (npm run build)
- Lint passes (npm run lint)
- All 26 E2E tests pass (including 7 seeded data integration tests)
- Server component pattern used for guest access (matches tracking page pattern)
- "Seleccionar" button is placeholder - actual selection logic in Story 10-2
- Consumer-facing offers now seeded via `npm run seed:offers` for complete E2E coverage
- Initial offers fetched server-side for guests (bypasses RLS) then passed to client

### File List

**Created:**
- `src/hooks/use-consumer-offers.ts` - Realtime hook for consumer offer data
- `src/components/consumer/offer-card.tsx` - Individual offer card component
- `src/components/consumer/offer-list.tsx` - Offer list with empty state
- `src/app/(consumer)/request/[id]/offers/page.tsx` - Server component page
- `src/app/(consumer)/request/[id]/offers/offers-client.tsx` - Client component wrapper
- `tests/e2e/consumer-offers.spec.ts` - E2E test suite (25 tests)

**Modified:**
- `src/components/consumer/request-status-client.tsx` - Added "Ver Ofertas" button
- `src/app/track/[token]/page.tsx` - Added "Ver Ofertas" button for guests
- `docs/sprint-artifacts/sprint-status.yaml` - Updated story status

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-19 | Story created with Atlas workflow analysis | Claude Opus 4.5 |
| 2025-12-19 | Story implemented - all tasks complete, 19 E2E tests passing | Claude Opus 4.5 |
| 2025-12-19 | Updated seed:offers to add consumer-facing offers, all 26 E2E tests passing | Claude Opus 4.5 |
| 2025-12-19 | **Atlas Code Review fixes**: (1) Fixed avatar_url query placeholder in hook/page, (2) Added guest refresh button for non-realtime users, (3) Fixed developer jargon in toast to user-friendly Spanish, (4) Added aria-busy/aria-live to loading state for accessibility | Claude Opus 4.5 |
