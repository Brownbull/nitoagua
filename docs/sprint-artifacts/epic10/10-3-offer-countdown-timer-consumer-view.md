# Story 10.3: Offer Countdown Timer (Consumer View)

| Field | Value |
|-------|-------|
| **Story ID** | 10-3 |
| **Epic** | Epic 10: Consumer Offer Selection |
| **Title** | Offer Countdown Timer (Consumer View) |
| **Status** | done |
| **Priority** | P1 (High) |
| **Points** | 3 |
| **Sprint** | TBD |

---

## User Story

As a **consumer viewing offers**,
I want **to see how long each offer remains valid**,
So that **I know I need to decide before offers expire**.

---

## Background

This story adds time urgency visibility to the offer selection experience. Providers submit offers with an expiration time (from Epic 8), and consumers need to see how much time they have to make a decision.

**Pattern Reuse:** This story primarily reuses the existing `CountdownTimer` component from Epic 8 (created in Story 8-3) and integrates it into the consumer offer cards.

---

## Acceptance Criteria

| AC# | Criterion | Notes |
|-----|-----------|-------|
| AC10.3.1 | Each offer shows countdown: "Expira en MM:SS" when < 1 hour | Client-side countdown |
| AC10.3.2 | Countdown shows "Expira en X h MM min" when > 1 hour | More readable format for longer durations |
| AC10.3.3 | Visual urgency indicator: orange when < 10 min, red when < 5 min | Color draws attention to expiring offers |
| AC10.3.4 | When offer expires while viewing, card shows "Expirada" badge (gray) | Real-time expiration handling |
| AC10.3.5 | "Seleccionar" button disabled on expired offers | Prevent selection of expired offers |
| AC10.3.6 | Expired offers move to bottom of list or fade visually | Active offers remain prominent |
| AC10.3.7 | Countdown updates every second (client-side) | Smooth user experience |

---

## Atlas Workflow Analysis

> This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Consumer Offer Selection**: Adds urgency layer to offer comparison decision
- **Provider Offer Flow**: Expiration visibility helps consumers respect provider time commitments

### Downstream Effects to Consider

- Expired offers cannot be selected (Story 10-2 must check)
- Offer expiration cron (Story 6-7) runs server-side - this is client-side display only
- No workflow chain impact - this is a UX enhancement layer

### Testing Implications

- **Existing tests to verify:** None - new functionality
- **New scenarios to add:** Countdown display, color transitions, expiration handling

### Workflow Chain Visualization

```
[Offer Card (10-1)] + [THIS STORY: Countdown Timer] → [Selection Decision (10-2)]
                                  ↓
                        [Expired → Disabled]
```

---

## Tasks / Subtasks

- [x] **Task 1: Verify Existing Countdown Component** (AC: 10.3.1, 10.3.2, 10.3.7)
  - [x] Review `src/components/shared/countdown-timer.tsx` from Epic 8
  - [x] Verify it handles both < 1 hour and > 1 hour formats
  - [x] Confirm 1-second interval updates
  - [x] Identify any gaps for consumer use case

- [x] **Task 2: Add Urgency Styling Props** (AC: 10.3.3)
  - [x] Add `urgencyThresholds` prop to CountdownTimer (optional)
  - [x] Default thresholds: orange at 10 min, red at 5 min
  - [x] Implement color transitions based on time remaining
  - [x] Use Tailwind classes: `text-orange-500`, `text-red-500`

- [x] **Task 3: Expired State Handling** (AC: 10.3.4, 10.3.5)
  - [x] Add `onExpire` callback prop to CountdownTimer
  - [x] When expired, trigger parent state update
  - [x] Display "Expirada" badge in OfferCard
  - [x] Gray out entire card with opacity
  - [x] Disable "Seleccionar" button

- [x] **Task 4: Integrate into Offer Card** (AC: ALL)
  - [x] Import CountdownTimer in `offer-card.tsx`
  - [x] Pass `expires_at` from offer data
  - [x] Handle expired state with local state
  - [x] Pass expiredText="Expirada"
  - [x] Apply urgency colors to timer display

- [x] **Task 5: List Sorting for Expired Offers** (AC: 10.3.6)
  - [x] Update OfferList to track expired offer IDs
  - [x] Sort: active offers by delivery window, then expired at bottom
  - [x] Apply visual fade (opacity-50) to expired offers
  - [x] Consider hiding expired offers after N seconds

- [x] **Task 6: Timezone Handling** (AC: 10.3.1)
  - [x] Verify `expires_at` is stored as UTC
  - [x] Calculate remaining time from current UTC
  - [x] Display should be timezone-agnostic (countdown, not clock time)

- [x] **Task 7: E2E Tests** (AC: ALL)
  - [x] Countdown displays correctly on offer card
  - [x] Timer updates visually (hard to test exact seconds)
  - [x] Orange color appears when < 10 min (mock time)
  - [x] Red color appears when < 5 min (mock time)
  - [x] Expired offer shows "Expirada" badge
  - [x] Expired offer has disabled button
  - [x] Expired offers sorted to bottom

---

## Dev Notes

### Architecture Alignment

Per tech spec Epic 10:
- Component: `src/components/shared/countdown-timer.tsx` (EXISTS from Epic 8)
- Hook: Consider extracting `useCountdown` hook if not already done

### Existing Component Review

Check `src/components/shared/countdown-timer.tsx` for:
```typescript
interface CountdownTimerProps {
  expiresAt: string | Date;
  expiredText?: string;
  onExpire?: () => void;
  showUrgencyColors?: boolean;  // May need to add
}
```

### Time Format Rules

| Time Remaining | Format | Example |
|----------------|--------|---------|
| > 1 hour | "X h MM min" | "2 h 15 min" |
| 1 hour - 10 min | "MM:SS" | "45:30" |
| < 10 min | "MM:SS" (orange) | "08:45" |
| < 5 min | "MM:SS" (red) | "03:22" |
| Expired | "Expirada" (gray) | "Expirada" |

### Color Scheme

```css
/* Normal */
.text-muted-foreground

/* Warning (< 10 min) */
.text-orange-500

/* Critical (< 5 min) */
.text-red-500

/* Expired */
.text-muted-foreground + opacity-50 on card
```

### Pattern Reuse from Epic 8

| Pattern | Source | Notes |
|---------|--------|-------|
| Countdown Timer | `src/components/shared/countdown-timer.tsx` | May need enhancement |
| useCountdown hook | `src/hooks/use-countdown.ts` | Check if exists |
| date-fns | Already installed | Use for calculations |

### Spanish Copy

| Element | Text |
|---------|------|
| Expires in | "Expira en {time}" |
| Expired | "Expirada" |
| Hours format | "{n} h {m} min" |
| Minutes format | "MM:SS" |

### Performance Considerations

- Timer runs client-side only - no server calls
- Use `requestAnimationFrame` or `setInterval` (1000ms)
- Cleanup interval on unmount
- Avoid re-rendering entire list on each tick

### Timezone Notes

- Database stores `expires_at` in UTC (TIMESTAMPTZ)
- JavaScript Date handles timezone automatically
- Countdown calculation is timezone-agnostic: `expires_at - now`
- No need to display actual clock time, just remaining duration

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-10.md#4.5-Component-Structure]
- [Source: docs/epics.md#Story-10.3]
- [Source: docs/sprint-artifacts/epic8/8-3-providers-active-offers-list.md] (CountdownTimer origin)

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Unit tests: `npx vitest run tests/unit/countdown-timer.test.ts` - 33 tests passing
- E2E tests: `npx playwright test tests/e2e/consumer-offer-countdown.spec.ts` - 12 tests passing

### Completion Notes List

1. **Format Update (AC10.3.2)**: Changed > 1 hour format from "H:MM:SS" to "X h MM min" for better readability
2. **Threshold Update (AC10.3.3)**: Updated warning threshold from 5 min to 10 min, critical from 1 min to 5 min
3. **Exported Constants**: Added `COUNTDOWN_THRESHOLDS` export for unit testing and future configuration
4. **Real-time Expiration (AC10.3.4)**: Added local state tracking in OfferCard with `onExpire` callback
5. **List Sorting (AC10.3.6)**: Added `expiredDuringView` state in OfferList to sort expired offers to bottom dynamically

### Code Review Fixes (2025-12-21)

1. **[MEDIUM] data-testid prop typing**: Added `data-testid` prop to CountdownTimerProps interface and passed through to DOM elements
2. **[LOW] Accessibility fix**: Added `aria-live="polite"` and `aria-label="Oferta expirada"` to expired state for screen reader announcements

### File List

- `src/lib/utils/countdown.ts` - Updated format and thresholds
- `src/components/shared/countdown-timer.tsx` - Updated default colors
- `src/components/consumer/offer-card.tsx` - Added onExpire prop and local expired state
- `src/components/consumer/offer-list.tsx` - Added expired offer sorting
- `tests/unit/countdown-timer.test.ts` - Updated tests for new thresholds/format
- `tests/e2e/consumer-offer-countdown.spec.ts` - New E2E tests for countdown

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-19 | Story created with Atlas workflow analysis | Claude Opus 4.5 |
| 2025-12-19 | All tasks completed, E2E and unit tests passing | Claude Opus 4.5 |
| 2025-12-21 | Atlas code review: Fixed data-testid prop typing, added aria-live to expired state | Claude Opus 4.5 |
