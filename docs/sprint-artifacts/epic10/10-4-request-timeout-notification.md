# Story 10.4: Request Timeout Notification

| Field | Value |
|-------|-------|
| **Story ID** | 10-4 |
| **Epic** | Epic 10: Consumer Offer Selection |
| **Title** | Request Timeout Notification |
| **Status** | ready-for-dev |
| **Priority** | P1 (High) |
| **Points** | 5 |
| **Sprint** | TBD |

---

## User Story

As a **consumer whose request received no offers**,
I want **to be notified when my request times out**,
So that **I know to try again or contact support**.

---

## Background

In rural Chile context, there may be times when no providers are available or willing to deliver to a particular area. After 4 hours without offers, the platform should proactively notify the consumer rather than leaving them waiting indefinitely.

This story implements a cron job that runs every 15 minutes to check for timed-out requests and notify consumers.

---

## Acceptance Criteria

| AC# | Criterion | Notes |
|-----|-----------|-------|
| AC10.4.1 | Requests pending for 4+ hours with no offers trigger timeout | Cron job runs every 15 minutes |
| AC10.4.2 | Request status changes to 'no_offers' | New status added to enum |
| AC10.4.3 | Consumer receives in-app notification about timeout | If registered user |
| AC10.4.4 | Consumer receives email notification about timeout | If email provided (guest or registered) |
| AC10.4.5 | Status page shows "Sin Ofertas" with orange badge | Clear visual indicator |
| AC10.4.6 | Status page shows message: "Lo sentimos, no hay aguateros disponibles ahora" | Empathetic messaging |
| AC10.4.7 | Status page shows "Nueva Solicitud" button | Easy retry path |
| AC10.4.8 | Status page shows "Contactar Soporte" link (WhatsApp) | Alternative help path |

---

## Atlas Workflow Analysis

> This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Consumer Water Request (V2)**: Adds "no offers" terminal state to workflow
- **Request Status Tracking**: New status requires display handling

### Downstream Effects to Consider

- Story 11-3 (Negative Status States) may overlap - coordinate designs
- Provider dashboard doesn't need to show timed-out requests (already filtered)
- Analytics may want to track timeout rate by comuna

### Testing Implications

- **Existing tests to verify:** Cron job infrastructure from Epic 6-7
- **New scenarios to add:** Timeout trigger, notifications, status display

### Workflow Chain Visualization

```
[Request Created] → [4 hours, no offers] → [THIS STORY: Timeout] → [Consumer Notified]
                                                    ↓
                                          [Status: no_offers]
```

---

## Tasks / Subtasks

- [ ] **Task 1: Database Migration - Add no_offers Status** (AC: 10.4.2)
  - [ ] Create migration to add 'no_offers' to water_requests status enum
  - [ ] Verify RLS policies still work with new status
  - [ ] Add index for timeout query optimization

- [ ] **Task 2: Create Cron Job Route** (AC: 10.4.1)
  - [ ] Create `src/app/api/cron/request-timeout/route.ts`
  - [ ] Query: `SELECT * FROM water_requests WHERE status = 'pending' AND created_at < NOW() - INTERVAL '4 hours'`
  - [ ] Exclude requests that already have offers (just no selection yet)
  - [ ] Process in batches to avoid timeouts
  - [ ] Add Vercel cron configuration

- [ ] **Task 3: Update Request Status** (AC: 10.4.2)
  - [ ] Update request status to 'no_offers'
  - [ ] Set `timed_out_at` timestamp (may need new column)
  - [ ] Use service role client for cron operations

- [ ] **Task 4: In-App Notification** (AC: 10.4.3)
  - [ ] Create notification for registered consumers
  - [ ] Type: 'request_timeout'
  - [ ] Title: "Sin ofertas disponibles"
  - [ ] Body: "Tu solicitud de agua no recibió ofertas. Intenta de nuevo."
  - [ ] Link to request status page

- [ ] **Task 5: Email Notification** (AC: 10.4.4)
  - [ ] Create `emails/request-timeout.tsx` React Email template
  - [ ] Include: request summary, explanation, retry CTA
  - [ ] Send to consumer email (guest or registered)
  - [ ] Add to Resend send flow

- [ ] **Task 6: Status Page - No Offers State** (AC: 10.4.5, 10.4.6, 10.4.7, 10.4.8)
  - [ ] Update `src/app/(consumer)/request/[id]/page.tsx`
  - [ ] Handle `status === 'no_offers'` case
  - [ ] Display "Sin Ofertas" badge (orange)
  - [ ] Display empathetic message
  - [ ] "Nueva Solicitud" button linking to `/`
  - [ ] "Contactar Soporte" WhatsApp link

- [ ] **Task 7: Vercel Cron Configuration** (AC: 10.4.1)
  - [ ] Add to `vercel.json`:
    ```json
    {
      "crons": [{
        "path": "/api/cron/request-timeout",
        "schedule": "*/15 * * * *"
      }]
    }
    ```
  - [ ] Add `CRON_SECRET` environment variable
  - [ ] Validate cron secret in route handler

- [ ] **Task 8: E2E Tests** (AC: ALL)
  - [ ] Status page displays no_offers state correctly
  - [ ] "Nueva Solicitud" button navigates to home
  - [ ] "Contactar Soporte" link has correct WhatsApp URL
  - [ ] (Integration test) Cron endpoint returns 200 on valid secret
  - [ ] (Integration test) Cron endpoint returns 401 on invalid secret

---

## Dev Notes

### Architecture Alignment

Per tech spec Epic 10:
- Cron Route: `src/app/api/cron/request-timeout/route.ts`
- Email Template: `emails/request-timeout.tsx`
- Status handling in existing request status page

### Cron Job Pattern from Epic 6-7

```typescript
// src/app/api/cron/request-timeout/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

export async function GET(request: NextRequest) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  );

  // Find timed-out requests (4+ hours, pending, no offers)
  const { data: timedOutRequests } = await supabase
    .from('water_requests')
    .select('id, consumer_id, consumer_email, tracking_token')
    .eq('status', 'pending')
    .lt('created_at', new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString())
    .is('provider_id', null);  // No provider assigned

  // Process each...
}

export const dynamic = 'force-dynamic';
```

### Query Optimization

```sql
-- Find requests pending for 4+ hours with no offers
SELECT wr.*
FROM water_requests wr
LEFT JOIN offers o ON wr.id = o.request_id AND o.status = 'active'
WHERE wr.status = 'pending'
  AND wr.created_at < NOW() - INTERVAL '4 hours'
  AND o.id IS NULL  -- No active offers
```

### Email Template

```tsx
// emails/request-timeout.tsx
export default function RequestTimeoutEmail({
  requestId,
  address,
  amount,
  trackingToken,
}: RequestTimeoutEmailProps) {
  return (
    <Html>
      <Head />
      <Body>
        <Container>
          <Heading>Lo sentimos, no hay aguateros disponibles</Heading>
          <Text>
            Tu solicitud de {amount} litros en {address} no recibió ofertas
            de repartidores en las últimas 4 horas.
          </Text>
          <Text>
            Esto puede ocurrir en horarios de baja demanda o zonas con pocos
            aguateros registrados.
          </Text>
          <Button href={`${baseUrl}/request/${requestId}?token=${trackingToken}`}>
            Intentar de Nuevo
          </Button>
          <Text>
            ¿Necesitas ayuda? Contáctanos por WhatsApp: +56 9 XXXX XXXX
          </Text>
        </Container>
      </Body>
    </Html>
  );
}
```

### Spanish Copy

| Element | Text |
|---------|------|
| Status badge | "Sin Ofertas" |
| Main message | "Lo sentimos, no hay aguateros disponibles ahora" |
| Detail | "Tu solicitud no recibió ofertas en 4 horas" |
| Suggestion | "Intenta de nuevo más tarde o contacta soporte" |
| Retry button | "Nueva Solicitud" |
| Support link | "Contactar Soporte" |
| Notification title | "Sin ofertas disponibles" |
| Notification body | "Tu solicitud de agua no recibió ofertas. Intenta de nuevo." |

### WhatsApp Support Link

```typescript
const WHATSAPP_SUPPORT = 'https://wa.me/56912345678?text=Hola,%20necesito%20ayuda%20con%20mi%20solicitud';
```

### Performance Considerations

- Cron runs every 15 minutes (not real-time, but timely)
- Batch process requests to avoid timeouts
- Use service role for cron (bypasses RLS)
- Log processing stats for monitoring

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-10.md#4.3-Request-Timeout-Cron]
- [Source: docs/epics.md#Story-10.4]
- [Source: docs/sprint-artifacts/epic6/6-7-offer-expiration-cron-job.md] (Cron pattern)
- [Source: docs/sprint-artifacts/epic5/5-2-guest-email-notifications.md] (Email pattern)

---

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-19 | Story created with Atlas workflow analysis | Claude Opus 4.5 |
