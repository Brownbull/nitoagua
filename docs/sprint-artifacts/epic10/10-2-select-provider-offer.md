# Story 10.2: Select Provider Offer

| Field | Value |
|-------|-------|
| **Story ID** | 10-2 |
| **Epic** | Epic 10: Consumer Offer Selection |
| **Title** | Select Provider Offer |
| **Status** | done |
| **Priority** | P0 (Critical) |
| **Points** | 8 |
| **Sprint** | TBD |

---

## User Story

As a **consumer viewing offers**,
I want **to select my preferred provider's offer**,
So that **my water delivery is confirmed with that provider**.

---

## Background

This is the core transaction story for Epic 10. It enables consumers to select one offer from multiple providers, triggering:
1. The selected offer status changes to 'accepted'
2. The request status changes to 'accepted' with provider assignment
3. All other offers on the request change to 'request_filled'
4. Notifications are sent to all affected parties

This completes the Consumer-Choice Offer Model (ADR-006) transaction flow.

---

## Acceptance Criteria

| AC# | Criterion | Notes |
|-----|-----------|-------|
| AC10.2.1 | Tapping "Seleccionar" on offer card opens confirmation modal | Modal shows full offer details |
| AC10.2.2 | Confirmation modal displays: provider name/avatar, delivery window, price | Clear summary before commitment |
| AC10.2.3 | "Confirmar Selección" button triggers atomic offer selection | Transaction must be atomic |
| AC10.2.4 | Selected offer status changes to 'accepted' with `accepted_at` timestamp | Database state transition |
| AC10.2.5 | Request status changes to 'accepted' with `provider_id` assigned | Provider now linked to request |
| AC10.2.6 | All other offers on request change to 'request_filled' | Clear that request is taken |
| AC10.2.7 | Consumer sees success toast: "¡Listo! Tu pedido fue asignado a [Provider Name]" | Immediate feedback |
| AC10.2.8 | Consumer is redirected to updated request status page | See delivery details |
| AC10.2.9 | Selected provider receives in-app notification and email | Reuse Epic 8 notification pattern |
| AC10.2.10 | Other providers receive in-app notification (offer cancelled) | Optional email for cancelled offers |

---

## Atlas Workflow Analysis

> This section was generated by Atlas workflow chain analysis

### Affected Workflows

- **Consumer Water Request (V2)**: This story implements step 5 of V2 journey: "Accept Offer → Track"
- **Provider Offer Flow**: Triggers "Accepted?" decision point - provider notified and routes to customer
- **Settlement Workflow**: Sets up commission tracking once delivery completes

### Downstream Effects to Consider

- Story 10-5 (Status with Offer Context) depends on the offer being selected
- Provider dashboard will show the accepted offer with customer details
- Commission ledger entry will be created when delivery completes

### Testing Implications

- **Existing tests to verify:** `provider-offer-notification.spec.ts` (provider receives acceptance)
- **New scenarios to add:** Atomic transaction, race conditions, guest consumer selection

### Workflow Chain Visualization

```
[Offer List View (10-1)] → [THIS STORY: Select Offer] → [Provider Notified] → [Delivery (Epic 3)] → [Commission (8-7)]
                                    ↓
                           [Other Offers Cancelled]
```

---

## Tasks / Subtasks

- [x] **Task 1: Database Function - select_offer** (AC: 10.2.4, 10.2.5, 10.2.6)
  - [x] Create migration with `select_offer(p_offer_id, p_request_id)` function
  - [x] Update selected offer: `status = 'accepted', accepted_at = NOW()`
  - [x] Cancel other offers: `status = 'request_filled'`
  - [x] Update request: `status = 'accepted', provider_id = offer.provider_id`
  - [x] Copy delivery window from offer to request
  - [x] Mark as SECURITY DEFINER for atomic execution

- [x] **Task 2: Server Action - selectOffer** (AC: 10.2.3, 10.2.9, 10.2.10)
  - [x] Add `selectOffer(offerId: string)` to `src/lib/actions/offers.ts`
  - [x] Authenticate consumer (support both registered and guest)
  - [x] Validate offer is active and belongs to consumer's request
  - [x] Call `select_offer` database function
  - [x] Create in-app notification for selected provider
  - [x] Create in-app notifications for other providers (request_filled)
  - [x] Send email to selected provider (reuse 8-5 pattern)
  - [x] Revalidate request path

- [x] **Task 3: Confirmation Modal Component** (AC: 10.2.1, 10.2.2)
  - [x] Create `src/components/consumer/offer-selection-modal.tsx`
  - [x] Use shadcn/ui AlertDialog pattern
  - [x] Display provider avatar and name prominently
  - [x] Display delivery window: "Entrega estimada: 2:00 PM - 4:00 PM"
  - [x] Display price with CLP formatting
  - [x] "Confirmar Selección" primary button
  - [x] "Volver" secondary button
  - [x] Loading state while processing

- [x] **Task 4: Selection Handler Integration** (AC: 10.2.7, 10.2.8)
  - [x] Add `onSelect` handler to OfferCard component
  - [x] Implement `useState` for selected offer and modal open state
  - [x] Handle loading state with disabled button
  - [x] Show success toast on completion
  - [x] Redirect to `/request/[id]` on success
  - [x] Show error toast on failure with retry option

- [x] **Task 5: RLS Policies** (AC: 10.2.3)
  - [x] Uses service_role via admin client - RLS bypassed for atomic operation
  - [x] Consumer ownership validated in server action before calling database function
  - [x] Verify no other user can select offers on someone else's request

- [x] **Task 6: Guest Consumer Support** (AC: ALL)
  - [x] Validate tracking_token for guest access
  - [x] Pass token through server action for validation
  - [x] Ensure guest can complete selection flow
  - [x] Test with mock guest tracking token

- [x] **Task 7: E2E Tests** (AC: ALL)
  - [x] Confirmation modal displays correctly
  - [x] Modal content in Spanish
  - [x] Guest consumer can access selection modal
  - [x] Loading state on confirm button
  - [x] Cancel button closes modal without selection
  - [x] Accessibility tests (ARIA, keyboard navigation)

---

## Dev Notes

### Architecture Alignment

Per tech spec Epic 10:
- Server Action: `src/lib/actions/offers.ts` - add `selectOffer()`
- Database Function: `select_offer(p_offer_id, p_request_id)`
- Modal: `src/components/consumer/offer-selection-modal.tsx`

### Database Function Design

```sql
CREATE OR REPLACE FUNCTION select_offer(
  p_offer_id UUID,
  p_request_id UUID
) RETURNS VOID AS $$
BEGIN
  -- Update selected offer
  UPDATE offers
  SET status = 'accepted', accepted_at = NOW()
  WHERE id = p_offer_id
    AND status = 'active';  -- Guard: only active offers

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Offer not found or not active';
  END IF;

  -- Cancel all other offers on this request
  UPDATE offers
  SET status = 'request_filled'
  WHERE request_id = p_request_id
    AND id != p_offer_id
    AND status = 'active';

  -- Update request with provider assignment
  UPDATE water_requests
  SET
    status = 'accepted',
    provider_id = (SELECT provider_id FROM offers WHERE id = p_offer_id),
    delivery_window_start = (SELECT delivery_window_start FROM offers WHERE id = p_offer_id),
    delivery_window_end = (SELECT delivery_window_end FROM offers WHERE id = p_offer_id)
  WHERE id = p_request_id
    AND status = 'pending';  -- Guard: only pending requests

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Request not found or already processed';
  END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### Pattern Reuse

| Pattern | Source | Application |
|---------|--------|-------------|
| AlertDialog | Epic 3 (mark delivered) | Confirmation modal |
| Server Actions | Epic 8 (submitOffer) | selectOffer action |
| Email Notifications | Epic 8 (8-5) | Provider acceptance email |
| Toast Notifications | Epic 3, 8 | Success/error feedback |

### Security Constraints

- **Atomic Transaction**: Use database function with SECURITY DEFINER
- **Authorization**: Validate consumer owns request before selection
- **Race Conditions**: Handle case where offer expires during selection
- **Guest Access**: Validate tracking_token matches request

### Spanish Copy

| Element | Text |
|---------|------|
| Modal title | "Confirmar Selección" |
| Delivery window | "Entrega estimada: {start} - {end}" |
| Confirm button | "Confirmar Selección" |
| Cancel button | "Volver" |
| Success toast | "¡Listo! Tu pedido fue asignado a {provider_name}" |
| Error toast | "Error al seleccionar oferta. Intenta de nuevo." |
| Provider notification | "¡Tu oferta fue aceptada!" |
| Other provider notification | "La solicitud ya fue asignada" |

### Notifications

**Selected Provider:**
- In-app: "¡Tu oferta fue aceptada! Un cliente seleccionó tu oferta de entrega."
- Email: Reuse `offer-accepted.tsx` template from Epic 8-5

**Other Providers:**
- In-app only: "La solicitud ya fue asignada a otro repartidor"

### Performance Requirements

- Selection confirmation: < 2s end-to-end
- Transaction atomicity: All-or-nothing

### References

- [Source: docs/sprint-artifacts/tech-spec-epic-10.md#4.3-Server-Action-selectOffer]
- [Source: docs/epics.md#Story-10.2]
- [Source: docs/sprint-artifacts/epic8/8-5-offer-acceptance-notification.md]
- [Source: docs/architecture.md#ADR-005-Server-Actions]

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Build passed after type assertion fix for RPC call (Supabase types not regenerated)
- All 11 new E2E tests pass
- All 26 existing Story 10-1 tests still pass

### Completion Notes List

1. Created atomic `select_offer` database function with transaction safety
2. Server action validates consumer ownership (registered or guest via tracking_token)
3. Uses existing `notifyProviderOfferAccepted` for selected provider notification
4. Added new `notifyOtherProvidersOfferCancelled` for cancelled offer notifications
5. Modal follows Epic 3 AlertDialog pattern with Spanish copy
6. Guest support via tracking token passed through component chain

### File List

**New Files:**
- `supabase/migrations/20251219200000_add_select_offer_function.sql` - Database function
- `src/components/consumer/offer-selection-modal.tsx` - Confirmation modal
- `src/app/(consumer)/request/[id]/offers/page.tsx` - Offers page (server component)
- `src/app/(consumer)/request/[id]/offers/offers-client.tsx` - Offers client with modal integration
- `tests/e2e/consumer-offer-selection.spec.ts` - 14 E2E tests (modal + integration)

**Modified Files:**
- `src/lib/actions/offers.ts` - Added `selectOffer` server action and `notifyOtherProvidersOfferCancelled` helper
- `src/app/track/[token]/page.tsx` - Added "Ver Ofertas" button for guest consumers
- `src/components/consumer/request-status-client.tsx` - Added "Ver Ofertas" button for authenticated consumers
- `scripts/local/seed-offer-tests.ts` - Added consumer-facing offer test data
- `tests/fixtures/test-data.ts` - Added `CONSUMER_OFFERS_TEST_DATA` constants

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2025-12-19 | Story created with Atlas workflow analysis | Claude Opus 4.5 |
| 2025-12-19 | Implementation complete - all tasks done, 11 E2E tests passing | Claude Opus 4.5 |
| 2025-12-19 | Code review: Fixed DB function security (offer-request validation), added 3 integration tests, updated File List, fixed Spanish accents | Claude Opus 4.5 |
