<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>6.5</storyId>
    <title>Cash Settlement Tracking</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/epic6/6-5-cash-settlement-tracking.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>admin</asA>
    <iWant>to track and verify commission payments from providers</iWant>
    <soThat>cash settlements are properly recorded</soThat>
    <tasks>
      <task id="1" ac="1">
        <name>Settlement Page Route</name>
        <subtasks>
          <subtask>Create src/app/admin/settlement/page.tsx</subtask>
          <subtask>Add "Liquidaciones" link to sidebar (update Finanzas or add new item)</subtask>
          <subtask>Verify auth guard protects route</subtask>
        </subtasks>
      </task>
      <task id="2" ac="1">
        <name>Summary Cards</name>
        <subtasks>
          <subtask>Total pending card: Sum all commission_owed not yet paid</subtask>
          <subtask>Overdue card (>7 days): Filter by age</subtask>
          <subtask>Pending verifications card: Count withdrawal_requests with status='pending'</subtask>
        </subtasks>
      </task>
      <task id="3" ac="2,4">
        <name>Pending Payments Table</name>
        <subtasks>
          <subtask>Create src/components/admin/settlement-table.tsx</subtask>
          <subtask>Query withdrawal_requests WHERE status = 'pending'</subtask>
          <subtask>Columns: Provider, Amount, Receipt thumbnail, Date, Actions</subtask>
          <subtask>Receipt thumbnail opens image viewer</subtask>
        </subtasks>
      </task>
      <task id="4" ac="3">
        <name>Provider Balances Table</name>
        <subtasks>
          <subtask>Aggregate commission_ledger by provider</subtask>
          <subtask>Calculate days outstanding from oldest unpaid entry</subtask>
          <subtask>Columns: Provider, Total Owed, Days Outstanding, Last Payment</subtask>
          <subtask>"Ver Detalle" link per provider</subtask>
        </subtasks>
      </task>
      <task id="5" ac="4,5,6,8">
        <name>Payment Verification Flow</name>
        <subtasks>
          <subtask>"Verificar" button opens modal</subtask>
          <subtask>Receipt image viewer</subtask>
          <subtask>Bank reference input (optional)</subtask>
          <subtask>"Confirmar Pago" button</subtask>
          <subtask>Insert commission_paid entry in ledger</subtask>
          <subtask>Update withdrawal_request status = 'completed'</subtask>
          <subtask>Notify provider: "Pago confirmado"</subtask>
        </subtasks>
      </task>
      <task id="6" ac="7,8">
        <name>Payment Rejection Flow</name>
        <subtasks>
          <subtask>"Rechazar" button opens modal</subtask>
          <subtask>Reason required (dropdown or text)</subtask>
          <subtask>Update withdrawal_request status = 'rejected'</subtask>
          <subtask>Notify provider with reason</subtask>
        </subtasks>
      </task>
      <task id="7" ac="3">
        <name>Provider Balance Detail</name>
        <subtasks>
          <subtask>Create detail view for individual provider</subtask>
          <subtask>Show full ledger history</subtask>
          <subtask>Aging buckets: Current (&lt;7d), Week (7-14d), Overdue (>14d)</subtask>
        </subtasks>
      </task>
      <task id="8" ac="All">
        <name>Testing</name>
        <subtasks>
          <subtask>E2E test: View settlement dashboard</subtask>
          <subtask>E2E test: Verify payment with bank reference</subtask>
          <subtask>E2E test: Reject payment with reason</subtask>
          <subtask>E2E test: View provider balance detail</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC6.5.1">Settlement page shows summary cards: total pending, overdue, pending verifications</criterion>
    <criterion id="AC6.5.2">Pending payments table shows: provider, amount, receipt, date, actions</criterion>
    <criterion id="AC6.5.3">Provider balances table shows: provider, total owed, days outstanding</criterion>
    <criterion id="AC6.5.4">Admin can view uploaded receipt image</criterion>
    <criterion id="AC6.5.5">Admin can enter bank reference and confirm payment</criterion>
    <criterion id="AC6.5.6">Confirmation creates commission_paid entry in ledger</criterion>
    <criterion id="AC6.5.7">Admin can reject payment with reason</criterion>
    <criterion id="AC6.5.8">Provider notified of payment verification result</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/epic6/tech-spec-epic-6.md</path>
        <title>Epic 6 Technical Specification</title>
        <section>Story 6.5: Cash Settlement Tracking</section>
        <snippet>Commission tracking uses commission_ledger table with types: 'commission_owed', 'commission_paid', 'adjustment'. Balance = SUM(owed) - SUM(paid + adjustment).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document V2</title>
        <section>Pattern 2: Cash Settlement Tracking</section>
        <snippet>Cash delivery creates commission_owed entry. Provider transfers commission to platform bank. Admin confirms creates commission_paid entry. Provider balance updated.</snippet>
      </doc>
      <doc>
        <path>docs/prd-v2.md</path>
        <title>PRD V2</title>
        <section>FR99-102: Admin Settlement Management</section>
        <snippet>Admins can view providers with outstanding commission debt, mark payments as received, see debt aging, and issue warnings.</snippet>
      </doc>
      <doc>
        <path>docs/ux-mockups/02-admin-dashboard.html</path>
        <title>Admin Mockups</title>
        <section>Section 10: Finanzas (Financial Reports)</section>
        <snippet>Stats cards with icon, label, value. Revenue display: full CLP amounts. Action buttons: Verificar (green), Rechazar (red outline). Aging colors: Green (&lt;7d), Yellow (7-14d), Red (>14d).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/lib/auth/guards.ts</path>
        <kind>auth-guard</kind>
        <symbol>requireAdmin()</symbol>
        <reason>Use this guard in settlement page to ensure only admins can access.</reason>
      </artifact>
      <artifact>
        <path>src/components/admin/admin-sidebar.tsx</path>
        <kind>component</kind>
        <symbol>AdminSidebar</symbol>
        <lines>61-65</lines>
        <reason>Finanzas nav item exists. May update to "Liquidaciones" or add sub-item.</reason>
      </artifact>
      <artifact>
        <path>src/lib/validations/request.ts</path>
        <kind>utility</kind>
        <symbol>formatPrice</symbol>
        <reason>Existing CLP currency formatting function. Use for displaying commission amounts.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package>@radix-ui/react-dialog</package>
        <version>^1.1.15</version>
        <purpose>Receipt viewer modal and verification modal</purpose>
      </node>
      <node>
        <package>@radix-ui/react-alert-dialog</package>
        <version>^1.1.15</version>
        <purpose>Confirmation dialogs for payment actions</purpose>
      </node>
      <node>
        <package>date-fns</package>
        <version>^4.1.0</version>
        <purpose>Date calculations for aging buckets</purpose>
      </node>
      <node>
        <package>sonner</package>
        <version>^2.0.7</version>
        <purpose>Toast notifications for action feedback</purpose>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="auth">Settlement route must use requireAdmin() guard</constraint>
    <constraint type="database">Commission entries in commission_ledger table, never deleted (append-only)</constraint>
    <constraint type="financial">All amounts in CLP integer (no decimals)</constraint>
    <constraint type="currency">Display as $480,000 (not $480k)</constraint>
    <constraint type="aging">Buckets: Current (&lt;7 days), Week (7-14 days), Overdue (>14 days)</constraint>
    <constraint type="ui">Follow admin gray theme per architecture spec</constraint>
    <constraint type="i18n">All user-facing strings in Spanish</constraint>
    <constraint type="audit">All financial transactions require audit trail with timestamp and admin ID</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ProviderSettlement</name>
      <kind>TypeScript interface</kind>
      <signature>
interface ProviderSettlement {
  provider_id: string;
  provider_name: string;
  total_owed: number;
  current_bucket: number;    // &lt; 7 days
  week_bucket: number;       // 7-14 days
  overdue_bucket: number;    // > 14 days
  last_payment_date?: string;
  pending_withdrawal?: WithdrawalRequest;
}
      </signature>
      <path>docs/sprint-artifacts/epic6/tech-spec-epic-6.md</path>
    </interface>
    <interface>
      <name>WithdrawalRequest</name>
      <kind>TypeScript interface</kind>
      <signature>
interface WithdrawalRequest {
  id: string;
  amount: number;
  status: 'pending' | 'processing' | 'completed' | 'rejected';
  receipt_path?: string;
  submitted_at: string;
}
      </signature>
      <path>docs/sprint-artifacts/epic6/tech-spec-epic-6.md</path>
    </interface>
    <interface>
      <name>commission_ledger table</name>
      <kind>Database table</kind>
      <signature>
CREATE TABLE commission_ledger (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  provider_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  request_id UUID REFERENCES water_requests(id),
  type TEXT NOT NULL CHECK (type IN ('commission_owed', 'commission_paid', 'adjustment')),
  amount INTEGER NOT NULL,
  description TEXT,
  bank_reference TEXT,
  admin_id UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
      </signature>
      <path>docs/architecture.md</path>
    </interface>
    <interface>
      <name>withdrawal_requests table</name>
      <kind>Database table</kind>
      <signature>
CREATE TABLE withdrawal_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  provider_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  amount INTEGER NOT NULL,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'rejected')),
  processed_by UUID REFERENCES profiles(id),
  processed_at TIMESTAMPTZ,
  rejection_reason TEXT,
  bank_name TEXT,
  account_number TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
      </signature>
      <path>docs/architecture.md</path>
    </interface>
    <interface>
      <name>verifyPayment()</name>
      <kind>Server action</kind>
      <signature>async function verifyPayment(withdrawalId: string, bankReference?: string): Promise&lt;{ success: boolean }&gt;</signature>
      <path>To be created: src/lib/actions/admin.ts</path>
    </interface>
    <interface>
      <name>rejectPayment()</name>
      <kind>Server action</kind>
      <signature>async function rejectPayment(withdrawalId: string, reason: string): Promise&lt;{ success: boolean }&gt;</signature>
      <path>To be created: src/lib/actions/admin.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      E2E tests using Playwright. Tests located in tests/e2e/ directory.
      Admin tests require authenticated admin session.
      Use data-testid attributes for reliable selectors.
      Seed test data with commission ledger entries and withdrawal requests.
    </standards>
    <locations>
      <location>tests/e2e/admin-settlement.spec.ts (to be created)</location>
      <location>tests/e2e/admin-auth.spec.ts (existing - reference for admin auth pattern)</location>
    </locations>
    <ideas>
      <idea ac="AC6.5.1">Test: Navigate to /admin/settlement, verify summary cards render with correct values</idea>
      <idea ac="AC6.5.2">Test: Verify pending payments table shows correct columns</idea>
      <idea ac="AC6.5.3">Test: Verify provider balances table shows aging information</idea>
      <idea ac="AC6.5.4">Test: Click receipt thumbnail, verify image viewer opens</idea>
      <idea ac="AC6.5.5">Test: Click Verificar, enter bank reference, confirm payment</idea>
      <idea ac="AC6.5.6">Test: After verification, verify new commission_paid ledger entry exists</idea>
      <idea ac="AC6.5.7">Test: Click Rechazar, enter reason, verify rejection recorded</idea>
      <idea ac="AC6.5.8">Test: Verify notification created after payment verification/rejection</idea>
    </ideas>
  </tests>
</story-context>
