# Story 12.7-1: Fix Map Tile Rendering

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-1 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Fix Map Tile Rendering |
| **Status** | done |
| **Priority** | P0 (Critical) |
| **Points** | 3 |
| **Bug Reference** | BUG-001 |

## User Story

**As a** consumer creating a water request on mobile,
**I want** the location pinpoint map to display correctly,
**So that** I can accurately set my delivery location.

## Problem Statement

After completing Step 1 of the water request flow, the location pinpoint screen appears but Leaflet map tiles fail to render. The map area shows blank/white instead of OpenStreetMap tiles. Users cannot see where they're placing the delivery pin.

**Screenshot Evidence:** `docs/testing/manual/bugs/screenshots/bug-001-location-pinpoint.png`

## Technical Context

### Component Location
- `src/components/consumer/location-pinpoint.tsx` - Main map component
- `src/components/consumer/location-pinpoint-wrapper.tsx` - Dynamic import wrapper
- `src/app/(consumer)/request/page.tsx` - Request wizard page

### Current Implementation
- Uses **Leaflet** with **OpenStreetMap** tiles
- Has 10-second timeout for map load detection
- Has error state handling with "Skip" option (AC12.1.4)
- Map loads (`mapLoaded=true`) but tiles don't render

### Root Cause Analysis
The issue had three components requiring iterative fixes:

1. **Timing Issue (Fix 1):** Leaflet's map not calling `invalidateSize()` after the container becomes visible in the wizard step flow. When the map component mounts in a hidden or transitioning container, Leaflet calculates incorrect dimensions.

2. **CSS Flexbox Issue (Fix 2):** The `LocationPinpointWrapper` component was returning the `LocationPinpoint` component directly without proper flex styling. Since the parent uses `flex flex-col`, the wrapper needs `flex-1` to fill available space.

3. **Explicit Height Requirement (Fix 3 - Final):** Even with the flex-1 wrapper, some browsers don't compute explicit heights from flex-based parents. Leaflet requires explicit container dimensions. The final fix:
   - Changed parent container from `min-h-dvh` to `h-dvh` (explicit height vs minimum height)
   - Changed MapContainer from `h-full w-full` to `absolute inset-0` (absolute positioning guarantees explicit dimensions)

**Fixes Applied:**

**Fix 1 - MapResizeHandler (timing):**
- Added `MapResizeHandler` component that calls `map.invalidateSize()` with staggered delays (0ms, 100ms, 300ms, 500ms)
- Handles window resize events for responsive behavior
- Applied to both consumer `location-pinpoint.tsx` and provider `map-client.tsx`

**Fix 2 - CSS Height Chain (wrapper):**
- Added wrapper div with `className="flex-1 flex flex-col"` in `LocationPinpointWrapper`
- This ensures the CSS height chain is complete from parent to MapContainer

**Fix 3 - Explicit Height + Absolute Positioning (final fix):**
- Changed map step container from `min-h-dvh` to `h-dvh` in `request/page.tsx`
- Changed MapContainer from `h-full w-full` to `absolute inset-0` in `location-pinpoint.tsx`
- Critical lesson: Leaflet requires explicit computed dimensions; `h-full` with flex-based parents can fail in some browsers

## Acceptance Criteria

### AC12.7.1.1: Map Tiles Render on Mobile
- [x] OpenStreetMap tiles load and display on Android Chrome PWA
- [x] Map is interactive (can drag, zoom)
- [x] Marker/pin is visible and draggable
- [x] Coordinates update when pin is moved

### AC12.7.1.2: Error Handling
- [x] If tiles fail to load after timeout, show user-friendly error
- [x] "Skip" button remains available as fallback
- [x] Error state doesn't block form submission

### AC12.7.1.3: CSP Configuration
- [x] Verified CSP headers allow `tile.openstreetmap.org` (no CSP blocking - browser handles cross-origin tiles directly)
- [x] Verified Leaflet resources load correctly
- [x] No CSP changes needed in next.config.js

### AC12.7.1.4: E2E Test Coverage
- [x] Add/update E2E test for map rendering (`tests/e2e/consumer-map-pinpoint.spec.ts`)
- [x] Test verifies tile images load from OpenStreetMap
- [x] Test verifies confirm button becomes enabled after map loads

## Implementation Summary

### Files Modified
1. **`src/components/consumer/location-pinpoint.tsx`**
   - Added `MapResizeHandler` component that uses `useMap()` hook
   - Calls `map.invalidateSize()` with staggered delays to fix tile rendering
   - Handles window resize events for responsive behavior

2. **`src/components/consumer/location-pinpoint-wrapper.tsx`** (Root Cause Fix)
   - Added wrapper div with `className="flex-1 flex flex-col"` around `LocationPinpoint`
   - Updated `MapLoadingSkeleton` to match the wrapper structure
   - This ensures CSS height chain is complete for Leaflet's `h-full`

3. **`src/app/provider/map/map-client.tsx`**
   - Added same `MapResizeHandler` component for consistency
   - Ensures provider map also handles resize correctly

4. **`tests/e2e/consumer-map-pinpoint.spec.ts`**
   - Added Story 12.7-1 test suite with 2 tests:
     - AC12.7.1.1: Verifies tile images from OpenStreetMap render
     - AC12.7.1.2: Verifies confirm button is enabled after map loads

### Technical Details
```tsx
// MapResizeHandler - calls invalidateSize after container is rendered
function MapResizeHandler({ onReady }: { onReady: () => void }) {
  const map = useMap();

  useEffect(() => {
    const resizeTimer = setTimeout(() => {
      map.invalidateSize();
      onReady();
    }, 100);

    const handleResize = () => map.invalidateSize();
    window.addEventListener("resize", handleResize);

    return () => {
      clearTimeout(resizeTimer);
      window.removeEventListener("resize", handleResize);
    };
  }, [map, onReady]);

  return null;
}
```

## Definition of Done

- [x] Map tiles render on Android PWA
- [x] Map works on desktop browsers
- [x] E2E tests pass (16/16 tests pass)
- [x] Code review approved
- [x] Deployed to production
- [x] Verified via E2E tests against production

## Test Results

```
16 passed (48.2s) - All tests against production (https://nitoagua.vercel.app)
- Story 12-1: 13 tests passed
- Story 12.7-1: 2 tests passed
- AC12.1.4: 1 test passed
```

## Commits

1. `fix(map): Add MapResizeHandler to fix tile rendering in PWA` - Initial timing fix
2. `fix(map): Use staggered invalidateSize delays for map rendering` - Improved timing
3. `fix(map): Fix CSS height chain for map tile rendering (BUG-001)` - Flex wrapper fix
4. `fix(map): Use explicit height and absolute positioning for map tiles (BUG-001)` - Final fix with h-dvh + absolute inset-0
