# Story 12.7-1: Fix Map Tile Rendering

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-1 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Fix Map Tile Rendering |
| **Status** | review |
| **Priority** | P0 (Critical) |
| **Points** | 3 |
| **Bug Reference** | BUG-001 |

## User Story

**As a** consumer creating a water request on mobile,
**I want** the location pinpoint map to display correctly,
**So that** I can accurately set my delivery location.

## Problem Statement

After completing Step 1 of the water request flow, the location pinpoint screen appears but Leaflet map tiles fail to render. The map area shows blank/white instead of OpenStreetMap tiles. Users cannot see where they're placing the delivery pin.

**Screenshot Evidence:** `docs/testing/manual/bugs/screenshots/bug-001-location-pinpoint.png`

## Technical Context

### Component Location
- `src/components/consumer/location-pinpoint.tsx` - Main map component
- `src/components/consumer/location-pinpoint-wrapper.tsx` - Dynamic import wrapper
- `src/app/(consumer)/request/page.tsx` - Request wizard page

### Current Implementation
- Uses **Leaflet** with **OpenStreetMap** tiles
- Has 10-second timeout for map load detection
- Has error state handling with "Skip" option (AC12.1.4)
- Map loads (`mapLoaded=true`) but tiles don't render

### Root Cause Analysis
The issue was caused by Leaflet's map not calling `invalidateSize()` after the container becomes visible in the wizard step flow. When the map component mounts in a hidden or transitioning container, Leaflet calculates incorrect dimensions, resulting in tiles not rendering properly.

**Fix Applied:**
- Added `MapResizeHandler` component that calls `map.invalidateSize()` after a brief delay (100ms) to ensure the container is fully rendered
- This ensures tiles render correctly in PWA context and wizard step transitions
- Applied to both consumer `location-pinpoint.tsx` and provider `map-client.tsx`

## Acceptance Criteria

### AC12.7.1.1: Map Tiles Render on Mobile
- [x] OpenStreetMap tiles load and display on Android Chrome PWA
- [x] Map is interactive (can drag, zoom)
- [x] Marker/pin is visible and draggable
- [x] Coordinates update when pin is moved

### AC12.7.1.2: Error Handling
- [x] If tiles fail to load after timeout, show user-friendly error
- [x] "Skip" button remains available as fallback
- [x] Error state doesn't block form submission

### AC12.7.1.3: CSP Configuration
- [x] Verified CSP headers allow `tile.openstreetmap.org` (no CSP blocking - browser handles cross-origin tiles directly)
- [x] Verified Leaflet resources load correctly
- [x] No CSP changes needed in next.config.js

### AC12.7.1.4: E2E Test Coverage
- [x] Add/update E2E test for map rendering (`tests/e2e/consumer-map-pinpoint.spec.ts`)
- [x] Test verifies tile images load from OpenStreetMap
- [x] Test verifies confirm button becomes enabled after map loads

## Implementation Summary

### Files Modified
1. **`src/components/consumer/location-pinpoint.tsx`**
   - Added `MapResizeHandler` component that uses `useMap()` hook
   - Calls `map.invalidateSize()` after 100ms delay to fix tile rendering
   - Handles window resize events for responsive behavior

2. **`src/app/provider/map/map-client.tsx`**
   - Added same `MapResizeHandler` component for consistency
   - Ensures provider map also handles resize correctly

3. **`tests/e2e/consumer-map-pinpoint.spec.ts`**
   - Added Story 12.7-1 test suite with 2 tests:
     - AC12.7.1.1: Verifies tile images from OpenStreetMap render
     - AC12.7.1.2: Verifies confirm button is enabled after map loads

### Technical Details
```tsx
// MapResizeHandler - calls invalidateSize after container is rendered
function MapResizeHandler({ onReady }: { onReady: () => void }) {
  const map = useMap();

  useEffect(() => {
    const resizeTimer = setTimeout(() => {
      map.invalidateSize();
      onReady();
    }, 100);

    const handleResize = () => map.invalidateSize();
    window.addEventListener("resize", handleResize);

    return () => {
      clearTimeout(resizeTimer);
      window.removeEventListener("resize", handleResize);
    };
  }, [map, onReady]);

  return null;
}
```

## Definition of Done

- [x] Map tiles render on Android PWA
- [x] Map works on desktop browsers
- [x] E2E tests pass (16/16 tests pass)
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 1.4)

## Test Results

```
16 passed (50.4s)
- Story 12-1: 13 tests passed
- Story 12.7-1: 2 tests passed
- AC12.1.4: 1 test passed
```
