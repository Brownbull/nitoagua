# Story 12.7-8: Offer Cancellation Flow - Story Context

## Technical Analysis

### BUG-021: Error Message on Success

**File:** `src/lib/actions/offers.ts` - `withdrawOffer()` at line 841

**Current Implementation Analysis:**

Looking at the code, the server action looks correct:
```typescript
// Line 876-881: Check status BEFORE update
if (offer.status !== "active") {
  return {
    success: false,
    error: "Solo puedes cancelar ofertas pendientes",
  };
}

// Line 884-887: Then update
const { error: updateError } = await supabase
  .from("offers")
  .update({ status: "cancelled" })
  .eq("id", offerId);
```

**Possible Root Causes:**
1. **UI showing wrong message** - Frontend may be showing error from wrong source
2. **Race condition** - Two cancel requests, second one fails
3. **Stale data** - UI has old offer data, server has new

### BUG-022: Stale UI on Consumer Side

**Missing:** Realtime subscription for offer status changes on consumer offer list

**Files Affected:**
- Consumer offer list component (need to identify)
- May need hook similar to `use-realtime-offers.ts`

### Investigation Needed

1. Find consumer offer list component
2. Check if realtime subscription exists
3. Check frontend error handling in cancel button

### Files to Modify

| File | Change |
|------|--------|
| Consumer offer list component | Add realtime subscription |
| Provider cancel UI component | Fix error handling display |

### Fix Pattern for BUG-022

```typescript
// Add to consumer offer list
useEffect(() => {
  const channel = supabase
    .channel('consumer-offers')
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'offers',
      filter: `request_id=eq.${requestId}`
    }, (payload) => {
      if (payload.new.status === 'cancelled') {
        // Remove from list
        setOffers(prev => prev.filter(o => o.id !== payload.new.id));
      }
    })
    .subscribe();

  return () => channel.unsubscribe();
}, [requestId]);
```

### Acceptance Criteria Mapping

| AC | Bug | Implementation |
|----|-----|----------------|
| AC12.7.8.1 | BUG-021 | Success message on cancel |
| AC12.7.8.2 | BUG-021 | Error only for actual failures |
| AC12.7.8.3 | BUG-022 | Consumer realtime subscription |
| AC12.7.8.4 | BUG-022 | Cancelled offers disappear |
