# Story 12.7-11: "En Camino" Delivery Status - Story Context

## Technical Analysis

### Current State

**Status:** Partially implemented

The "en_transit" status exists in the system:
- Status value defined
- Push trigger exists: `triggerInTransitPush()` at `trigger-push.ts:185`
- Status badge likely supports it

**Missing:** UI action to set "En Camino" status

### Current Status Flow

```
pending â†’ offers_pending â†’ accepted â†’ delivered
                                  â†“
                              cancelled
```

### Required Status Flow

```
pending â†’ offers_pending â†’ accepted â†’ EN_TRANSIT â†’ delivered
                                  â†“
                              cancelled
```

### Implementation

#### 1. Add "En Camino" Button

In `src/app/provider/deliveries/[id]/page.tsx`:

```tsx
{status === 'accepted' && (
  <Button onClick={handleStartDelivery}>
    ðŸšš Iniciar Entrega
  </Button>
)}

{status === 'en_transit' && (
  <Button onClick={handleMarkDelivered}>
    âœ… Marcar Entregado
  </Button>
)}
```

#### 2. Server Action

In `src/lib/actions/delivery.ts`:

```typescript
export async function startDelivery(requestId: string) {
  // Update status to 'en_transit'
  // Set en_transit_at timestamp
  // Trigger in-transit push to consumer
}
```

#### 3. Consumer View

Show "En Camino" status with:
- Provider name
- Estimated arrival (if available)
- Live tracking (future enhancement)

### Files to Modify

| File | Changes |
|------|---------|
| `src/lib/actions/delivery.ts` | Add startDelivery action |
| `src/app/provider/deliveries/[id]/page.tsx` | Add "Iniciar Entrega" button |
| `src/app/(consumer)/request/[id]/page.tsx` | Show en_transit status |
| `src/components/shared/status-badge.tsx` | Ensure en_transit supported |

### Database

May need to add `en_transit_at` timestamp to `water_requests`:

```sql
ALTER TABLE water_requests
ADD COLUMN IF NOT EXISTS en_transit_at TIMESTAMPTZ;
```

### Acceptance Criteria Mapping

| AC | Implementation |
|----|----------------|
| AC12.7.11.1 | "Iniciar Entrega" button on accepted deliveries |
| AC12.7.11.2 | Status updates to en_transit |
| AC12.7.11.3 | Consumer sees "En Camino" status |
| AC12.7.11.4 | Push notification sent to consumer |
