# Story 12.7-13: Rating/Review System

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-13 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Rating/Review System |
| **Status** | done |
| **Priority** | P2 (Medium) |
| **Points** | 8 |
| **Bug Reference** | BUG-014 |

## User Story

**As a** consumer who completed a delivery,
**I want** to rate and review my provider,
**So that** good providers are recognized and others can make informed choices.

**As a** provider,
**I want** to see my ratings and reviews,
**So that** I can understand my performance and build reputation.

## Problem Statement

After a delivery is marked as completed, there is no option for the consumer to rate or review the provider. This means:
- Bad providers can't be identified
- Good providers can't build reputation
- Consumers can't express satisfaction/dissatisfaction
- No data on service quality

## Technical Context

### New Components Needed
- Rating prompt after delivery complete
- `ratings` database table
- Provider profile rating display
- Admin rating analytics (optional)

### Integration Points
- Consumer delivery status page
- Provider profile page
- Push notification to prompt rating
- Admin dashboard (aggregate metrics)

## Acceptance Criteria

### AC12.7.13.1: Rating Prompt
- [x] Rating prompt appears after delivery marked complete
- [x] Can also access from delivery history
- [x] Prompt includes: Star rating (1-5), optional comment
- [x] "Skip" option available (not required)

### AC12.7.13.2: Star Rating
- [x] 5-star rating system
- [x] Tap stars to set rating
- [x] Visual feedback on selection
- [x] Rating required to submit (comment optional)

### AC12.7.13.3: Review Comment
- [x] Optional text field for review
- [x] Max 500 characters
- [x] Preview before submitting
- [x] Can be added later if skipped initially

### AC12.7.13.4: Provider Rating Display
- [x] Provider profile shows average rating
- [x] Show total review count
- [x] Example: "‚≠ê 4.8 (23 reviews)"
- [x] Visible to consumers when viewing offers

### AC12.7.13.5: Rating Storage
- [x] Ratings saved to database
- [x] Linked to delivery/request
- [x] One rating per delivery (can update)
- [x] Timestamps for analytics

### AC12.7.13.6: Rating Notification
- [ ] Push notification 1 hour after delivery: "¬øC√≥mo fue tu experiencia?" *(Deferred to future story)*
- [ ] Reminder notification after 24 hours (if not rated) *(Deferred to future story)*
- [ ] Max 2 reminders *(Deferred to future story)*

## Database Schema

```sql
CREATE TABLE ratings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID REFERENCES water_requests(id) ON DELETE CASCADE,
  consumer_id UUID REFERENCES profiles(id),
  provider_id UUID REFERENCES profiles(id),
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(request_id, consumer_id)  -- One rating per delivery per consumer
);

-- Indexes
CREATE INDEX idx_ratings_provider_id ON ratings(provider_id);
CREATE INDEX idx_ratings_consumer_id ON ratings(consumer_id);

-- RLS
ALTER TABLE ratings ENABLE ROW LEVEL SECURITY;

-- Consumers can create/update their own ratings
CREATE POLICY "Consumers manage own ratings"
  ON ratings FOR ALL
  TO authenticated
  USING (consumer_id = auth.uid())
  WITH CHECK (consumer_id = auth.uid());

-- Everyone can view ratings (public)
CREATE POLICY "Ratings are public"
  ON ratings FOR SELECT
  TO authenticated
  USING (true);

-- Add average rating to profiles (materialized or computed)
ALTER TABLE profiles
  ADD COLUMN IF NOT EXISTS average_rating DECIMAL(2,1) DEFAULT 0,
  ADD COLUMN IF NOT EXISTS rating_count INTEGER DEFAULT 0;

-- Function to update provider average
CREATE OR REPLACE FUNCTION update_provider_rating()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE profiles
  SET
    average_rating = (
      SELECT AVG(rating)::DECIMAL(2,1)
      FROM ratings
      WHERE provider_id = NEW.provider_id
    ),
    rating_count = (
      SELECT COUNT(*)
      FROM ratings
      WHERE provider_id = NEW.provider_id
    )
  WHERE id = NEW.provider_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_rating_on_insert
  AFTER INSERT OR UPDATE ON ratings
  FOR EACH ROW
  EXECUTE FUNCTION update_provider_rating();
```

## UI Design

### Rating Prompt (After Delivery)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ ENTREGA COMPLETADA                  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ¬øC√≥mo fue tu experiencia?              ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê                               ‚îÇ
‚îÇ  (toca para calificar)                  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  üìù Comentario (opcional)               ‚îÇ
‚îÇ  [ __________________________________ ] ‚îÇ
‚îÇ  [ __________________________________ ] ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  [ Omitir ]    [ Enviar Calificaci√≥n ]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Rating Selected

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ ENTREGA COMPLETADA                  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ¬øC√≥mo fue tu experiencia?              ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ  4/5                          ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  üìù Comentario (opcional)               ‚îÇ
‚îÇ  [ Muy bueno, lleg√≥ a tiempo!         ] ‚îÇ
‚îÇ  [ __________________________________ ] ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  [ Omitir ]    [ Enviar Calificaci√≥n ]  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Provider Profile Rating Display

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Juan Provider                          ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  ‚≠ê 4.8 (23 reviews)                    ‚îÇ
‚îÇ  ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚ñë‚ñë‚ñë‚ñë‚ñë             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  üöö 152 entregas completadas            ‚îÇ
‚îÇ  üìç Villarrica, Puc√≥n                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Implementation Notes

### Rating Component

```tsx
function RatingStars({
  value,
  onChange,
  size = 'lg'
}: {
  value: number;
  onChange: (rating: number) => void;
  size?: 'sm' | 'md' | 'lg';
}) {
  return (
    <div className="flex gap-1">
      {[1, 2, 3, 4, 5].map((star) => (
        <button
          key={star}
          onClick={() => onChange(star)}
          className={cn(
            "transition-colors",
            star <= value ? "text-yellow-400" : "text-gray-300"
          )}
        >
          <Star
            className={cn(
              size === 'lg' && 'w-10 h-10',
              size === 'md' && 'w-6 h-6',
              size === 'sm' && 'w-4 h-4',
              star <= value && 'fill-current'
            )}
          />
        </button>
      ))}
    </div>
  );
}
```

### Average Rating Display

```tsx
function ProviderRating({ providerId }: { providerId: string }) {
  const { data: provider } = useProvider(providerId);

  if (!provider?.rating_count) {
    return <span className="text-gray-500 text-sm">Sin calificaciones</span>;
  }

  return (
    <div className="flex items-center gap-1">
      <Star className="w-4 h-4 text-yellow-400 fill-current" />
      <span className="font-medium">{provider.average_rating}</span>
      <span className="text-gray-500 text-sm">
        ({provider.rating_count} {provider.rating_count === 1 ? 'review' : 'reviews'})
      </span>
    </div>
  );
}
```

## Tasks/Subtasks

### Task 1: Database Migration - Create ratings table and update profiles ‚úÖ
- [x] Create migration file with ratings table schema
- [x] Add average_rating and rating_count columns to profiles
- [x] Create trigger function to update provider averages
- [x] Add RLS policies for ratings table
- [x] Run migration locally and verify

### Task 2: Server Actions - Create ratings actions ‚úÖ
- [x] Create `src/lib/actions/ratings.ts` with submitRating action
- [x] Add updateRating action for modifying existing ratings
- [x] Add getProviderRating query function
- [x] Add getRatingByRequest to check if rating exists
- [x] Follow requireUser pattern for auth

### Task 3: Rating Stars Component - Reusable star input/display ‚úÖ
- [x] Create `src/components/shared/rating-stars.tsx`
- [x] Support readonly mode for display
- [x] Support interactive mode for input
- [x] Add visual feedback on hover/selection
- [x] Include proper accessibility attributes

### Task 4: Rating Dialog - Consumer rating form ‚úÖ
- [x] Create `src/components/consumer/rating-dialog.tsx`
- [x] Star rating input (required)
- [x] Optional comment field (max 500 chars)
- [x] Character counter display
- [x] Skip and Submit buttons
- [x] Loading and success states

### Task 5: Integration - Rating prompt after delivery ‚úÖ
- [x] Add RatingDialog to request-status-client.tsx
- [x] Show prompt when status is 'delivered'
- [x] Check if rating already exists
- [x] Handle submit and skip actions
- [x] Add success toast notification

### Task 6: Provider Rating Display - Show on offer cards ‚úÖ
- [x] Create ProviderRating component
- [x] Add to consumer offer-card.tsx
- [x] Show "‚≠ê X.X (N reviews)" format
- [x] Handle zero ratings case gracefully
- [x] Update profiles select query to include rating

### Task 7: E2E Tests - Rating flow tests ‚úÖ
- [x] Create `tests/e2e/rating-review.spec.ts`
- [x] Test rating prompt appears after delivery
- [x] Test star selection and submission
- [x] Test skip functionality
- [x] Test rating display on offer cards
- [x] Test updating existing rating

## Dev Notes

### Architecture Requirements (from Atlas)
- Follow Server Actions pattern with `'use server'` + requireUser guards
- Use `ApiResponse<T>` type convention for action results
- RLS policies must use `(select auth.uid())` for performance
- Spanish UI strings, English code comments

### Testing Patterns (from Atlas)
- Use merged-fixtures import for E2E tests
- Call `assertNoErrorState(page)` after every navigation
- Use element-based waits, never `waitForTimeout`
- Serial mode for data-mutating tests

### Implementation Notes
- Rating notifications (AC12.7.13.6) deferred to future story - focus on core rating first
- One rating per delivery per consumer (UNIQUE constraint)
- Provider average updated via trigger (not application code)

## Dev Agent Record

### Implementation Plan
1. Database migration via Supabase MCP - ratings table, profile columns, trigger, RLS
2. Server actions following ActionResult<T> pattern
3. Reusable RatingStars component with interactive/readonly modes
4. RatingDialog component with shadcn/ui Dialog
5. Integration into request-status-client.tsx with auto-prompt
6. Provider rating display in offer cards via hook extension
7. E2E tests with merged-fixtures pattern

### Debug Log
- Fixed Tailwind warning: `flex-shrink-0` ‚Üí `shrink-0`
- Fixed TypeScript: `undefined` not assignable - used `?? null` coercion
- Fixed TypeScript: `isUpdate` boolean type with `!!` coercion
- Fixed Rating interface nullable fields to match DB schema

### Completion Notes
- All 7 tasks completed successfully
- AC12.7.13.1-5 fully implemented
- AC12.7.13.6 (push notifications) deferred to future story per dev notes
- Rating prompt auto-shows once per session after delivery
- Edit rating functionality available via edit button
- Provider average updated via database trigger
- E2E tests created with 5 test cases covering full flow

## File List
### New Files Created
- `src/lib/actions/ratings.ts` - Server actions for rating CRUD
- `src/components/shared/rating-stars.tsx` - Reusable star rating component
- `src/components/consumer/rating-dialog.tsx` - Rating submission dialog
- `tests/e2e/rating-review.spec.ts` - E2E test suite

### Files Modified
- `src/components/consumer/request-status-client.tsx` - Integrated rating prompt
- `src/components/consumer/offer-card.tsx` - Added provider rating display
- `src/hooks/use-consumer-offers.ts` - Extended query with rating fields
- `src/types/database.ts` - Added ratings table and profile rating columns

### Database Migration Applied
- `create_ratings_table` - Ratings table, profile columns, trigger, RLS policies

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-03 | Story drafted with schema and UI design | SM |
| 2026-01-03 | Added Tasks/Subtasks for implementation | Dev Agent |
| 2026-01-03 | Implementation completed - all 7 tasks done | Dev Agent |
| 2026-01-04 | Atlas code review passed - Spanish accents fixed, Tailwind class canonicalized | Code Review |

## Definition of Done

- [x] Rating prompt appears after delivery
- [x] Star rating works
- [x] Optional comment can be added
- [x] Skip option available
- [x] Provider profile shows average rating
- [x] Rating visible on offer cards
- [x] E2E tests pass
- [x] Code review approved
