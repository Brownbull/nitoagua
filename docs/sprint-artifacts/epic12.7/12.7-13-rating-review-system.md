# Story 12.7-13: Rating/Review System

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-13 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Rating/Review System |
| **Status** | drafted |
| **Priority** | P2 (Medium) |
| **Points** | 8 |
| **Bug Reference** | BUG-014 |

## User Story

**As a** consumer who completed a delivery,
**I want** to rate and review my provider,
**So that** good providers are recognized and others can make informed choices.

**As a** provider,
**I want** to see my ratings and reviews,
**So that** I can understand my performance and build reputation.

## Problem Statement

After a delivery is marked as completed, there is no option for the consumer to rate or review the provider. This means:
- Bad providers can't be identified
- Good providers can't build reputation
- Consumers can't express satisfaction/dissatisfaction
- No data on service quality

## Technical Context

### New Components Needed
- Rating prompt after delivery complete
- `ratings` database table
- Provider profile rating display
- Admin rating analytics (optional)

### Integration Points
- Consumer delivery status page
- Provider profile page
- Push notification to prompt rating
- Admin dashboard (aggregate metrics)

## Acceptance Criteria

### AC12.7.13.1: Rating Prompt
- [ ] Rating prompt appears after delivery marked complete
- [ ] Can also access from delivery history
- [ ] Prompt includes: Star rating (1-5), optional comment
- [ ] "Skip" option available (not required)

### AC12.7.13.2: Star Rating
- [ ] 5-star rating system
- [ ] Tap stars to set rating
- [ ] Visual feedback on selection
- [ ] Rating required to submit (comment optional)

### AC12.7.13.3: Review Comment
- [ ] Optional text field for review
- [ ] Max 500 characters
- [ ] Preview before submitting
- [ ] Can be added later if skipped initially

### AC12.7.13.4: Provider Rating Display
- [ ] Provider profile shows average rating
- [ ] Show total review count
- [ ] Example: "â­ 4.8 (23 reviews)"
- [ ] Visible to consumers when viewing offers

### AC12.7.13.5: Rating Storage
- [ ] Ratings saved to database
- [ ] Linked to delivery/request
- [ ] One rating per delivery (can update)
- [ ] Timestamps for analytics

### AC12.7.13.6: Rating Notification
- [ ] Push notification 1 hour after delivery: "Â¿CÃ³mo fue tu experiencia?"
- [ ] Reminder notification after 24 hours (if not rated)
- [ ] Max 2 reminders

## Database Schema

```sql
CREATE TABLE ratings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID REFERENCES water_requests(id) ON DELETE CASCADE,
  consumer_id UUID REFERENCES profiles(id),
  provider_id UUID REFERENCES profiles(id),
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(request_id, consumer_id)  -- One rating per delivery per consumer
);

-- Indexes
CREATE INDEX idx_ratings_provider_id ON ratings(provider_id);
CREATE INDEX idx_ratings_consumer_id ON ratings(consumer_id);

-- RLS
ALTER TABLE ratings ENABLE ROW LEVEL SECURITY;

-- Consumers can create/update their own ratings
CREATE POLICY "Consumers manage own ratings"
  ON ratings FOR ALL
  TO authenticated
  USING (consumer_id = auth.uid())
  WITH CHECK (consumer_id = auth.uid());

-- Everyone can view ratings (public)
CREATE POLICY "Ratings are public"
  ON ratings FOR SELECT
  TO authenticated
  USING (true);

-- Add average rating to profiles (materialized or computed)
ALTER TABLE profiles
  ADD COLUMN IF NOT EXISTS average_rating DECIMAL(2,1) DEFAULT 0,
  ADD COLUMN IF NOT EXISTS rating_count INTEGER DEFAULT 0;

-- Function to update provider average
CREATE OR REPLACE FUNCTION update_provider_rating()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE profiles
  SET
    average_rating = (
      SELECT AVG(rating)::DECIMAL(2,1)
      FROM ratings
      WHERE provider_id = NEW.provider_id
    ),
    rating_count = (
      SELECT COUNT(*)
      FROM ratings
      WHERE provider_id = NEW.provider_id
    )
  WHERE id = NEW.provider_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_rating_on_insert
  AFTER INSERT OR UPDATE ON ratings
  FOR EACH ROW
  EXECUTE FUNCTION update_provider_rating();
```

## UI Design

### Rating Prompt (After Delivery)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ENTREGA COMPLETADA                  â”‚
â”‚                                         â”‚
â”‚  Â¿CÃ³mo fue tu experiencia?              â”‚
â”‚                                         â”‚
â”‚  â­â­â­â­â­                               â”‚
â”‚  (toca para calificar)                  â”‚
â”‚                                         â”‚
â”‚  ðŸ“ Comentario (opcional)               â”‚
â”‚  [ __________________________________ ] â”‚
â”‚  [ __________________________________ ] â”‚
â”‚                                         â”‚
â”‚  [ Omitir ]    [ Enviar CalificaciÃ³n ]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rating Selected

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ENTREGA COMPLETADA                  â”‚
â”‚                                         â”‚
â”‚  Â¿CÃ³mo fue tu experiencia?              â”‚
â”‚                                         â”‚
â”‚  â­â­â­â­â˜†  4/5                          â”‚
â”‚                                         â”‚
â”‚  ðŸ“ Comentario (opcional)               â”‚
â”‚  [ Muy bueno, llegÃ³ a tiempo!         ] â”‚
â”‚  [ __________________________________ ] â”‚
â”‚                                         â”‚
â”‚  [ Omitir ]    [ Enviar CalificaciÃ³n ]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Provider Profile Rating Display

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Juan Provider                          â”‚
â”‚                                         â”‚
â”‚  â­ 4.8 (23 reviews)                    â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â–‘â–‘â–‘â–‘â–‘             â”‚
â”‚                                         â”‚
â”‚  ðŸšš 152 entregas completadas            â”‚
â”‚  ðŸ“ Villarrica, PucÃ³n                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Notes

### Rating Component

```tsx
function RatingStars({
  value,
  onChange,
  size = 'lg'
}: {
  value: number;
  onChange: (rating: number) => void;
  size?: 'sm' | 'md' | 'lg';
}) {
  return (
    <div className="flex gap-1">
      {[1, 2, 3, 4, 5].map((star) => (
        <button
          key={star}
          onClick={() => onChange(star)}
          className={cn(
            "transition-colors",
            star <= value ? "text-yellow-400" : "text-gray-300"
          )}
        >
          <Star
            className={cn(
              size === 'lg' && 'w-10 h-10',
              size === 'md' && 'w-6 h-6',
              size === 'sm' && 'w-4 h-4',
              star <= value && 'fill-current'
            )}
          />
        </button>
      ))}
    </div>
  );
}
```

### Average Rating Display

```tsx
function ProviderRating({ providerId }: { providerId: string }) {
  const { data: provider } = useProvider(providerId);

  if (!provider?.rating_count) {
    return <span className="text-gray-500 text-sm">Sin calificaciones</span>;
  }

  return (
    <div className="flex items-center gap-1">
      <Star className="w-4 h-4 text-yellow-400 fill-current" />
      <span className="font-medium">{provider.average_rating}</span>
      <span className="text-gray-500 text-sm">
        ({provider.rating_count} {provider.rating_count === 1 ? 'review' : 'reviews'})
      </span>
    </div>
  );
}
```

## Definition of Done

- [ ] Rating prompt appears after delivery
- [ ] Star rating works
- [ ] Optional comment can be added
- [ ] Skip option available
- [ ] Provider profile shows average rating
- [ ] Rating visible on offer cards
- [ ] Rating notification sent
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 5.3-5.5)
