# Story 12.7-2: Push Notification Triggers

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-2 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Push Notification Triggers |
| **Status** | drafted |
| **Priority** | P0 (Critical) |
| **Points** | 5 |
| **Bug References** | BUG-005, BUG-008, BUG-013 |

## User Story

**As a** consumer or provider,
**I want** to receive push notifications for critical transaction events,
**So that** I'm immediately informed when offers are made, accepted, or deliveries completed.

## Problem Statement

Push notifications are NOT being sent for critical transaction events:
- **BUG-005:** Consumer doesn't receive push when provider submits offer
- **BUG-008:** Provider doesn't receive push when consumer accepts offer
- **BUG-013:** Consumer doesn't receive push when delivery is completed

**KEY INSIGHT:** Test 5 confirmed push notification infrastructure WORKS when manually triggered via "Probar" button. The issue is that **triggers are missing** - the code that should send notifications on transaction events is not executing.

## Technical Context

### Working Components (Confirmed in Test 5)
- VAPID keys configured correctly
- `push_subscriptions` table working
- Service worker push handler working
- `send-push-notification` Edge Function working
- Manual test push works end-to-end

### Missing Triggers
The following transaction events should trigger push notifications but don't:

| Event | Who Receives | Current Status |
|-------|--------------|----------------|
| Provider submits offer | Consumer | NOT TRIGGERED |
| Consumer accepts offer | Provider | NOT TRIGGERED |
| Provider completes delivery | Consumer | NOT TRIGGERED |

### Related Files
- `src/lib/actions/offers.ts` - Offer submission/acceptance
- `src/lib/actions/requests.ts` - Delivery completion
- `supabase/functions/send-push-notification/` - Push sender
- Database triggers (if any exist)

## Acceptance Criteria

### AC12.7.2.1: Offer Submission Notification (BUG-005)
- [ ] When provider submits offer, trigger push to consumer
- [ ] Notification title: "Nueva oferta recibida" (or similar)
- [ ] Notification body includes: provider name, price, delivery time
- [ ] Clicking notification opens offer selection page

### AC12.7.2.2: Offer Acceptance Notification (BUG-008)
- [ ] When consumer accepts offer, trigger push to provider
- [ ] Notification title: "¡Tu oferta fue aceptada!"
- [ ] Notification body includes: delivery address, customer name
- [ ] Clicking notification opens delivery details page

### AC12.7.2.3: Delivery Complete Notification (BUG-013)
- [ ] When provider marks delivered, trigger push to consumer
- [ ] Notification title: "¡Tu agua ha llegado!"
- [ ] Notification body includes: delivery confirmation
- [ ] Clicking notification opens delivery details/rating page

### AC12.7.2.4: Trigger Implementation
- [ ] Identify where to add trigger calls (server action vs DB trigger)
- [ ] Add `sendPushNotification()` calls at appropriate points
- [ ] Handle cases where user has no push subscription (graceful skip)
- [ ] Log notification sends for debugging

### AC12.7.2.5: E2E Test Coverage
- [ ] Test offer submission triggers consumer notification
- [ ] Test offer acceptance triggers provider notification
- [ ] Test delivery completion triggers consumer notification

## Implementation Approach

### Option A: Server Action Triggers (Recommended)
Add push notification calls directly in server actions:

```typescript
// In offers.ts - after successful offer creation
export async function submitOffer(data: OfferData) {
  // ... create offer logic ...

  // Trigger push to consumer
  await sendPushToUser(request.user_id, {
    title: 'Nueva oferta recibida',
    body: `${provider.name} te ha enviado una oferta por $${offer.price}`,
    url: `/request/${request.id}/offers`
  });

  return { success: true };
}
```

### Option B: Database Triggers
Create Supabase database triggers that call the Edge Function.

**Pros:** Guaranteed to fire on any status change
**Cons:** More complex, harder to debug

### Recommended: Option A
Server actions are easier to debug and maintain. Add try/catch to prevent notification failures from blocking the main action.

## Investigation Checklist

- [ ] Check if `sendPushNotification` is called anywhere for these events
- [ ] Check Supabase Edge Function logs for any calls during transactions
- [ ] Verify user has valid push subscription before testing
- [ ] Check if there are database triggers that should be firing

## Definition of Done

- [ ] All 3 notification types trigger correctly
- [ ] Notifications received on Android PWA
- [ ] Notification click opens correct page
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 2.3, 2.5, 2.7)
