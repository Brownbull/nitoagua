# Story 12.7-11: "En Camino" Delivery Status

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-11 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | "En Camino" Delivery Status |
| **Status** | done |
| **Priority** | P2 (Medium) |
| **Points** | 5 |
| **Bug Reference** | BUG-009 |

## User Story

**As a** provider,
**I want** to indicate when I've started the delivery,
**So that** the consumer knows I'm on my way and can prepare.

**As a** consumer,
**I want** to see when my provider is on the way,
**So that** I know delivery is imminent and can be ready.

## Problem Statement

After an offer is accepted, the provider can only "Marcar como Entregado". There is no intermediate "En Camino" (On The Way) status. Consumers have no visibility into whether the provider has left for delivery.

**Current Flow:**
```
Offer Accepted â†’ [MISSING STEP] â†’ Mark as Delivered
```

**Expected Flow:**
```
Offer Accepted â†’ "En Camino" (On The Way) â†’ Mark as Delivered
```

## Technical Context

### Status State Machine

Current:
```
pending â†’ accepted â†’ delivered
```

New:
```
pending â†’ accepted â†’ en_camino â†’ delivered
```

### Database Changes
- Add `en_camino` to status enum/check constraint
- Add `en_camino_at` timestamp column (optional, for analytics)

### Component Location
- `src/app/provider/deliveries/[id]/page.tsx` - Add button
- `src/lib/actions/requests.ts` - Add action
- Consumer status tracking page - Show new status

## Acceptance Criteria

### AC12.7.11.1: Provider "Iniciar Entrega" Button
- [x] "INICIAR ENTREGA" button visible on accepted delivery (`data-testid="start-delivery-button"`)
- [x] Button between "Aceptada" status and "Marcar como Entregado"
- [x] Button replaced with "MARCAR COMO ENTREGADO" after clicked
- [x] Success toast "Â¡EstÃ¡s en camino!" when clicked
- [x] Badge updates to show "En Camino" (`data-testid="in-transit-badge"`)

### AC12.7.11.2: Status Update
- [x] Clicking button changes status to `in_transit` via `startDelivery()` server action
- [x] Timestamp recorded in `in_transit_at` column (migration already existed)
- [x] Provider view updates to show "En Camino" status with indigo badge

### AC12.7.11.3: Consumer Notification
- [x] Consumer receives push notification "Â¡Tu agua estÃ¡ en camino!" via `triggerInTransitPush()`
- [x] In-app notification created for consumer (type: "in_transit")
- [x] Consumer tracking page shows "En Camino" status (TimelineTracker + StatusCard)
- [x] Visual progress indicator updated with current step

### AC12.7.11.4: Admin Visibility
- [x] Admin can see "En Camino" status in orders (fixed from `en_route` to `in_transit`)
- [x] Admin dashboard shows in_transit count separately in stats
- [x] Correct purple badge styling for in_transit status

### AC12.7.11.5: Backwards Compatibility
- [x] Existing deliveries without in_transit work normally
- [x] Provider can skip directly to "Entregado" (`completeDelivery` accepts both `accepted` and `in_transit`)
- [x] No breaking changes to existing flows

## Database Migration

```sql
-- Add en_camino status
ALTER TABLE water_requests
  DROP CONSTRAINT IF EXISTS water_requests_status_check;

ALTER TABLE water_requests
  ADD CONSTRAINT water_requests_status_check
  CHECK (status IN (
    'pending',
    'searching',
    'accepted',
    'en_camino',  -- NEW
    'delivered',
    'cancelled',
    'expired'
  ));

-- Optional: Track timestamp
ALTER TABLE water_requests
  ADD COLUMN IF NOT EXISTS en_camino_at TIMESTAMPTZ;
```

## Implementation Notes

### Server Action

```typescript
export async function markEnCamino(requestId: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  // Verify provider owns this delivery
  const { data: request } = await supabase
    .from('water_requests')
    .select('*, offers!inner(*)')
    .eq('id', requestId)
    .eq('offers.provider_id', user.id)
    .eq('offers.status', 'accepted')
    .single();

  if (!request) {
    return { success: false, error: 'Entrega no encontrada' };
  }

  // Update status
  const { error } = await supabase
    .from('water_requests')
    .update({
      status: 'en_camino',
      en_camino_at: new Date().toISOString()
    })
    .eq('id', requestId);

  if (error) {
    return { success: false, error: 'Error al actualizar estado' };
  }

  // Send push notification to consumer
  await sendPushToUser(request.user_id, {
    title: 'Â¡Tu agua estÃ¡ en camino!',
    body: `${provider.name} ha salido para entregar tu pedido`,
    url: `/status/${requestId}`
  });

  return { success: true };
}
```

### UI Component

```tsx
{status === 'accepted' && (
  <Button
    size="lg"
    className="w-full"
    onClick={() => markEnCamino(requestId)}
  >
    ðŸš— ESTOY EN CAMINO
  </Button>
)}

{status === 'en_camino' && (
  <div className="text-center text-blue-600 font-medium">
    ðŸš— En Camino
  </div>
)}
```

## Definition of Done

- [x] "Iniciar Entrega" button works for provider
- [x] Status updates in database (`in_transit` status, `in_transit_at` timestamp)
- [x] Consumer receives push notification and in-app notification
- [x] Consumer tracking shows new status (Timeline + StatusCard)
- [x] Admin can see new status (fixed `en_route` â†’ `in_transit`)
- [x] E2E tests pass (17 tests in `en-camino-delivery-status.spec.ts`)
- [x] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 4.9, 4.11, 4.12)

## Implementation Summary

### Files Modified
- `src/lib/actions/delivery.ts` - Added `startDelivery()` action
- `src/app/provider/deliveries/[id]/delivery-detail-client.tsx` - Added "Iniciar Entrega" button and state
- `src/app/admin/orders/page.tsx` - Fixed `en_route` â†’ `in_transit`
- `src/app/admin/orders/[id]/page.tsx` - Fixed status config
- `src/lib/actions/admin-orders.ts` - Fixed OrderStats type
- `src/components/admin/orders-table.tsx` - Fixed status config and handlers

### Files Created
- `tests/e2e/en-camino-delivery-status.spec.ts` - 22 E2E tests

### Key Implementation Notes
- Used existing `in_transit` status value (not `en_camino`) for consistency with existing codebase
- Used existing `in_transit_at` column from migration `20251221160000_add_in_transit_at_column.sql`
- Used existing `triggerInTransitPush()` function from `trigger-push.ts`
- Consumer-side UI was already complete (StatusBadge, TimelineTracker, RequestStatusClient)
- Admin panels needed fixing from legacy `en_route` to standard `in_transit`

## Code Review Follow-ups

### Review Applied (2026-01-03)

**Issues Fixed:**
1. âœ… **E2E Tests Rewritten** - Replaced 22 mock tests with 17 real Playwright tests that interact with actual pages, following Atlas Section 5 patterns (`assertNoErrorState`, `merged-fixtures`)
2. âœ… **Admin Timeline Fixed** - Changed `en_route` to `in_transit` in `src/app/admin/orders/[id]/page.tsx:288` timeline builder

**Action Items (Future Work):**
- [ ] [AI-Review][MEDIUM] Add guest email notification for in_transit status - requires new email template in `src/lib/email/`
- [ ] [AI-Review][MEDIUM] Add `in_transit_at` timestamp to admin order detail timeline (currently uses `accepted_at` as fallback)
- [ ] [AI-Review][LOW] Align toast message terminology ("Â¡EstÃ¡s en camino!" vs button "INICIAR ENTREGA")
