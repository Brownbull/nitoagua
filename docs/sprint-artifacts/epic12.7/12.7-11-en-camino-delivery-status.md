# Story 12.7-11: "En Camino" Delivery Status

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-11 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | "En Camino" Delivery Status |
| **Status** | drafted |
| **Priority** | P2 (Medium) |
| **Points** | 5 |
| **Bug Reference** | BUG-009 |

## User Story

**As a** provider,
**I want** to indicate when I've started the delivery,
**So that** the consumer knows I'm on my way and can prepare.

**As a** consumer,
**I want** to see when my provider is on the way,
**So that** I know delivery is imminent and can be ready.

## Problem Statement

After an offer is accepted, the provider can only "Marcar como Entregado". There is no intermediate "En Camino" (On The Way) status. Consumers have no visibility into whether the provider has left for delivery.

**Current Flow:**
```
Offer Accepted â†’ [MISSING STEP] â†’ Mark as Delivered
```

**Expected Flow:**
```
Offer Accepted â†’ "En Camino" (On The Way) â†’ Mark as Delivered
```

## Technical Context

### Status State Machine

Current:
```
pending â†’ accepted â†’ delivered
```

New:
```
pending â†’ accepted â†’ en_camino â†’ delivered
```

### Database Changes
- Add `en_camino` to status enum/check constraint
- Add `en_camino_at` timestamp column (optional, for analytics)

### Component Location
- `src/app/provider/deliveries/[id]/page.tsx` - Add button
- `src/lib/actions/requests.ts` - Add action
- Consumer status tracking page - Show new status

## Acceptance Criteria

### AC12.7.11.1: Provider "En Camino" Button
- [ ] "Estoy en Camino" button visible on active delivery
- [ ] Button between "Aceptada" status and "Marcar como Entregado"
- [ ] Button disabled/hidden after clicked once
- [ ] Success feedback when clicked

### AC12.7.11.2: Status Update
- [ ] Clicking button changes status to `en_camino`
- [ ] Timestamp recorded (for delivery time analytics)
- [ ] Provider view updates to show "En Camino" status

### AC12.7.11.3: Consumer Notification
- [ ] Consumer receives push notification "Â¡Tu agua estÃ¡ en camino!"
- [ ] Consumer tracking page shows "En Camino" status
- [ ] Visual progress indicator updated

### AC12.7.11.4: Admin Visibility
- [ ] Admin can see "En Camino" status in orders
- [ ] Admin dashboard distinguishes from "Aceptado"
- [ ] Correct status in timeline/history

### AC12.7.11.5: Backwards Compatibility
- [ ] Existing deliveries without en_camino work normally
- [ ] Provider can skip directly to "Entregado" (optional path)
- [ ] No breaking changes to existing flows

## Database Migration

```sql
-- Add en_camino status
ALTER TABLE water_requests
  DROP CONSTRAINT IF EXISTS water_requests_status_check;

ALTER TABLE water_requests
  ADD CONSTRAINT water_requests_status_check
  CHECK (status IN (
    'pending',
    'searching',
    'accepted',
    'en_camino',  -- NEW
    'delivered',
    'cancelled',
    'expired'
  ));

-- Optional: Track timestamp
ALTER TABLE water_requests
  ADD COLUMN IF NOT EXISTS en_camino_at TIMESTAMPTZ;
```

## Implementation Notes

### Server Action

```typescript
export async function markEnCamino(requestId: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  // Verify provider owns this delivery
  const { data: request } = await supabase
    .from('water_requests')
    .select('*, offers!inner(*)')
    .eq('id', requestId)
    .eq('offers.provider_id', user.id)
    .eq('offers.status', 'accepted')
    .single();

  if (!request) {
    return { success: false, error: 'Entrega no encontrada' };
  }

  // Update status
  const { error } = await supabase
    .from('water_requests')
    .update({
      status: 'en_camino',
      en_camino_at: new Date().toISOString()
    })
    .eq('id', requestId);

  if (error) {
    return { success: false, error: 'Error al actualizar estado' };
  }

  // Send push notification to consumer
  await sendPushToUser(request.user_id, {
    title: 'Â¡Tu agua estÃ¡ en camino!',
    body: `${provider.name} ha salido para entregar tu pedido`,
    url: `/status/${requestId}`
  });

  return { success: true };
}
```

### UI Component

```tsx
{status === 'accepted' && (
  <Button
    size="lg"
    className="w-full"
    onClick={() => markEnCamino(requestId)}
  >
    ðŸš— ESTOY EN CAMINO
  </Button>
)}

{status === 'en_camino' && (
  <div className="text-center text-blue-600 font-medium">
    ðŸš— En Camino
  </div>
)}
```

## Definition of Done

- [ ] "En Camino" button works for provider
- [ ] Status updates in database
- [ ] Consumer receives notification
- [ ] Consumer tracking shows new status
- [ ] Admin can see new status
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 4.9, 4.11, 4.12)
