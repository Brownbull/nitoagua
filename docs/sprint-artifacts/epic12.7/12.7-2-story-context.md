# Story 12.7-2: Push Notification Triggers - Story Context

## Technical Analysis

### Current Implementation

**Trigger Functions in** `src/lib/push/trigger-push.ts`:
- `triggerNewOfferPush()` - Consumer receives when offer submitted
- `triggerOfferAcceptedPush()` - Provider receives when offer accepted
- `triggerDeliveryCompletedPush()` - Consumer receives on delivery

**Call Sites Already Exist:**
- `src/lib/actions/offers.ts:643` - triggerNewOfferPush called
- `src/lib/actions/offers.ts:1239` - triggerOfferAcceptedPush called
- `src/lib/actions/delivery.ts:231` - triggerDeliveryCompletedPush called

### Root Cause Analysis

The trigger functions ARE being called. The issue is likely:

1. **VAPID Keys Not Configured** - Production env may lack keys
2. **User Has No Subscription** - Test users may not have push enabled
3. **Silent Failures** - Errors caught but not surfaced
4. **Subscription Stale** - Old subscriptions not cleaned up

### Verification Steps

1. Check VAPID keys in production:
   - `NEXT_PUBLIC_VAPID_PUBLIC_KEY`
   - `VAPID_PRIVATE_KEY`

2. Check `push_subscriptions` table for test users

3. Check Edge Function logs at Supabase dashboard

### Key Code Sections

```typescript
// offers.ts:643 - New offer push trigger
triggerNewOfferPush(request.consumer_id, requestId, request.amount, 1).catch(
  (err) => console.error("[submitOffer] Push notification failed:", err)
);

// offers.ts:1239 - Offer accepted push trigger
triggerOfferAcceptedPush(providerId, request.id, request.amount, comunaName).catch(
  (err) => console.error("[selectOffer] Push to provider failed:", err)
);

// delivery.ts:231 - Delivery complete push trigger
triggerDeliveryCompletedPush(request.consumer_id, request.id, request.amount).catch(
  (err) => console.error("[markDelivered] Push notification failed:", err)
);
```

### Files to Check/Modify

| File | Purpose |
|------|---------|
| `src/lib/push/send-push.ts` | Core push sending logic |
| `src/lib/push/trigger-push.ts` | Trigger function definitions |
| `.env.local` / Vercel env | VAPID key configuration |
| `supabase/functions/send-push-notification/` | Edge function |

### Testing Approach

1. Enable push on test devices first
2. Verify subscriptions exist in database
3. Add temporary logging to confirm triggers fire
4. Check Supabase Edge Function logs
5. Test with real VAPID keys

### Acceptance Criteria Mapping

| AC | Trigger Function | Call Site |
|----|------------------|-----------|
| AC12.7.2.1 | triggerNewOfferPush | offers.ts:643 |
| AC12.7.2.2 | triggerOfferAcceptedPush | offers.ts:1239 |
| AC12.7.2.3 | triggerDeliveryCompletedPush | delivery.ts:231 |
