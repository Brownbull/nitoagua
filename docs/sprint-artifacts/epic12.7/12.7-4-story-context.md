# Story 12.7-4: Admin Status Sync - Story Context

## Technical Analysis

### Current Implementation

**Realtime Hook:** `src/hooks/use-realtime-orders.ts`

```typescript
// Channels subscribed:
- "admin-orders" → water_requests table changes
- "admin-offers" → offers table changes

// On change:
- Sets lastUpdate state
- Calls router.refresh()
```

### Root Cause Investigation

1. **Subscription Not Connecting** - Channel may fail to subscribe
2. **Router.refresh() Not Working** - Server component may not re-fetch
3. **RLS Blocking Realtime** - Admin may not receive realtime events
4. **Filter Mismatch** - Event filter may exclude needed changes

### Key Code Sections

```typescript
// use-realtime-orders.ts
supabase
  .channel('admin-orders')
  .on('postgres_changes', {
    event: '*',
    schema: 'public',
    table: 'water_requests'
  }, handleChange)
  .subscribe();
```

### Files to Modify

| File | Change |
|------|--------|
| `src/hooks/use-realtime-orders.ts` | Fix subscription config |
| `src/app/admin/orders/page.tsx` | May need client-side state |
| Supabase RLS policies | May need realtime permissions |

### Testing Approach

1. Open admin orders in one tab
2. Make changes in another (as provider/consumer)
3. Verify changes appear without refresh
4. Check isConnected state in component

### Acceptance Criteria Mapping

| AC | Implementation |
|----|----------------|
| AC12.7.4.1 | Realtime subscription connects |
| AC12.7.4.2 | Status updates appear in real-time |
| AC12.7.4.3 | Works across all status transitions |
