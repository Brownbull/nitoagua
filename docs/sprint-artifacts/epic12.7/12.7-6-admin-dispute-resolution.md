# Story 12.7-6: Admin Dispute Resolution

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-6 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Admin Dispute Resolution |
| **Status** | drafted |
| **Priority** | P1 (High) |
| **Points** | 8 |
| **Bug Reference** | BUG-016 |
| **Depends On** | 12.7-5 (Consumer Dispute Option) |

## User Story

**As an** admin,
**I want** tools to investigate and resolve delivery disputes,
**So that** I can maintain platform trust and handle fraud cases effectively.

## Problem Statement

When a consumer files a dispute (Story 12.7-5), the admin needs tools to investigate and resolve it. Currently, there is no dispute management system for admins - disputes would require manual WhatsApp/phone resolution.

## Technical Context

### Prerequisites
- Story 12.7-5 creates `disputes` table
- Disputes created by consumers with various types

### Admin Needs
1. **Notification** - Alert when dispute is filed
2. **View disputes** - Dashboard showing all open disputes
3. **Investigation** - See full order history
4. **Resolution actions** - Multiple options to resolve

## Acceptance Criteria

### AC12.7.6.1: Dispute Notification
- [ ] Admin receives notification when new dispute filed
- [ ] Push notification (if enabled) + in-app alert
- [ ] Badge/counter on admin nav for open disputes

### AC12.7.6.2: Dispute List View
- [ ] New admin section: "Disputas" / "Disputes"
- [ ] List all disputes with status filter
- [ ] Show: Dispute type, consumer, provider, date, status
- [ ] Sort by date (newest first by default)
- [ ] Open disputes highlighted/prioritized

### AC12.7.6.3: Dispute Detail View
- [ ] Full dispute information visible
- [ ] Original order details
- [ ] Order timeline (created, accepted, delivered, disputed)
- [ ] Consumer info and contact
- [ ] Provider info and contact
- [ ] Evidence photos (if attached)

### AC12.7.6.4: Resolution Actions
- [ ] **Confirmar Entrega** - Validate delivery was made (provider right)
- [ ] **Reembolsar** - Consumer right, refund/credit
- [ ] **Reasignar** - Assign to new provider
- [ ] **Reabrir Pedido** - Return to marketplace
- [ ] **Advertir Proveedor** - First warning
- [ ] **Suspender Proveedor** - Fraud confirmed

### AC12.7.6.5: Resolution Workflow
- [ ] Admin adds internal notes before resolving
- [ ] Resolution requires confirmation
- [ ] Both parties notified of resolution
- [ ] Audit trail of who resolved and when

### AC12.7.6.6: Provider Accountability
- [ ] Track dispute count per provider
- [ ] Auto-flag providers with multiple disputes
- [ ] Warning/suspension thresholds (configurable)

## UI Design

### Dispute List

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DISPUTAS                                    [Filtrar â–¼]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ #1234 | No recibÃ­ mi pedido | MarÃ­a C. | Hace 2h       â”‚
â”‚  ğŸ”´ #1233 | Cantidad incorrecta | Juan P. | Hace 5h        â”‚
â”‚  ğŸŸ¢ #1230 | LlegÃ³ tarde | Ana S. | Hace 2d | RESUELTO      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dispute Detail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DISPUTA #1234                                    âš ï¸ ABIERTA â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Tipo: No recibÃ­ mi pedido                                  â”‚
â”‚  Consumidor: MarÃ­a Consumer                                 â”‚
â”‚  Proveedor: Juan Provider                                   â”‚
â”‚  Pedido: #5678 - 1000L - $18,000 CLP                       â”‚
â”‚                                                             â”‚
â”‚  Timeline:                                                  â”‚
â”‚  â€¢ 14:00 - Pedido creado                                   â”‚
â”‚  â€¢ 14:30 - Oferta aceptada                                 â”‚
â”‚  â€¢ 15:15 - Marcado como entregado por proveedor            â”‚
â”‚  â€¢ 15:20 - Consumidor reporta: "No recibÃ­ nada"            â”‚
â”‚                                                             â”‚
â”‚  Evidencia: [Ver foto adjunta]                              â”‚
â”‚                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                             â”‚
â”‚  ACCIONES:                                                  â”‚
â”‚                                                             â”‚
â”‚  [ âœ… Confirmar Entrega ]  - Proveedor tiene razÃ³n         â”‚
â”‚  [ ğŸ’° Reembolsar ]         - Consumidor tiene razÃ³n        â”‚
â”‚  [ ğŸ”„ Reasignar ]          - Nuevo proveedor               â”‚
â”‚  [ ğŸ“¢ Reabrir Pedido ]     - Volver al marketplace         â”‚
â”‚  [ âš ï¸ Advertir Proveedor ] - Primera advertencia           â”‚
â”‚  [ ğŸš« Suspender Proveedor ] - Fraude confirmado            â”‚
â”‚                                                             â”‚
â”‚  Notas internas:                                            â”‚
â”‚  [ __________________________________________________ ]    â”‚
â”‚                                                             â”‚
â”‚  [ Guardar ResoluciÃ³n ]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Updates

```sql
-- Add to disputes table (from 12.7-5)
ALTER TABLE disputes ADD COLUMN IF NOT EXISTS
  resolution_action TEXT CHECK (resolution_action IN (
    'confirmed_delivery',
    'refunded',
    'reassigned',
    'reopened',
    'provider_warned',
    'provider_suspended'
  ));

-- Provider accountability tracking
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS
  dispute_count INTEGER DEFAULT 0;

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS
  warning_count INTEGER DEFAULT 0;

-- Update dispute count trigger
CREATE OR REPLACE FUNCTION update_provider_dispute_count()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE profiles
    SET dispute_count = dispute_count + 1
    WHERE id = NEW.provider_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER increment_dispute_count
  AFTER INSERT ON disputes
  FOR EACH ROW
  EXECUTE FUNCTION update_provider_dispute_count();
```

## Implementation Notes

### Resolution Flow

```typescript
async function resolveDispute(
  disputeId: string,
  action: ResolutionAction,
  notes: string
) {
  // 1. Update dispute status
  await updateDisputeStatus(disputeId, 'resolved', action, notes);

  // 2. Execute action-specific logic
  switch (action) {
    case 'refunded':
      await processRefund(disputeId);
      break;
    case 'reassigned':
      await reopenForNewProvider(disputeId);
      break;
    case 'provider_warned':
      await warnProvider(disputeId);
      break;
    case 'provider_suspended':
      await suspendProvider(disputeId);
      break;
  }

  // 3. Notify both parties
  await notifyConsumerOfResolution(disputeId, action);
  await notifyProviderOfResolution(disputeId, action);
}
```

## Definition of Done

- [ ] Admin can view all disputes
- [ ] Admin can filter by status
- [ ] Admin can view dispute details
- [ ] All resolution actions work
- [ ] Both parties notified on resolution
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 5.10-5.13)
