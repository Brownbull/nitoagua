# Story 12.7-6: Admin Dispute Resolution

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-6 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Admin Dispute Resolution |
| **Status** | review |
| **Priority** | P1 (High) |
| **Points** | 8 |
| **Bug Reference** | BUG-016 |
| **Depends On** | 12.7-5 (Consumer Dispute Option) - DONE |

## User Story

**As an** admin,
**I want** tools to investigate and resolve delivery disputes,
**So that** I can maintain platform trust and handle fraud cases effectively.

## Problem Statement

When a consumer files a dispute (Story 12.7-5), the admin needs tools to investigate and resolve it. Currently, there is no dispute management system for admins - disputes would require manual WhatsApp/phone resolution.

## Technical Context

### Prerequisites
- Story 12.7-5 creates `disputes` table - DONE
- Disputes created by consumers with various types - DONE

### Existing Schema (from 12.7-5)

```sql
CREATE TABLE disputes (
  id UUID PRIMARY KEY,
  request_id UUID REFERENCES water_requests(id),
  consumer_id UUID REFERENCES profiles(id),
  provider_id UUID REFERENCES profiles(id),
  dispute_type TEXT CHECK (dispute_type IN ('not_delivered', 'wrong_quantity', 'late_delivery', 'quality_issue', 'other')),
  description TEXT,
  evidence_url TEXT,
  status TEXT DEFAULT 'open' CHECK (status IN ('open', 'under_review', 'resolved_consumer', 'resolved_provider', 'closed')),
  resolution_notes TEXT,
  resolved_by UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ,
  resolved_at TIMESTAMPTZ
);
```

### Admin Needs
1. **View disputes** - Dashboard showing all disputes with filters
2. **Investigation** - See full order history and details
3. **Resolution actions** - Resolve in favor of consumer/provider
4. **Audit trail** - Track who resolved and when

## Acceptance Criteria

### AC12.7.6.1: Dispute List View
- [x] New admin section: "Disputas" in sidebar (AlertTriangle icon)
- [x] List all disputes with status filter (open/under_review/resolved)
- [x] Show: Dispute type, consumer name, provider name, date, status
- [x] Sort by date (newest first by default)
- [x] Open disputes visually prioritized (colored indicator)

### AC12.7.6.2: Dispute Detail View
- [x] Full dispute information visible
- [x] Original order details (amount, address, timestamps)
- [x] Order timeline (created, accepted, delivered, disputed)
- [x] Consumer info and WhatsApp/email contact links
- [x] Provider info and WhatsApp/email contact links

### AC12.7.6.3: Resolution Actions
- [x] **Resolver a favor del consumidor** - Set status to 'resolved_consumer'
- [x] **Resolver a favor del proveedor** - Set status to 'resolved_provider'
- [x] Admin adds internal notes before resolving
- [x] Resolution requires confirmation dialog
- [x] resolved_by and resolved_at auto-filled

### AC12.7.6.4: Resolution Notifications
- [x] Consumer notified of resolution outcome via in-app notification
- [x] Provider notified of resolution outcome via in-app notification
- [x] Notification includes resolution type (consumer/provider favor)

## Dev Notes

### Implementation Approach
- Follow existing admin page patterns (orders, verification)
- Use `requireAdmin` guard and `createAdminClient` for RLS bypass
- Use `force-dynamic` export for fresh data
- Spanish UI strings, English comments
- Leverage shadcn/ui components (Table, Badge, Dialog, Textarea)

### Technical References
- **Admin orders page:** `src/app/admin/orders/page.tsx` - list pattern
- **Admin order detail:** `src/app/admin/orders/[id]/page.tsx` - detail pattern
- **Admin sidebar:** `src/components/admin/admin-sidebar.tsx` - nav integration
- **Dispute dialog:** `src/components/consumer/dispute-dialog.tsx` - dispute types reference

### Testing Requirements
- Use merged-fixtures import pattern
- Call `assertNoErrorState(page)` after every `page.goto()`
- Seed dispute data for tests
- Mobile viewport: 360x780

### Atlas Patterns to Apply
- Server Actions: `requireAdmin` guard
- RLS optimization: `(select auth.uid())` pattern
- API Response: `ApiResponse<T>` pattern
- force-dynamic: Admin pages always show fresh data

## Tasks

- [x] Task 1: Add "Disputas" to admin sidebar
  - [x] 1.1: Import AlertTriangle icon from lucide-react
  - [x] 1.2: Add nav item to navItems array after "Pedidos"
  - [x] 1.3: Verify sidebar shows new item

- [x] Task 2: Create admin disputes list page
  - [x] 2.1: Create `src/app/admin/disputes/page.tsx`
  - [x] 2.2: Implement getDisputesData() with admin client
  - [x] 2.3: Add status filter (open/resolved/all)
  - [x] 2.4: Display disputes in list with status badges
  - [x] 2.5: Add `force-dynamic` export

- [x] Task 3: Create admin dispute detail page
  - [x] 3.1: Create `src/app/admin/disputes/[id]/page.tsx`
  - [x] 3.2: Fetch dispute with related order, consumer, provider data
  - [x] 3.3: Display order timeline
  - [x] 3.4: Show contact links (WhatsApp/email) for both parties
  - [x] 3.5: Add `force-dynamic` export

- [x] Task 4: Create resolution actions component
  - [x] 4.1: Create `src/components/admin/dispute-resolution.tsx`
  - [x] 4.2: Add resolution buttons (consumer favor / provider favor)
  - [x] 4.3: Add notes textarea
  - [x] 4.4: Add confirmation dialog before resolution
  - [x] 4.5: Handle loading/error states

- [x] Task 5: Create resolution server action
  - [x] 5.1: Create `src/lib/actions/admin-disputes.ts`
  - [x] 5.2: Implement `resolveDispute()` with requireAdmin guard
  - [x] 5.3: Update dispute status, resolved_by, resolved_at
  - [x] 5.4: Create notifications for consumer and provider

- [x] Task 6: Create E2E tests
  - [x] 6.1: Test disputes list page loads
  - [x] 6.2: Test dispute detail page loads
  - [x] 6.3: Test resolution flow (resolve consumer favor)
  - [x] 6.4: Test resolution flow (resolve provider favor)
  - [x] 6.5: Verify notifications created after resolution

- [x] Task 7: Run full validation
  - [x] 7.1: Run all E2E tests - verify no regressions
  - [x] 7.2: Run linting and type checks
  - [x] 7.3: Test build compiles successfully

## Definition of Done

- [x] Admin can view all disputes
- [x] Admin can filter by status
- [x] Admin can view dispute details
- [x] Admin can resolve disputes in favor of consumer/provider
- [x] Both parties notified on resolution
- [x] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 5.10-5.13)

## Dev Agent Record

### Implementation Plan

Atlas-enhanced dev-story workflow executed:
1. Loaded Atlas knowledge fragments (architecture, testing patterns)
2. Validated story alignment with documented patterns
3. Implemented tasks following existing admin page patterns
4. Created E2E tests with merged-fixtures pattern

### Debug Log

- Fixed TypeScript error: `request.created_at` can be null, added fallback

### File List

| File | Action |
|------|--------|
| `src/components/admin/admin-sidebar.tsx` | Modified - Added Disputas nav item |
| `src/app/admin/disputes/page.tsx` | Created - Disputes list page |
| `src/app/admin/disputes/[id]/page.tsx` | Created - Dispute detail page |
| `src/components/admin/dispute-resolution.tsx` | Created - Resolution component |
| `src/lib/actions/admin-disputes.ts` | Created - Server action |
| `src/lib/utils/dispute-constants.ts` | Created - Shared constants (code review fix) |
| `scripts/local/seed-disputes-tests.ts` | Created - E2E test seed script (code review fix) |
| `tests/e2e/admin-disputes.spec.ts` | Created - E2E tests |

### Change Log

| Date | Change | Reason |
|------|--------|--------|
| 2026-01-02 | Story implementation complete | BUG-016 fix |
| 2026-01-02 | Code review fixes applied | DRY constants, unused imports, WhatsApp format, seed script |

### Completion Notes

Implementation complete. All acceptance criteria met:
- Admin can view disputes list with filtering by status
- Admin can view dispute details with order timeline
- Admin can resolve disputes with confirmation dialog
- Both parties receive notifications on resolution
- E2E tests created covering navigation, filters, detail view, and resolution actions
- Build compiles successfully

### Code Review Fixes Applied

1. **Created seed script** - `scripts/local/seed-disputes-tests.ts` provides test disputes in all statuses
2. **Removed unused imports** - Cleaned up `format`, `formatDistanceToNow`, `Clock`, `XCircle`, `FileText`
3. **Extracted shared constants** - Created `src/lib/utils/dispute-constants.ts` for DRY compliance
4. **Fixed WhatsApp phone formatting** - Added `formatPhoneForWhatsApp()` helper to handle various phone formats
5. **TypeScript compiles successfully** - All lint warnings resolved for disputes files
