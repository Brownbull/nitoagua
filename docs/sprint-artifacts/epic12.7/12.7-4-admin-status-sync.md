# Story 12.7-4: Admin Status Sync

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-4 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Admin Status Sync |
| **Status** | drafted |
| **Priority** | P0 (Critical) |
| **Points** | 5 |
| **Bug Reference** | BUG-011 |

## User Story

**As an** admin monitoring the delivery pipeline,
**I want** to see accurate, real-time delivery statuses,
**So that** I can provide accurate information and manage operations effectively.

## Problem Statement

The Admin panel shows deliveries with incorrect status. A delivery that has been **accepted** (but NOT yet delivered) appears as if it's already delivered - mixed in with completed deliveries. Meanwhile, the Provider view correctly shows it as "Entrega Activa" (Active Delivery).

**The Data is Out of Sync:**

| View | What it Shows | What it Should Show |
|------|---------------|---------------------|
| **Provider** | "Entrega Activa" + "Marcar como Entregado" | Correct |
| **Admin** | Mixed with delivered orders, no "accepted" status | Wrong |

## Technical Context

### Component Location
- `src/app/admin/orders/page.tsx` - Admin orders list
- `src/lib/actions/offers.ts` - Offer acceptance logic
- Database schema for `water_requests` table - status column

### Expected Status Flow
```
pending → searching → accepted/assigned → en_camino → delivered
```

### Potential Root Causes
1. **Status enum mismatch** - Admin using different status values than Provider
2. **Query filter issue** - Admin orders query not properly filtering/grouping by status
3. **Realtime sync issue** - Admin not receiving status updates
4. **Status display mapping** - Backend status not mapped correctly to UI labels
5. **Database trigger issue** - Status not updating correctly when offer accepted

## Acceptance Criteria

### AC12.7.4.1: Correct Status Display
- [ ] Admin sees "Pendiente" for requests with no accepted offer
- [ ] Admin sees "Aceptado" / "Asignado" for accepted offers awaiting delivery
- [ ] Admin sees "En Camino" when provider indicates (if implemented)
- [ ] Admin sees "Entregado" only for completed deliveries
- [ ] Status matches Provider view for same order

### AC12.7.4.2: Real-time Updates
- [ ] When provider accepts offer, admin sees status change without refresh
- [ ] When provider marks delivered, admin sees status change without refresh
- [ ] Supabase Realtime subscription active on admin orders page

### AC12.7.4.3: Status Filtering
- [ ] Admin can filter by status (Pending, Accepted, Delivered)
- [ ] Filtered counts are accurate
- [ ] Active deliveries clearly distinguished from completed

### AC12.7.4.4: Visual Distinction
- [ ] Active deliveries have different visual treatment (color, badge)
- [ ] Clear indication of assigned provider for accepted orders
- [ ] Time remaining to delivery window shown (if applicable)

## Investigation Checklist

- [ ] Query database: What is actual `status` value when this bug occurs?
- [ ] Compare status enum values between Admin and Provider code
- [ ] Check Admin orders query - is it filtering correctly?
- [ ] Verify offer acceptance updates the correct status field
- [ ] Check if Realtime subscription exists on admin page
- [ ] Test: Does navigating away and back show correct status?

## Implementation Notes

### Status Enum Alignment

Ensure consistent status values across all code:

```typescript
// Status should be consistent everywhere
type RequestStatus =
  | 'pending'      // Waiting for offers
  | 'searching'    // Has offers, consumer reviewing
  | 'accepted'     // Offer accepted, awaiting delivery
  | 'en_camino'    // Provider on the way (if implemented)
  | 'delivered'    // Completed
  | 'cancelled'    // Cancelled by consumer
  | 'expired';     // Timed out with no offers
```

### Realtime Subscription

Add Realtime subscription to admin orders:

```typescript
useEffect(() => {
  const subscription = supabase
    .channel('admin-orders')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'water_requests'
    }, (payload) => {
      // Update local state with new data
      refetchOrders();
    })
    .subscribe();

  return () => subscription.unsubscribe();
}, []);
```

### Query Fix

Ensure admin query includes proper status handling:

```typescript
const { data: orders } = await supabase
  .from('water_requests')
  .select(`
    *,
    offers!inner(
      status,
      provider:profiles(name)
    )
  `)
  .order('created_at', { ascending: false });

// Map to display status
const displayStatus = (order) => {
  if (order.status === 'delivered') return 'Entregado';
  if (order.offers?.some(o => o.status === 'accepted')) return 'Aceptado';
  if (order.offers?.length > 0) return 'Con ofertas';
  return 'Pendiente';
};
```

## Definition of Done

- [ ] Admin status matches Provider status for same order
- [ ] Real-time updates work without refresh
- [ ] Status filtering works correctly
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 3.7, 3.9)
