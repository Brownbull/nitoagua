# Story 12.7-4: Admin Status Sync

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-4 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Admin Status Sync |
| **Status** | done |
| **Priority** | P0 (Critical) |
| **Points** | 5 |
| **Bug Reference** | BUG-011 |

## User Story

**As an** admin monitoring the delivery pipeline,
**I want** to see accurate, real-time delivery statuses,
**So that** I can provide accurate information and manage operations effectively.

## Problem Statement

The Admin panel shows deliveries with incorrect status. A delivery that has been **accepted** (but NOT yet delivered) appears as if it's already delivered - mixed in with completed deliveries. Meanwhile, the Provider view correctly shows it as "Entrega Activa" (Active Delivery).

**The Data is Out of Sync:**

| View | What it Shows | What it Should Show |
|------|---------------|---------------------|
| **Provider** | "Entrega Activa" + "Marcar como Entregado" | Correct |
| **Admin** | Mixed with delivered orders, no "accepted" status | Wrong |

## Technical Context

### Component Location
- `src/app/admin/orders/page.tsx` - Admin orders list
- `src/lib/actions/offers.ts` - Offer acceptance logic
- Database schema for `water_requests` table - status column

### Expected Status Flow
```
pending → searching → accepted/assigned → en_camino → delivered
```

### Potential Root Causes
1. **Status enum mismatch** - Admin using different status values than Provider
2. **Query filter issue** - Admin orders query not properly filtering/grouping by status
3. **Realtime sync issue** - Admin not receiving status updates
4. **Status display mapping** - Backend status not mapped correctly to UI labels
5. **Database trigger issue** - Status not updating correctly when offer accepted

## Acceptance Criteria

### AC12.7.4.1: Correct Status Display
- [x] Admin sees "Pendiente" for requests with no accepted offer
- [x] Admin sees "Aceptado" for accepted offers awaiting delivery
- [x] Admin sees "En Camino" when provider indicates (if implemented)
- [x] Admin sees "Entregado" only for completed deliveries
- [x] Status matches Provider view for same order

### AC12.7.4.2: Real-time Updates
- [x] When provider accepts offer, admin sees status change without refresh
- [x] When provider marks delivered, admin sees status change without refresh
- [x] Supabase Realtime subscription active on admin orders page

### AC12.7.4.3: Status Filtering
- [x] Admin can filter by status (Pending, Accepted, Delivered)
- [x] Filtered counts are accurate
- [x] Active deliveries clearly distinguished from completed

### AC12.7.4.4: Visual Distinction
- [x] Active deliveries have different visual treatment (color, badge)
- [x] Clear indication of assigned provider for accepted orders
- [ ] Time remaining to delivery window shown (if applicable) - N/A for this story

## Investigation Checklist

- [x] Query database: What is actual `status` value when this bug occurs?
- [x] Compare status enum values between Admin and Provider code
- [x] Check Admin orders query - is it filtering correctly?
- [x] Verify offer acceptance updates the correct status field
- [x] Check if Realtime subscription exists on admin page
- [x] Test: Does navigating away and back show correct status?

## Implementation Notes

### Status Enum Alignment

Ensure consistent status values across all code:

```typescript
// Status should be consistent everywhere
type RequestStatus =
  | 'pending'      // Waiting for offers
  | 'searching'    // Has offers, consumer reviewing
  | 'accepted'     // Offer accepted, awaiting delivery
  | 'en_camino'    // Provider on the way (if implemented)
  | 'delivered'    // Completed
  | 'cancelled'    // Cancelled by consumer
  | 'expired';     // Timed out with no offers
```

### Realtime Subscription

Add Realtime subscription to admin orders:

```typescript
useEffect(() => {
  const subscription = supabase
    .channel('admin-orders')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'water_requests'
    }, (payload) => {
      // Update local state with new data
      refetchOrders();
    })
    .subscribe();

  return () => subscription.unsubscribe();
}, []);
```

### Query Fix

Ensure admin query includes proper status handling:

```typescript
const { data: orders } = await supabase
  .from('water_requests')
  .select(`
    *,
    offers!inner(
      status,
      provider:profiles(name)
    )
  `)
  .order('created_at', { ascending: false });

// Map to display status
const displayStatus = (order) => {
  if (order.status === 'delivered') return 'Entregado';
  if (order.offers?.some(o => o.status === 'accepted')) return 'Aceptado';
  if (order.offers?.length > 0) return 'Con ofertas';
  return 'Pendiente';
};
```

## Tasks

- [x] Task 1: Investigate root cause - status enum mismatch identified
- [x] Task 2: Fix STATUS_CONFIG mapping (assigned → accepted)
- [x] Task 3: Fix STATUS_OPTIONS dropdown (assigned → accepted)
- [x] Task 4: Fix OrderStats interface (assigned → accepted)
- [x] Task 5: Fix calculateStats function (assigned → accepted)
- [x] Task 6: Add no_offers status mapping
- [x] Task 7: Update existing admin-orders.spec.ts test
- [x] Task 8: Create new admin-status-sync.spec.ts tests (7 tests)
- [x] Task 9: Verify build compiles successfully
- [x] Task 10: Run E2E tests - 7/7 passing

## Definition of Done

- [x] Admin status matches Provider status for same order
- [x] Real-time updates work without refresh
- [x] Status filtering works correctly
- [x] E2E tests pass (7/7)
- [x] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 3.7, 3.9)

## Dev Agent Record

### Root Cause Analysis

The bug was caused by a **status enum mismatch** between the Admin and Provider code:

| Component | Used Status | Database Status |
|-----------|-------------|-----------------|
| Provider view | `accepted` | `accepted` ✓ |
| Admin page | `assigned` | `accepted` ✗ |

The database uses `accepted` status when an offer is accepted, but the Admin page was looking for `assigned` in:
- `STATUS_CONFIG` mapping
- `STATUS_OPTIONS` dropdown
- `calculateStats` function
- `OrderStats` interface

### Changes Made

1. **src/components/admin/orders-table.tsx**
   - Changed `assigned` → `accepted` in STATUS_CONFIG
   - Changed `assigned` → `accepted` in STATUS_OPTIONS
   - Changed `handleAssignedClick` → `handleAcceptedClick`
   - Added `no_offers` status mapping

2. **src/app/admin/orders/page.tsx**
   - Changed `assigned` → `accepted` in OrderStats interface
   - Changed `assigned` → `accepted` in getEmptyStats()
   - Changed `assigned` → `accepted` in calculateStats()
   - Added `no_offers` case to pending count

3. **tests/e2e/admin-orders.spec.ts**
   - Updated stats cards test to check for "Aceptados" not "Asignados"

4. **tests/e2e/admin-status-sync.spec.ts** (NEW)
   - 7 new E2E tests for status sync functionality
   - Tests AC12.7.4.1, AC12.7.4.2, AC12.7.4.3, AC12.7.4.4

### File List

| File | Action |
|------|--------|
| src/components/admin/orders-table.tsx | Modified |
| src/app/admin/orders/page.tsx | Modified |
| src/app/admin/orders/[id]/page.tsx | Modified (Code Review Fix) |
| tests/e2e/admin-orders.spec.ts | Modified |
| tests/e2e/admin-status-sync.spec.ts | Created + Modified (Code Review Fix) |

### Completion Notes

**Root Cause:** Status enum mismatch - Admin used "assigned" but database has "accepted"

**Fix:** Aligned Admin code with actual database status values

**Testing:** 7/7 E2E tests passing, build successful

**Lessons Learned:**
1. Always verify actual database values before assuming status mappings
2. Provider code was correct, Admin code had legacy incorrect values

### Code Review Fixes (2026-01-02)

**Issues Found & Fixed:**

1. **[HIGH] Order Detail Page Not Fixed** - The original fix only updated the list page but missed the detail page (`/admin/orders/[id]/page.tsx`). Fixed by changing `assigned` → `accepted` and adding `no_offers` status.

2. **[HIGH] Missing `no_offers` in Detail Page** - Added `no_offers` status to detail page statusConfig to match list page.

3. **[MEDIUM] Test Pattern Violation** - Added `assertNoErrorState(page)` calls after all `page.goto()` in `admin-status-sync.spec.ts` per Atlas Section 5 testing patterns.

**Reviewer Note:** The same bug existed in TWO places (list page and detail page), but only one was fixed initially. This reinforces Lesson #1: search ALL files for status mappings when fixing status bugs.
