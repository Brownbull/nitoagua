# Story 12.7-9: Admin Panel UX Improvements

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-9 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Admin Panel UX Improvements |
| **Status** | drafted |
| **Priority** | P2 (Medium) |
| **Points** | 5 |
| **Bug References** | BUG-002, BUG-006, BUG-017 |

## User Story

**As an** admin,
**I want** the admin panel to be more usable and efficient,
**So that** I can quickly find orders, navigate finances, and manage operations.

## Problem Statement

Three related admin panel usability issues:

### BUG-002: Stale Data / No Refresh
Admin orders page shows stale/cached data. New orders don't appear without hard refresh. No manual refresh button available.

### BUG-006: No Sorting by Date
Admin orders list can only be filtered, not sorted. Cannot quickly find newest orders in a long list.

### BUG-017: Finance Navigation Issues
Admin finances view has no "Jump to Today" button. Must manually navigate through weeks. Yearly view doesn't show pending payments.

## Technical Context

### Component Location
- `src/app/admin/orders/page.tsx` - Orders list
- `src/app/admin/finances/page.tsx` - Finances view
- Admin layout and navigation components

## Acceptance Criteria

### AC12.7.9.1: Real-time Order Updates (BUG-002)
- [ ] Supabase Realtime subscription on admin orders
- [ ] New orders appear automatically (no refresh)
- [ ] OR: Add manual "Actualizar" refresh button
- [ ] Visual indication when data updates

### AC12.7.9.2: Order Sorting (BUG-006)
- [ ] Clickable column headers for sorting
- [ ] Sort by: Date, Status, Amount, Location
- [ ] Visual indicator for current sort (â–²/â–¼)
- [ ] Default sort: newest first

### AC12.7.9.3: Finance Quick Navigation (BUG-017)
- [ ] "Hoy" or "Esta Semana" quick jump button
- [ ] One click to current time period
- [ ] Remember last view preference

### AC12.7.9.4: Pending Payments in All Views (BUG-017)
- [ ] Yearly view shows pending payment count
- [ ] Pending payments aggregate correctly
- [ ] Example: "2024: $500,000 cobrado | â³ 3 pagos pendientes ($15,000)"

### AC12.7.9.5: General UX Polish
- [ ] Consistent spacing and alignment
- [ ] Loading states for data fetches
- [ ] Empty states with helpful messages

## Implementation Notes

### Real-time Subscription

```typescript
useEffect(() => {
  const subscription = supabase
    .channel('admin-orders')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'water_requests'
    }, () => {
      refetch(); // or update local state
    })
    .subscribe();

  return () => subscription.unsubscribe();
}, []);
```

### Sortable Table Headers

```tsx
const [sortField, setSortField] = useState('created_at');
const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc');

const handleSort = (field: string) => {
  if (field === sortField) {
    setSortDirection(d => d === 'asc' ? 'desc' : 'asc');
  } else {
    setSortField(field);
    setSortDirection('desc');
  }
};

// In table header
<th onClick={() => handleSort('created_at')}>
  Fecha {sortField === 'created_at' && (sortDirection === 'asc' ? 'â–²' : 'â–¼')}
</th>
```

### Finance Quick Navigation

```tsx
<div className="flex gap-2">
  <Button variant="outline" onClick={() => setView('week')}>
    Semana
  </Button>
  <Button variant="outline" onClick={() => setView('month')}>
    Mes
  </Button>
  <Button variant="outline" onClick={() => setView('year')}>
    AÃ±o
  </Button>
  <Button variant="primary" onClick={jumpToToday}>
    ðŸ“… Hoy
  </Button>
</div>
```

## Definition of Done

- [ ] Orders update in real-time OR refresh button works
- [ ] All column sorting works
- [ ] Finance navigation improved
- [ ] Pending payments visible in all views
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 6.2-6.7)
