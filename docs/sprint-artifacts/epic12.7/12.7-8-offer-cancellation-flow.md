# Story 12.7-8: Offer Cancellation Flow

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-8 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Offer Cancellation Flow |
| **Status** | drafted |
| **Priority** | P1 (High) |
| **Points** | 5 |
| **Bug References** | BUG-021, BUG-022 |

## User Story

**As a** provider,
**I want** to cancel my pending offer with correct feedback,
**So that** I know my action succeeded and consumers see accurate availability.

## Problem Statement

Two related bugs in the offer cancellation flow:

### BUG-021: Error Message on Success
When provider cancels offer, system shows ERROR ("Solo puedes cancelar ofertas pendientes") but the cancellation actually SUCCEEDS. This was confirmed when consumer tried to accept the cancelled offer and got "Esta oferta ya no está disponible".

### BUG-022: Stale UI on Consumer Side
After provider cancels offer, the offer remains visible in consumer's view until they try to interact with it. No real-time update removes the cancelled offer.

**The Flow:**
```
Provider clicks "Cancel Offer"
         ↓
Backend: Successfully cancels offer ✅
         ↓
Frontend: Shows ERROR message ❌  ← BUG-021
         ↓
Consumer: Still sees offer ❌      ← BUG-022
         ↓
Consumer: Tries to accept → "No longer available"
```

## Technical Context

### Component Location
- `src/lib/actions/offers.ts` - Offer cancellation logic
- Provider offers component
- Consumer offer list component
- `src/hooks/use-realtime-offers.ts` (if exists)

### Root Cause Analysis (BUG-021)

Likely checking status AFTER cancellation:

```typescript
// BUGGY CODE - checks status after cancellation
const cancelOffer = async (offerId) => {
  await supabase.from('offers').update({ status: 'cancelled' }).eq('id', offerId);

  // BUG: This check happens AFTER we just changed the status!
  const { data: offer } = await supabase.from('offers').select('status').eq('id', offerId).single();

  if (offer.status !== 'pending') {
    throw new Error('Solo puedes cancelar ofertas pendientes'); // Always throws now!
  }

  return { success: true };
};
```

### Root Cause Analysis (BUG-022)

Missing Supabase Realtime subscription for offer status changes on consumer side.

## Acceptance Criteria

### AC12.7.8.1: Correct Success Message (BUG-021)
- [ ] Provider sees SUCCESS message when cancelling offer
- [ ] Message: "Oferta cancelada exitosamente" or similar
- [ ] Offer removed from provider's active offers list
- [ ] No error message shown for successful action

### AC12.7.8.2: Pre-Cancel Validation
- [ ] Check offer status BEFORE attempting cancellation
- [ ] If already cancelled/accepted, show appropriate error
- [ ] Clear error messages for each failure case

### AC12.7.8.3: Real-time Consumer Update (BUG-022)
- [ ] Consumer's offer list updates when offer cancelled
- [ ] Cancelled offer disappears without page refresh
- [ ] Supabase Realtime subscription active on consumer offers

### AC12.7.8.4: Graceful Error Handling
- [ ] If offer already accepted, show "Esta oferta ya fue aceptada"
- [ ] If offer already cancelled, show "Esta oferta ya fue cancelada"
- [ ] If offer expired, show "Esta oferta ha expirado"

### AC12.7.8.5: E2E Test Coverage
- [ ] Test successful offer cancellation
- [ ] Test consumer view updates in real-time
- [ ] Test error cases (already accepted, etc.)

## Implementation

### Fix BUG-021: Correct Order of Operations

```typescript
export async function cancelOffer(offerId: string) {
  // 1. Check status BEFORE cancellation
  const { data: offer, error: fetchError } = await supabase
    .from('offers')
    .select('status')
    .eq('id', offerId)
    .single();

  if (fetchError || !offer) {
    return { success: false, error: 'Oferta no encontrada' };
  }

  // 2. Validate current status
  if (offer.status !== 'pending') {
    const messages = {
      'cancelled': 'Esta oferta ya fue cancelada',
      'accepted': 'Esta oferta ya fue aceptada',
      'expired': 'Esta oferta ha expirado',
    };
    return {
      success: false,
      error: messages[offer.status] || 'No se puede cancelar esta oferta'
    };
  }

  // 3. Perform cancellation
  const { error: updateError } = await supabase
    .from('offers')
    .update({ status: 'cancelled' })
    .eq('id', offerId);

  if (updateError) {
    return { success: false, error: 'Error al cancelar la oferta' };
  }

  // 4. Return success
  return { success: true, message: 'Oferta cancelada exitosamente' };
}
```

### Fix BUG-022: Add Realtime Subscription

```typescript
// In consumer offer list component
useEffect(() => {
  const subscription = supabase
    .channel('consumer-offers')
    .on('postgres_changes', {
      event: 'UPDATE',
      schema: 'public',
      table: 'offers',
      filter: `request_id=eq.${requestId}`
    }, (payload) => {
      // Remove cancelled offers from list
      if (payload.new.status === 'cancelled') {
        setOffers(prev => prev.filter(o => o.id !== payload.new.id));
      }
    })
    .subscribe();

  return () => subscription.unsubscribe();
}, [requestId]);
```

## Definition of Done

- [ ] Provider sees success message on cancel
- [ ] Error message only for actual failures
- [ ] Consumer view updates in real-time
- [ ] Cancelled offers disappear immediately
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 4.4-4.6)
