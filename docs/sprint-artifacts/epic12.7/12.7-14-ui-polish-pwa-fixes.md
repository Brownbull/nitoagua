# Story 12.7-14: UI Polish & PWA Fixes

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-14 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | UI Polish & PWA Fixes |
| **Status** | drafted |
| **Priority** | P3 (Low) |
| **Points** | 3 |
| **Bug References** | BUG-004, BUG-018, BUG-019 |

## User Story

**As a** user of the NitoAgua PWA,
**I want** polished UI feedback and proper notification icons,
**So that** my experience feels professional and complete.

## Problem Statement

Three minor polish issues were identified during testing:

### BUG-004: Offer Success Toast Poor Contrast
When provider submits an offer, the success toast has poor color contrast making it hard to read.

### BUG-018: Push Notification Icon Blank
Push notifications display with a blank/default icon instead of the NitoAgua logo.

### BUG-019: Request Submit Flash to Step 1
After consumer submits request, there's a brief flash showing Step 1 again before redirecting. This creates a jarring UX.

## Technical Context

### Component Locations
- Toast notifications: `src/components/ui/toast.tsx` or similar
- PWA manifest: `public/manifest.json`
- Service worker: `public/sw.js`
- Request flow: `src/app/consumer/request/page.tsx`

### Root Causes
- **BUG-004:** Toast success variant using green-on-green or similar low-contrast colors
- **BUG-018:** Missing or incorrectly configured notification icon in manifest/service worker
- **BUG-019:** State reset happening before navigation, causing brief re-render

## Acceptance Criteria

### AC12.7.14.1: Toast Contrast Fix (BUG-004)
- [ ] Success toast has WCAG AA compliant contrast (4.5:1 minimum)
- [ ] Text clearly readable on success background
- [ ] Consistent with overall design system
- [ ] Test on both light and dark backgrounds

### AC12.7.14.2: Notification Icon (BUG-018)
- [ ] Push notifications display NitoAgua icon
- [ ] Icon visible on Android notification tray
- [ ] Icon correct size (192x192 recommended)
- [ ] Badge icon also configured (if supported)

### AC12.7.14.3: Request Submit Transition (BUG-019)
- [ ] No flash to Step 1 after submission
- [ ] Smooth transition to confirmation/tracking page
- [ ] Loading state shown during submission
- [ ] Form state preserved until navigation complete

## Implementation

### Fix BUG-004: Toast Contrast

Check and update toast styles:

```tsx
// In toast.tsx or toast styles
const toastVariants = {
  success: {
    // Ensure good contrast
    className: "bg-green-600 text-white border-green-700",
    // OR with darker background
    className: "bg-green-800 text-green-50 border-green-900",
  }
};
```

### Fix BUG-018: Notification Icon

1. **Update manifest.json:**

```json
{
  "icons": [
    {
      "src": "/icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

2. **Update service worker push handler:**

```javascript
self.addEventListener('push', function(event) {
  const data = event.data?.json() || {};

  const options = {
    body: data.body || 'Nueva notificaciÃ³n',
    icon: '/icons/icon-192x192.png',  // Add this
    badge: '/icons/badge-72x72.png',   // Optional badge
    vibrate: [100, 50, 100],
    data: {
      url: data.url || '/'
    }
  };

  event.waitUntil(
    self.registration.showNotification(
      data.title || 'NitoAgua',
      options
    )
  );
});
```

3. **Create badge icon if needed:**
- Size: 72x72 or 96x96
- Monochrome recommended for badge
- Place in `/public/icons/`

### Fix BUG-019: Request Submit Flash

The issue is likely state being reset before navigation. Fix by:

```tsx
// In request submission handler
const handleSubmit = async () => {
  setIsSubmitting(true);

  try {
    const result = await submitRequest(formData);

    if (result.success) {
      // Navigate BEFORE resetting state
      router.push(`/consumer/request/${result.requestId}/tracking`);
      // Don't reset form state - component will unmount
    }
  } catch (error) {
    setIsSubmitting(false);
    // Handle error
  }
  // Remove any form reset that happens after this
};
```

Alternative approach using a loading overlay:

```tsx
{isSubmitting && (
  <div className="fixed inset-0 bg-white z-50 flex items-center justify-center">
    <div className="text-center">
      <Loader2 className="w-8 h-8 animate-spin mx-auto mb-2" />
      <p>Enviando solicitud...</p>
    </div>
  </div>
)}
```

## Testing Checklist

### Toast Contrast
- [ ] Submit offer, verify toast is readable
- [ ] Check on different screen brightnesses
- [ ] Verify color meets WCAG standards

### Notification Icon
- [ ] Trigger push notification
- [ ] Verify icon shows in Android notification tray
- [ ] Verify icon shows in notification popup
- [ ] Test on multiple Android versions if possible

### Request Submit Transition
- [ ] Submit new water request
- [ ] Verify no flash to Step 1
- [ ] Verify smooth transition to tracking
- [ ] Test on slow network (throttle to 3G)

## Definition of Done

- [ ] Toast has good contrast
- [ ] Notification icon displays correctly
- [ ] No flash on request submit
- [ ] Visual QA approved
- [ ] No accessibility regressions
- [ ] Deployed to production
- [ ] Verified in Round 2 testing
