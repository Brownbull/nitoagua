# Story 12.7-5: Consumer Dispute Option - Story Context

## Technical Analysis

### Current State

**Status:** NOT IMPLEMENTED

No dispute functionality exists in the codebase. This is a new feature.

### Implementation Plan

#### 1. Database Schema

```sql
CREATE TABLE disputes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID REFERENCES water_requests(id) ON DELETE CASCADE,
  consumer_id UUID REFERENCES profiles(id),
  provider_id UUID REFERENCES profiles(id),
  reason TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'open',
  resolution TEXT,
  resolved_by UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ
);
```

#### 2. Files to Create

| File | Purpose |
|------|---------|
| `supabase/migrations/XXXXXX_create_disputes_table.sql` | Database schema |
| `src/lib/actions/disputes.ts` | Server actions |
| `src/components/consumer/dispute-dialog.tsx` | Dispute form modal |

#### 3. Integration Point

Consumer request tracking page after delivery marked complete:
- `src/app/(consumer)/request/[id]/page.tsx`

### UI Flow

```
Consumer sees "Entrega Completada"
    ↓
Option appears: "¿Hubo un problema?"
    ↓
Opens dispute dialog with:
- Reason dropdown (no delivery, wrong amount, poor quality, etc.)
- Description textarea
- Submit button
    ↓
Dispute saved, status shown to consumer
```

### Acceptance Criteria Mapping

| AC | Implementation |
|----|----------------|
| AC12.7.5.1 | Dispute option appears after delivery |
| AC12.7.5.2 | Dispute form captures reason + details |
| AC12.7.5.3 | Dispute saved to database |
| AC12.7.5.4 | Consumer sees dispute status |
