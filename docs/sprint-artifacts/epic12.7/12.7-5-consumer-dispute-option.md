# Story 12.7-5: Consumer Dispute Option

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-5 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Consumer Dispute Option |
| **Status** | drafted |
| **Priority** | P1 (High) |
| **Points** | 5 |
| **Bug Reference** | BUG-015 |

## User Story

**As a** consumer who received a delivery,
**I want** to report problems with my delivery,
**So that** I can get resolution when the service doesn't meet expectations.

## Problem Statement

When a provider marks a delivery as "Entregado" (Delivered), the consumer has NO WAY to dispute this if the delivery was NOT actually made. The provider could fraudulently mark deliveries as complete without actually delivering, and the consumer has no recourse.

```
Provider clicks "Marcar como Entregado"
         â†“
System shows "Delivered" to everyone
         â†“
Consumer: "But I never received anything!"
         â†“
âŒ No button to dispute
âŒ No way to report fraud
âŒ No escalation to admin
```

## Technical Context

### Current Flow
- Provider marks as delivered â†’ Status changes to "delivered"
- Consumer sees "Entregado" status â†’ No further actions available
- No dispute mechanism exists

### New Components Needed
- Dispute form/modal on consumer delivery details
- `disputes` database table
- Admin notification on dispute filed (see Story 12.7-6)
- Dispute status tracking

## Acceptance Criteria

### AC12.7.5.1: Dispute Option Visibility
- [ ] "Reportar problema" button visible on completed delivery details
- [ ] Button available for X hours after delivery marked complete (configurable)
- [ ] Clear visual hierarchy - not hidden, but not obstructive

### AC12.7.5.2: Dispute Types
- [ ] "No recibÃ­ mi pedido" - Never delivered (fraud risk)
- [ ] "Cantidad incorrecta" - Received less than ordered
- [ ] "LlegÃ³ tarde" - Delivered outside window
- [ ] "Mala calidad" - Water quality issues
- [ ] "Otro problema" - Free text

### AC12.7.5.3: Dispute Submission
- [ ] Consumer selects dispute type
- [ ] Optional: Add description/details
- [ ] Optional: Attach photo evidence
- [ ] Confirmation before submitting
- [ ] Success message after submission

### AC12.7.5.4: Status Updates
- [ ] Delivery status changes to "en_disputa" / "disputed"
- [ ] Consumer sees "Disputa en revisiÃ³n" status
- [ ] Admin receives notification (Story 12.7-6)
- [ ] Provider sees dispute indicator on their delivery

### AC12.7.5.5: Database Schema
- [ ] Create `disputes` table with appropriate fields
- [ ] RLS policies for consumer create, admin manage
- [ ] Audit trail for dispute lifecycle

## Database Schema

```sql
CREATE TABLE disputes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID REFERENCES water_requests(id) ON DELETE CASCADE,
  consumer_id UUID REFERENCES profiles(id),
  provider_id UUID REFERENCES profiles(id),
  dispute_type TEXT NOT NULL CHECK (dispute_type IN (
    'not_delivered',
    'wrong_quantity',
    'late_delivery',
    'quality_issue',
    'other'
  )),
  description TEXT,
  evidence_url TEXT,  -- Supabase Storage path
  status TEXT NOT NULL DEFAULT 'open' CHECK (status IN (
    'open',
    'under_review',
    'resolved_consumer',  -- Resolved in consumer's favor
    'resolved_provider',  -- Resolved in provider's favor
    'closed'
  )),
  resolution_notes TEXT,
  resolved_by UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_disputes_request_id ON disputes(request_id);
CREATE INDEX idx_disputes_status ON disputes(status);
CREATE INDEX idx_disputes_consumer_id ON disputes(consumer_id);

-- RLS
ALTER TABLE disputes ENABLE ROW LEVEL SECURITY;

-- Consumers can create disputes for their requests
CREATE POLICY "Consumers can create disputes"
  ON disputes FOR INSERT
  TO authenticated
  WITH CHECK (consumer_id = auth.uid());

-- Consumers can view their own disputes
CREATE POLICY "Consumers can view own disputes"
  ON disputes FOR SELECT
  TO authenticated
  USING (consumer_id = auth.uid());

-- Admins can manage all disputes
CREATE POLICY "Admins can manage disputes"
  ON disputes FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

## UI Design

### On Delivery Details Page

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ENTREGADO                           â”‚
â”‚                                         â”‚
â”‚  Entregado el: 30 Dic 2024, 21:15       â”‚
â”‚  Proveedor: Juan Provider               â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  âš ï¸ Â¿Hay algÃºn problema?                â”‚
â”‚                                         â”‚
â”‚  [ No recibÃ­ mi pedido ]                â”‚
â”‚  [ Cantidad incorrecta ]                â”‚
â”‚  [ Otro problema ]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dispute Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REPORTAR PROBLEMA                      â”‚
â”‚                                         â”‚
â”‚  Tipo de problema:                      â”‚
â”‚  â—‹ No recibÃ­ mi pedido                  â”‚
â”‚  â—‹ Cantidad incorrecta                  â”‚
â”‚  â—‹ LlegÃ³ tarde                          â”‚
â”‚  â—‹ Mala calidad                         â”‚
â”‚  â—‹ Otro                                 â”‚
â”‚                                         â”‚
â”‚  DescripciÃ³n (opcional):                â”‚
â”‚  [ __________________________________ ] â”‚
â”‚                                         â”‚
â”‚  ğŸ“ Adjuntar foto (opcional)            â”‚
â”‚                                         â”‚
â”‚  [ Cancelar ]  [ Enviar Reporte ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Definition of Done

- [ ] Dispute button visible on completed deliveries
- [ ] All dispute types selectable
- [ ] Dispute saved to database
- [ ] Status updates correctly
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 5.8, 5.9)
