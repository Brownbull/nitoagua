# Story 12.7-5: Consumer Dispute Option

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-5 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Consumer Dispute Option |
| **Status** | done |
| **Priority** | P1 (High) |
| **Points** | 5 |
| **Bug Reference** | BUG-015 |

## User Story

**As a** consumer who received a delivery,
**I want** to report problems with my delivery,
**So that** I can get resolution when the service doesn't meet expectations.

## Problem Statement

When a provider marks a delivery as "Entregado" (Delivered), the consumer has NO WAY to dispute this if the delivery was NOT actually made. The provider could fraudulently mark deliveries as complete without actually delivering, and the consumer has no recourse.

```
Provider clicks "Marcar como Entregado"
         â†“
System shows "Delivered" to everyone
         â†“
Consumer: "But I never received anything!"
         â†“
âŒ No button to dispute
âŒ No way to report fraud
âŒ No escalation to admin
```

## Technical Context

### Current Flow
- Provider marks as delivered â†’ Status changes to "delivered"
- Consumer sees "Entregado" status â†’ No further actions available
- No dispute mechanism exists

### New Components Needed
- Dispute form/modal on consumer delivery details
- `disputes` database table
- Admin notification on dispute filed (see Story 12.7-6)
- Dispute status tracking

## Acceptance Criteria

### AC12.7.5.1: Dispute Option Visibility
- [ ] "Reportar problema" button visible on completed delivery details
- [ ] Button available for X hours after delivery marked complete (configurable)
- [ ] Clear visual hierarchy - not hidden, but not obstructive

### AC12.7.5.2: Dispute Types
- [ ] "No recibÃ­ mi pedido" - Never delivered (fraud risk)
- [ ] "Cantidad incorrecta" - Received less than ordered
- [ ] "LlegÃ³ tarde" - Delivered outside window
- [ ] "Mala calidad" - Water quality issues
- [ ] "Otro problema" - Free text

### AC12.7.5.3: Dispute Submission
- [x] Consumer selects dispute type
- [x] Optional: Add description/details
- [ ] Optional: Attach photo evidence (DEFERRED - DB schema ready, UI deferred to future story)
- [x] Confirmation before submitting
- [x] Success message after submission

### AC12.7.5.4: Status Updates
- [ ] Delivery status changes to "en_disputa" / "disputed"
- [ ] Consumer sees "Disputa en revisiÃ³n" status
- [ ] Admin receives notification (Story 12.7-6)
- [ ] Provider sees dispute indicator on their delivery

### AC12.7.5.5: Database Schema
- [ ] Create `disputes` table with appropriate fields
- [ ] RLS policies for consumer create, admin manage
- [ ] Audit trail for dispute lifecycle

## Database Schema

```sql
CREATE TABLE disputes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID REFERENCES water_requests(id) ON DELETE CASCADE,
  consumer_id UUID REFERENCES profiles(id),
  provider_id UUID REFERENCES profiles(id),
  dispute_type TEXT NOT NULL CHECK (dispute_type IN (
    'not_delivered',
    'wrong_quantity',
    'late_delivery',
    'quality_issue',
    'other'
  )),
  description TEXT,
  evidence_url TEXT,  -- Supabase Storage path
  status TEXT NOT NULL DEFAULT 'open' CHECK (status IN (
    'open',
    'under_review',
    'resolved_consumer',  -- Resolved in consumer's favor
    'resolved_provider',  -- Resolved in provider's favor
    'closed'
  )),
  resolution_notes TEXT,
  resolved_by UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_disputes_request_id ON disputes(request_id);
CREATE INDEX idx_disputes_status ON disputes(status);
CREATE INDEX idx_disputes_consumer_id ON disputes(consumer_id);

-- RLS
ALTER TABLE disputes ENABLE ROW LEVEL SECURITY;

-- Consumers can create disputes for their requests
CREATE POLICY "Consumers can create disputes"
  ON disputes FOR INSERT
  TO authenticated
  WITH CHECK (consumer_id = auth.uid());

-- Consumers can view their own disputes
CREATE POLICY "Consumers can view own disputes"
  ON disputes FOR SELECT
  TO authenticated
  USING (consumer_id = auth.uid());

-- Admins can manage all disputes
CREATE POLICY "Admins can manage disputes"
  ON disputes FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

## UI Design

### On Delivery Details Page

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ENTREGADO                           â”‚
â”‚                                         â”‚
â”‚  Entregado el: 30 Dic 2024, 21:15       â”‚
â”‚  Proveedor: Juan Provider               â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                         â”‚
â”‚  âš ï¸ Â¿Hay algÃºn problema?                â”‚
â”‚                                         â”‚
â”‚  [ No recibÃ­ mi pedido ]                â”‚
â”‚  [ Cantidad incorrecta ]                â”‚
â”‚  [ Otro problema ]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dispute Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  REPORTAR PROBLEMA                      â”‚
â”‚                                         â”‚
â”‚  Tipo de problema:                      â”‚
â”‚  â—‹ No recibÃ­ mi pedido                  â”‚
â”‚  â—‹ Cantidad incorrecta                  â”‚
â”‚  â—‹ LlegÃ³ tarde                          â”‚
â”‚  â—‹ Mala calidad                         â”‚
â”‚  â—‹ Otro                                 â”‚
â”‚                                         â”‚
â”‚  DescripciÃ³n (opcional):                â”‚
â”‚  [ __________________________________ ] â”‚
â”‚                                         â”‚
â”‚  ğŸ“ Adjuntar foto (opcional)            â”‚
â”‚                                         â”‚
â”‚  [ Cancelar ]  [ Enviar Reporte ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Dev Notes

### Implementation Approach
- Use Server Actions pattern with `requireConsumer` guard
- Follow ActionResult<T> pattern for responses
- Apply RLS optimizations: `(select auth.uid())` vs `auth.uid()`
- Spanish UI strings, English comments per naming conventions
- Leverage existing components (Dialog, Button, Select) from shadcn/ui

### Technical References
- Similar dialog pattern: See `src/components/provider/offer-form-dialog.tsx`
- Storage upload pattern: See `src/components/provider/document-upload.tsx`
- Consumer request page: `src/app/(consumer)/request/[id]/page.tsx`

### Testing Requirements
- Use merged-fixtures import pattern
- Call `assertNoErrorState(page)` after every `page.goto()`
- Seed data per test for deterministic state
- Mobile viewport: 360x780

## Tasks

- [x] Task 1: Create disputes database migration
  - [x] 1.1: Create disputes table with schema from story
  - [x] 1.2: Create indexes for request_id, status, consumer_id
  - [x] 1.3: Add RLS policies with optimized auth.uid() pattern
  - [x] 1.4: Apply migration and verify in Supabase

- [x] Task 2: Create dispute server actions
  - [x] 2.1: Create `src/lib/actions/disputes.ts` with `createDispute` action
  - [x] 2.2: Add requireConsumer guard and ownership validation
  - [x] 2.3: Add ActionResult<T> return type
  - [x] 2.4: Validate dispute can only be filed for delivered requests

- [x] Task 3: Create DisputeDialog component
  - [x] 3.1: Create `src/components/consumer/dispute-dialog.tsx`
  - [x] 3.2: Implement dispute type selection (5 types)
  - [x] 3.3: Add optional description textarea
  - [x] 3.4: Add confirmation step before submit
  - [x] 3.5: Handle loading/error states

- [x] Task 4: Integrate dispute button on consumer request page
  - [x] 4.1: Add "Reportar problema" button to delivered requests
  - [x] 4.2: Add time window validation (configurable hours)
  - [x] 4.3: Show DisputeDialog on click
  - [x] 4.4: Update UI after dispute filed (show status)

- [x] Task 5: Create E2E tests
  - [x] 5.1: Test dispute button visibility on delivered requests
  - [x] 5.2: Test dispute type selection and submission
  - [x] 5.3: Test dispute creation in database
  - [x] 5.4: Test consumer sees dispute status
  - [x] 5.5: Test dispute button hidden after time window

- [x] Task 6: Run full validation
  - [x] 6.1: Run all E2E tests - verify no regressions
  - [x] 6.2: Run linting and type checks
  - [x] 6.3: Test build compiles successfully

## Definition of Done

- [x] Dispute button visible on completed deliveries
- [x] All dispute types selectable
- [x] Dispute saved to database
- [x] Status updates correctly
- [x] E2E tests pass (28 tests created)
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 5.8, 5.9)

## Dev Agent Record

### Implementation Plan

Implemented consumer dispute option in 6 tasks:
1. Created `disputes` table with RLS policies using optimized `(select auth.uid())` pattern
2. Added `dispute_window_hours` (48h default) to `admin_settings`
3. Created server actions with `canFileDispute` and `createDispute` functions
4. Built `DisputeDialog` component with 2-step flow (type selection + confirmation)
5. Integrated dispute section into `RequestStatusClient` for delivered requests
6. Created comprehensive E2E test suite (7 test cases across 4 browsers)

### Debug Log

**Issue 1:** TypeScript build failed - `disputes` table not recognized
- **Cause:** `database.ts` types didn't include new `disputes` table
- **Solution:** Generated types via MCP `generate_typescript_types` and updated `src/types/database.ts`

### File List

| File | Action |
|------|--------|
| supabase/migrations/20260102200000_create_disputes_table.sql | Created |
| src/types/database.ts | Modified (added disputes table types) |
| src/lib/actions/disputes.ts | Created |
| src/app/api/disputes/route.ts | Created (API route for client-side calls) |
| src/components/consumer/dispute-dialog.tsx | Created |
| src/components/consumer/request-status-client.tsx | Modified (integrated dispute UI) |
| tests/e2e/consumer-dispute.spec.ts | Created |

### Change Log

| Date | Change | Reason |
|------|--------|--------|
| 2026-01-02 | Created disputes database migration | Task 1 - Schema setup |
| 2026-01-02 | Created dispute server actions | Task 2 - Backend logic |
| 2026-01-02 | Created DisputeDialog component | Task 3 - UI component |
| 2026-01-02 | Integrated into RequestStatusClient | Task 4 - Integration |
| 2026-01-02 | Created E2E tests | Task 5 - Testing |

### Completion Notes

**Summary:** Consumer dispute option fully implemented. Consumers can now report problems with delivered orders within a configurable time window (default 48 hours).

**Key Features:**
- 5 dispute types: not_delivered, wrong_quantity, late_delivery, quality_issue, other
- 2-step confirmation flow to prevent accidental submissions
- Dispute status displayed after filing (open, under_review, resolved, etc.)
- Configurable dispute window via admin_settings

**Lessons Learned:**
1. Always regenerate TypeScript types after schema changes to avoid build failures
2. RLS policies should use `(select auth.uid())` pattern for performance
3. Use API routes for client-side calls to avoid RSC hydration errors (server actions can cause issues in client components)
4. Use `.limit(1)` not `.single()` for "maybe exists" queries - `.single()` returns 406 when no rows exist (Atlas Section 6 pattern)
5. Photo evidence UI deferred - DB schema supports it via `evidence_url` column for future enhancement

**Dependencies:** Story 12.7-6 (Admin Dispute Resolution) can now proceed - disputes table and data model are ready.
