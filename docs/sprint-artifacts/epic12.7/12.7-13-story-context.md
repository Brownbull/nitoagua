# Story 12.7-13: Rating/Review System - Story Context

## Technical Analysis

### Current State

**Status:** NOT IMPLEMENTED

Only reference found: `offer-card.tsx` may have placeholder rating display.

### Implementation Plan

#### 1. Database Schema

```sql
CREATE TABLE ratings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID REFERENCES water_requests(id) ON DELETE CASCADE,
  consumer_id UUID REFERENCES profiles(id),
  provider_id UUID REFERENCES profiles(id),
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(request_id, consumer_id)
);

-- Indexes
CREATE INDEX idx_ratings_provider_id ON ratings(provider_id);

-- Profile extensions
ALTER TABLE profiles
  ADD COLUMN IF NOT EXISTS average_rating DECIMAL(2,1) DEFAULT 0,
  ADD COLUMN IF NOT EXISTS rating_count INTEGER DEFAULT 0;

-- Trigger to update provider average
CREATE OR REPLACE FUNCTION update_provider_rating()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE profiles
  SET
    average_rating = (
      SELECT ROUND(AVG(rating)::numeric, 1)
      FROM ratings WHERE provider_id = NEW.provider_id
    ),
    rating_count = (
      SELECT COUNT(*) FROM ratings WHERE provider_id = NEW.provider_id
    )
  WHERE id = NEW.provider_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_rating_on_change
  AFTER INSERT OR UPDATE ON ratings
  FOR EACH ROW
  EXECUTE FUNCTION update_provider_rating();
```

#### 2. Files to Create

| File | Purpose |
|------|---------|
| `supabase/migrations/XXXXXX_create_ratings_table.sql` | Schema |
| `src/lib/actions/ratings.ts` | Server actions |
| `src/components/shared/rating-stars.tsx` | Star input/display |
| `src/components/consumer/rating-dialog.tsx` | Rating form |

#### 3. Integration Points

**Consumer Side:**
- After delivery complete, prompt for rating
- In delivery history, can add rating later

**Display:**
- Offer cards show provider rating
- Provider profile shows rating

### UI Components

#### Rating Input

```tsx
function RatingStars({ value, onChange, readonly = false }) {
  return (
    <div className="flex gap-1">
      {[1, 2, 3, 4, 5].map(star => (
        <Star
          key={star}
          className={star <= value ? "fill-yellow-400 text-yellow-400" : "text-gray-300"}
          onClick={() => !readonly && onChange(star)}
        />
      ))}
    </div>
  );
}
```

#### Rating Display

```tsx
function ProviderRating({ rating, count }) {
  if (!count) return <span className="text-gray-500">Sin calificaciones</span>;

  return (
    <div className="flex items-center gap-1">
      <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
      <span>{rating}</span>
      <span className="text-gray-500">({count})</span>
    </div>
  );
}
```

### Server Actions

```typescript
// ratings.ts
export async function submitRating(requestId: string, rating: number, comment?: string)
export async function updateRating(ratingId: string, rating: number, comment?: string)
export async function getProviderRating(providerId: string)
```

### Acceptance Criteria Mapping

| AC | Implementation |
|----|----------------|
| AC12.7.13.1 | Rating prompt after delivery |
| AC12.7.13.2 | 5-star selection UI |
| AC12.7.13.3 | Optional comment field |
| AC12.7.13.4 | Provider profile shows average |
| AC12.7.13.5 | Rating stored in database |
| AC12.7.13.6 | Can skip rating |
