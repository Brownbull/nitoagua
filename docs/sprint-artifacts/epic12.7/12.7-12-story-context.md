# Story 12.7-12: Commission Payment Screenshot - Story Context

## Technical Analysis

### Current State

**Partial implementation exists:**
- `src/components/admin/settlement-dashboard.tsx`
- `src/components/admin/verify-payment-modal.tsx`
- `src/components/admin/receipt-viewer-modal.tsx`

**Missing:** Provider-side screenshot upload

### Implementation Plan

#### 1. Database Table

```sql
CREATE TABLE payment_proofs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  provider_id UUID REFERENCES profiles(id),
  settlement_period TEXT NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  proof_url TEXT NOT NULL,
  status TEXT DEFAULT 'pending',
  verified_by UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  verified_at TIMESTAMPTZ
);
```

#### 2. Supabase Storage Bucket

Create bucket: `payment-proofs`
- Private (authenticated access only)
- Max file size: 5MB
- Allowed types: image/jpeg, image/png, image/webp

#### 3. Files to Create/Modify

| File | Purpose |
|------|---------|
| `src/lib/actions/payment-proofs.ts` | Upload and submit actions |
| `src/components/provider/payment-proof-upload.tsx` | Upload UI component |
| `src/app/provider/earnings/page.tsx` | Integrate upload |
| `src/components/admin/verify-payment-modal.tsx` | View uploaded proof |

### Provider Flow

```
Provider sees pending commission balance
    ↓
Clicks "Pagar Comisión"
    ↓
Upload modal opens:
- Shows amount due
- File picker for screenshot
- Preview before submit
    ↓
Submits → Proof saved → Status: pending_verification
    ↓
Admin reviews → Verifies/Rejects
```

### Server Actions

```typescript
// payment-proofs.ts
export async function uploadPaymentProof(formData: FormData) {
  // 1. Upload image to Supabase Storage
  // 2. Create payment_proofs record
  // 3. Return success
}

export async function verifyPaymentProof(proofId: string) {
  // Admin action to verify
}

export async function rejectPaymentProof(proofId: string, reason: string) {
  // Admin action to reject
}
```

### Acceptance Criteria Mapping

| AC | Implementation |
|----|----------------|
| AC12.7.12.1 | Upload button on earnings page |
| AC12.7.12.2 | File picker with preview |
| AC12.7.12.3 | Proof saved to storage |
| AC12.7.12.4 | Admin can view uploaded proof |
| AC12.7.12.5 | Admin can verify/reject |
