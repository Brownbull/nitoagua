# Story 12.7-12: Commission Payment Screenshot

| Field | Value |
|-------|-------|
| **Story ID** | 12.7-12 |
| **Epic** | Epic 12.7: Manual Testing Bug Fixes |
| **Title** | Commission Payment Screenshot |
| **Status** | drafted |
| **Priority** | P2 (Medium) |
| **Points** | 5 |
| **Bug Reference** | BUG-012 |

## User Story

**As a** provider,
**I want** to attach a screenshot of my bank transfer when paying commission,
**So that** I have proof of payment and avoid disputes.

**As an** admin,
**I want** to see payment proof from providers,
**So that** I can verify commissions were actually paid.

## Problem Statement

When a provider clicks "Pagar ComisiÃ³n", the system immediately shows "Pago Enviado" without any intermediate step. Providers cannot:
1. Attach a screenshot of the bank transfer
2. Confirm before sending notification
3. Add notes about the payment (transfer reference, etc.)

This creates trust issues - admin can't verify payment was made, disputes arise with no evidence.

## Technical Context

### Current Flow
```
Click "Pagar" â†’ Instantly shows "Pago Enviado" â†’ No proof
```

### New Flow
```
Click "Pagar" â†’ Modal with upload â†’ Confirm â†’ Success â†’ Admin sees proof
```

### Storage
- Use Supabase Storage bucket for payment screenshots
- Link to `settlements` or new `payment_proofs` table

## Acceptance Criteria

### AC12.7.12.1: Payment Confirmation Modal
- [ ] Clicking "Pagar ComisiÃ³n" opens confirmation modal
- [ ] Modal shows amount to pay
- [ ] Optional screenshot upload field
- [ ] Optional reference number field
- [ ] Cancel and Confirm buttons

### AC12.7.12.2: Screenshot Upload
- [ ] Accept image files (PNG, JPG, HEIC)
- [ ] Preview uploaded image before confirming
- [ ] Max file size: 5MB
- [ ] Upload to Supabase Storage
- [ ] Handle upload errors gracefully

### AC12.7.12.3: Payment Record
- [ ] Store screenshot URL with payment record
- [ ] Store reference number if provided
- [ ] Store timestamp of payment confirmation
- [ ] Link to original settlement/commission

### AC12.7.12.4: Admin View
- [ ] Admin can see attached screenshot
- [ ] Click to view full-size image
- [ ] Reference number visible
- [ ] Payment timestamp visible

### AC12.7.12.5: Success Feedback
- [ ] Provider sees success message after confirmation
- [ ] Payment status updates to "pending_verification"
- [ ] Admin receives notification of new payment

## Database Schema

```sql
-- Option A: Add columns to existing settlements table
ALTER TABLE settlements
  ADD COLUMN IF NOT EXISTS payment_proof_url TEXT,
  ADD COLUMN IF NOT EXISTS payment_reference TEXT,
  ADD COLUMN IF NOT EXISTS payment_submitted_at TIMESTAMPTZ;

-- Option B: Separate payment_proofs table (more flexible)
CREATE TABLE payment_proofs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  settlement_id UUID REFERENCES settlements(id) ON DELETE CASCADE,
  provider_id UUID REFERENCES profiles(id),
  proof_url TEXT NOT NULL,
  reference_number TEXT,
  notes TEXT,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'verified', 'rejected')),
  verified_by UUID REFERENCES profiles(id),
  verified_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Storage bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('payment-proofs', 'payment-proofs', false);

-- RLS: Providers can upload their own proofs
CREATE POLICY "Providers upload own proofs"
  ON storage.objects FOR INSERT
  TO authenticated
  WITH CHECK (
    bucket_id = 'payment-proofs' AND
    (storage.foldername(name))[1] = auth.uid()::text
  );

-- Admins can view all proofs
CREATE POLICY "Admins view proofs"
  ON storage.objects FOR SELECT
  TO authenticated
  USING (
    bucket_id = 'payment-proofs' AND
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid() AND role = 'admin'
    )
  );
```

## UI Design

### Payment Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONFIRMAR PAGO DE COMISIÃ“N             â”‚
â”‚                                         â”‚
â”‚  Monto: $3,000 CLP                      â”‚
â”‚                                         â”‚
â”‚  ğŸ“ Comprobante de transferencia        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  [Subir imagen]                 â”‚    â”‚
â”‚  â”‚  o arrastra aquÃ­                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚  ğŸ“ NÃºmero de referencia (opcional)     â”‚
â”‚  [ __________________________________ ] â”‚
â”‚                                         â”‚
â”‚  â„¹ï¸ El comprobante ayuda a verificar    â”‚
â”‚     tu pago mÃ¡s rÃ¡pido                  â”‚
â”‚                                         â”‚
â”‚  [ Cancelar ]  [ Confirmar Pago ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### With Image Uploaded

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONFIRMAR PAGO DE COMISIÃ“N             â”‚
â”‚                                         â”‚
â”‚  Monto: $3,000 CLP                      â”‚
â”‚                                         â”‚
â”‚  ğŸ“ Comprobante de transferencia        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚    â”‚
â”‚  â”‚  â”‚ [Screenshot]  â”‚  [âœ• Quitar] â”‚    â”‚
â”‚  â”‚  â”‚ preview.jpg   â”‚              â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚  ğŸ“ NÃºmero de referencia                â”‚
â”‚  [ 12345678                           ] â”‚
â”‚                                         â”‚
â”‚  [ Cancelar ]  [ Confirmar Pago ]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Notes

### Upload Handler

```typescript
async function uploadPaymentProof(file: File, settlementId: string) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  const fileName = `${user.id}/${settlementId}/${Date.now()}-${file.name}`;

  const { data, error } = await supabase.storage
    .from('payment-proofs')
    .upload(fileName, file);

  if (error) throw error;

  // Get public URL (or signed URL if bucket is private)
  const { data: { publicUrl } } = supabase.storage
    .from('payment-proofs')
    .getPublicUrl(fileName);

  return publicUrl;
}
```

## Definition of Done

- [ ] Modal opens on "Pagar ComisiÃ³n" click
- [ ] Image upload works
- [ ] Reference number can be added
- [ ] Confirmation required before submitting
- [ ] Proof attached to payment record
- [ ] Admin can view attached proof
- [ ] E2E tests pass
- [ ] Code review approved
- [ ] Deployed to production
- [ ] Verified in Round 2 testing (Test 7.3-7.10)
