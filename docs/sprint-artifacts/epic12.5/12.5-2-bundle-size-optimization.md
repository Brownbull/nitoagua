# Story 12.5-2: Bundle Size Optimization

| Field | Value |
|-------|-------|
| **Story ID** | 12.5-2 |
| **Epic** | Epic 12.5: Performance Optimization |
| **Title** | Bundle Size Optimization |
| **Status** | drafted |
| **Priority** | P1 (High) |
| **Points** | 8 |
| **Sprint** | Pending |

## User Story

**As a** user on any device,
**I want** pages to load quickly,
**So that** I don't wait for large JavaScript bundles to download and parse.

## Problem Statement

Large JavaScript bundles cause slow initial page loads, especially on mobile networks. Based on the tech spec, suspected issues include:
- Icon library (`lucide-react`) potentially importing entire set
- Map library (`leaflet` + `react-leaflet`) loaded on non-map pages
- Unused dependencies in bundle
- Suboptimal code splitting between routes

## Acceptance Criteria

### AC12.5.2.1: Code Splitting Verification

- [ ] Verify route-based code splitting is working correctly
- [ ] Consumer routes NOT included in provider/admin bundles
- [ ] Provider routes NOT included in consumer/admin bundles
- [ ] Admin routes NOT included in consumer/provider bundles
- [ ] Shared components in separate chunk (loaded once)
- [ ] Document current splitting behavior

### AC12.5.2.2: Dependency Audit

- [ ] Review `package.json` for unused dependencies
- [ ] Remove any dependencies not actively used
- [ ] Identify large dependencies with lighter alternatives:
  - Check if `lucide-react` tree-shakes correctly
  - Check if `date-fns` tree-shakes correctly
  - Evaluate any other large packages from baseline
- [ ] Document dependency changes with rationale

### AC12.5.2.3: Dynamic Imports for Heavy Components

- [ ] Leaflet map components use `next/dynamic` with `ssr: false`
- [ ] Map only loads on pages that use it (request form, provider map)
- [ ] Other heavy components identified and lazy-loaded:
  - `canvas-confetti` (if not already)
  - Any charts or visualizations
  - PDF generators (if any)
- [ ] Loading states shown during dynamic import

### AC12.5.2.4: Icon Optimization

- [ ] Verify `lucide-react` imports are tree-shakeable
- [ ] Use direct imports: `import { IconName } from 'lucide-react'`
- [ ] NOT barrel imports: `import * as Icons from 'lucide-react'`
- [ ] Check for any barrel re-exports in project code
- [ ] Document icon bundle contribution

### AC12.5.2.5: Measurement & Verification

- [ ] Initial bundle size reduced by **≥ 30%** from baseline
- [ ] OR documented justification if < 30% achievable
- [ ] Run bundle analyzer after changes
- [ ] Compare before/after bundle visualization
- [ ] All E2E tests pass after changes

## Tasks/Subtasks

### Task 1: Audit Current State
- [ ] 1.1 Review baseline bundle analysis from Story 12.5.1
- [ ] 1.2 Identify top optimization opportunities
- [ ] 1.3 Prioritize changes by impact/effort

### Task 2: Code Splitting Verification
- [ ] 2.1 Review Next.js build output for chunk distribution
- [ ] 2.2 Verify route groups create separate bundles
- [ ] 2.3 Fix any cross-contamination between route groups
- [ ] 2.4 Test that admin code doesn't load on consumer pages

### Task 3: Dependency Cleanup
- [ ] 3.1 Run `npm ls` to check dependency tree
- [ ] 3.2 Identify unused packages (check imports)
- [ ] 3.3 Remove unused dependencies
- [ ] 3.4 Update package-lock.json

### Task 4: Dynamic Imports
- [ ] 4.1 Audit current Leaflet imports
- [ ] 4.2 Ensure all map components use dynamic import
- [ ] 4.3 Add loading skeletons for lazy components
- [ ] 4.4 Test map pages still work correctly

### Task 5: Icon Optimization
- [ ] 5.1 Search codebase for lucide-react imports
- [ ] 5.2 Convert any barrel imports to named imports
- [ ] 5.3 Check for icon re-export patterns
- [ ] 5.4 Verify tree-shaking with bundle analyzer

### Task 6: Verification
- [ ] 6.1 Run bundle analyzer after all changes
- [ ] 6.2 Compare before/after sizes
- [ ] 6.3 Run full E2E test suite
- [ ] 6.4 Document changes and results

## Technical Notes

### Dynamic Import Pattern (Leaflet)

```typescript
// src/components/consumer/location-pinpoint.tsx
import dynamic from 'next/dynamic';

const MapComponent = dynamic(
  () => import('./map-component'),
  {
    ssr: false,
    loading: () => <MapSkeleton />
  }
);
```

### Icon Import Pattern

```typescript
// GOOD - Tree-shakeable
import { MapPin, Clock, Check } from 'lucide-react';

// BAD - Imports entire library
import * as Icons from 'lucide-react';
import Icons from 'lucide-react';
```

### Checking Bundle Impact

```bash
# Run bundle analyzer
ANALYZE=true npm run build

# Check specific package contribution
npm run build 2>&1 | grep -i "First Load JS"
```

### Route Group Structure

The app uses Next.js App Router with route groups:
- `(consumer)` - Consumer-facing pages
- `(provider)` - Provider dashboard
- `(admin)` - Admin panel

Each should have separate bundles.

## Definition of Done

- [ ] Code splitting verified and working correctly
- [ ] Unused dependencies removed
- [ ] Heavy components (maps) dynamically imported
- [ ] Icon imports optimized for tree-shaking
- [ ] Bundle size reduced ≥ 30% OR justification documented
- [ ] Before/after comparison documented
- [ ] All E2E tests pass

## Dependencies

- **Prerequisites:** Story 12.5.1 (baseline data needed)
- **Blocks:** Story 12.5.6 (validation)
- **Can Parallel:** Stories 12.5.3, 12.5.4

## Risks

| Risk | Mitigation |
|------|------------|
| Breaking lazy-loaded components | Test each change incrementally |
| Removing needed dependency | Review imports before removing |
| Dynamic imports cause UX flash | Add proper loading states |

---

_Story created 2025-12-28_
