# Story 12.5-5: Build & Development Performance

| Field | Value |
|-------|-------|
| **Story ID** | 12.5-5 |
| **Epic** | Epic 12.5: Performance Optimization |
| **Title** | Build & Development Performance |
| **Status** | done |
| **Priority** | P2 (Medium - Can Defer) |
| **Points** | 3 |
| **Sprint** | Pending |

## User Story

**As a** developer,
**I want** faster build and development cycles,
**So that** I can iterate quickly during development.

## Problem Statement

Slow build times and hot reload can significantly impact developer productivity. This story evaluates and potentially improves:
- npm install times
- Production build times
- Development server startup
- Hot reload speed

**IMPORTANT:** This does NOT affect user-facing performance. Package managers (npm, pnpm, Bun) only affect install/build time, not runtime performance. This story is lower priority than Stories 12.5.2-12.5.4.

## Acceptance Criteria

### AC12.5.5.1: Build Time Baseline

- [x] Document current production build time (`npm run build`)
- [x] Document current npm install time (clean install)
- [x] Document dev server startup time (`npm run dev`)
- [x] Document hot reload time (average file change)

### AC12.5.5.2: Dev Server Optimization

- [x] Review hot reload performance
- [x] Identify slow hot reloads (if any)
- [x] Fix configuration issues affecting dev performance
- [x] Document dev server improvements

### AC12.5.5.3: Package Manager Evaluation

- [x] Document current npm install time (clean, with lockfile)
- [x] Evaluate pnpm as alternative:
  - Install time comparison
  - Disk space usage
  - Compatibility check
- [x] Evaluate Bun as alternative:
  - Install time comparison
  - Build time comparison (if using Bun for build)
  - Compatibility check
- [x] **Implement only if > 2x faster** and no compatibility issues
- [x] Document decision with rationale

### AC12.5.5.4: Documentation

- [x] Document final build/dev times
- [x] Document package manager decision
- [x] Add any new npm scripts if tools changed

## Tasks/Subtasks

### Task 1: Baseline Measurements
- [x] 1.1 Clean npm install time (`rm -rf node_modules && npm ci`)
- [x] 1.2 Production build time (`npm run build`)
- [x] 1.3 Dev server startup (`npm run dev`)
- [x] 1.4 Hot reload time (average of 5 file changes)

### Task 2: Dev Server Review
- [x] 2.1 Check for slow hot reloads
- [x] 2.2 Review next.config.js for issues
- [x] 2.3 Check TypeScript config for dev impact
- [x] 2.4 Fix any identified issues

### Task 3: Package Manager Evaluation
- [x] 3.1 Test pnpm install time
- [x] 3.2 Test Bun install time
- [x] 3.3 Compare results
- [x] 3.4 Check compatibility (install warnings review)
- [x] 3.5 Document findings

### Task 4: Implementation (if warranted)
- [x] 4.1 Migrate to chosen package manager (if different)
- [x] 4.2 Update CI/CD configuration
- [x] 4.3 Update documentation
- [x] 4.4 Verify all scripts work

### Task 5: Documentation
- [x] 5.1 Document final metrics
- [x] 5.2 Document decision rationale
- [x] 5.3 Update README if package manager changed

## Technical Notes

### Package Manager Comparison Commands

```bash
# npm (current)
rm -rf node_modules package-lock.json
time npm install

# pnpm
rm -rf node_modules pnpm-lock.yaml
time pnpm install

# Bun
rm -rf node_modules bun.lockb
time bun install
```

### Expected Improvements

| Tool | Install Speed | Notes |
|------|---------------|-------|
| npm | Baseline | Current |
| pnpm | ~2-3x faster | Uses hard links, saves disk |
| Bun | ~5-10x faster | Written in Zig, very fast |

### Compatibility Considerations

**pnpm:**
- Works with most npm packages
- May need `shamefully-hoist=true` for some packages
- Different lockfile format

**Bun:**
- Still maturing, some compatibility gaps
- May not work with all npm scripts
- Requires Bun runtime installed

### Build Optimization (if needed)

```javascript
// next.config.js - skip type checking in build (faster, but risky)
// Only if TypeScript errors are caught in CI separately
module.exports = {
  typescript: {
    ignoreBuildErrors: true,
  },
};
```

### Hot Reload Issues to Check

- Large files in `app/` directory
- Circular imports
- Heavy middleware
- Many dynamic routes

## Definition of Done

- [x] Build time baseline documented
- [x] Dev server reviewed and optimized
- [x] Package manager evaluated (pnpm, Bun)
- [x] Decision documented with rationale
- [x] If changed: CI/CD updated, docs updated
- [x] All tests pass with final configuration

## Dependencies

- **Prerequisites:** Story 12.5.1 (context)
- **Blocks:** Story 12.5.6 (validation)
- **Can Parallel:** Stories 12.5.2, 12.5.3, 12.5.4
- **Can Defer:** This story can be skipped if time-constrained

## Risks

| Risk | Mitigation |
|------|------------|
| Package manager breaks builds | Test thoroughly before switching |
| CI/CD compatibility issues | Test in CI before merging |
| Bun immaturity | Stick with pnpm if Bun has issues |

## Notes

This story is **P2 (lower priority)** because:
1. It only affects developer experience, not users
2. Current npm performance may be acceptable
3. Switching package managers has migration risk

Consider deferring if time-constrained. The user-facing optimizations (12.5.2, 12.5.3, 12.5.4) should take priority.

---

## Dev Agent Record

### Measurements Collected (2025-12-29)

| Metric | npm | pnpm | Bun |
|--------|-----|------|-----|
| **Clean Install** | 85.6s | 38.9s | 41.2s |
| **Production Build** | 20.3s | - | - |
| **Dev Server Startup** | 954ms | - | - |
| **Hot Reload** | <100ms | - | - |

### Dev Server Analysis

- **Startup Time:** 954ms (excellent - under 1 second)
- **Next.js Version:** 16.0.7 with Turbopack
- **Circular Dependencies:** None detected
- **Largest Files:** 771 lines (settlement-dashboard.tsx) - reasonable
- **TypeScript Config:** Already optimized (`skipLibCheck: true`, `incremental: true`)

### Package Manager Comparison

| Tool | Speed vs npm | Compatibility Issues |
|------|--------------|---------------------|
| **pnpm** | 2.2x faster | supabase binary warning, blocked build scripts |
| **Bun** | 2.1x faster | 2 blocked postinstalls |

### Decision: Keep npm

**Rationale:**
1. Both alternatives only barely meet the 2x threshold (2.2x and 2.1x)
2. Both have minor compatibility warnings
3. Dev server is already excellent (<1s startup)
4. Build time is acceptable (20s)
5. Migration risk outweighs benefits (CI/CD changes, lockfile migration)
6. Story notes explicitly state this is P2 and can be deferred

**Conclusion:** The current npm setup is performant enough. No changes needed.

### Completion Notes

- All baseline measurements documented
- Dev server reviewed - no issues found
- Package managers evaluated - both faster but migration not warranted
- Decision documented with clear rationale
- No CI/CD or README updates needed (keeping npm)

### File List

| File | Change |
|------|--------|
| `docs/sprint-artifacts/epic12.5/12.5-5-build-development-performance.md` | Story documentation |
| `.gitignore` | Added `bun.lock` and `pnpm-lock.yaml` to prevent test artifacts from being committed |
| `package-lock.json` | Minor ESLint dependency updates from `npm install` during baseline testing |

### Code Review Fixes (2025-12-29)

- Removed `bun.lock` test artifact (241KB)
- Added `bun.lock` and `pnpm-lock.yaml` to `.gitignore`
- Clarified Task 3.4: "install warnings review" instead of "run E2E tests" (E2E not run, compatibility assessed via install warnings)
- Added File List section per BMAD standards

---

_Story created 2025-12-28_
_Completed 2025-12-29_
