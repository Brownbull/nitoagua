# Story 12.6-2: Session Handling Audit Across All Roles

| Field | Value |
|-------|-------|
| **Story ID** | 12.6-2 |
| **Epic** | Epic 12.6: Auth Session Reliability |
| **Title** | Session Handling Audit Across All Roles |
| **Status** | drafted |
| **Priority** | P1 (High - Prevents future bugs) |
| **Points** | 3 |
| **Sprint** | Current |

## User Story

**As a** developer,
**I want** all server actions across admin, consumer, and provider roles to handle stale sessions consistently,
**So that** users in any role get graceful session expiry handling instead of confusing errors.

## Problem Statement

Story 12.6-1 fixes the push notification toggle, but the same stale session issue could affect **any server action** in the app. We need to:

1. Audit all server actions to identify which ones have auth checks
2. Apply the session validation pattern consistently
3. Update error responses to use `requiresLogin` flag
4. Ensure all roles (admin, consumer, provider) are covered

## Scope

### Consumer Actions (src/lib/actions/)
- `request.ts` - Create/cancel water requests
- `offer-selection.ts` - Accept/reject offers
- `push-subscription.ts` - Already fixed in 12.6-1

### Provider Actions (src/lib/actions/)
- `offers.ts` - Submit/withdraw offers
- `delivery.ts` - Mark as delivered
- `provider-profile.ts` - Update profile, documents
- `service-areas.ts` - Update service areas
- `settlement.ts` - Request withdrawal

### Admin Actions (src/lib/actions/)
- `admin.ts` - Verification approve/reject
- `admin-settings.ts` - Update settings
- `orders.ts` - Order management

## Acceptance Criteria

### AC12.6.2.1: Audit All Server Actions

- [ ] List all server actions with auth checks
- [ ] Categorize by role: admin, consumer, provider
- [ ] Identify current error handling pattern for each
- [ ] Document which actions could have stale session issues

### AC12.6.2.2: Consumer Actions Update

- [ ] Update `createWaterRequest()` - return `requiresLogin` on auth failure
- [ ] Update `cancelRequest()` - return `requiresLogin` on auth failure
- [ ] Update `selectOffer()` - return `requiresLogin` on auth failure
- [ ] Update consumer profile actions if any

### AC12.6.2.3: Provider Actions Update

- [ ] Update `createOffer()` - return `requiresLogin` on auth failure
- [ ] Update `withdrawOffer()` - return `requiresLogin` on auth failure
- [ ] Update `markDelivered()` - return `requiresLogin` on auth failure
- [ ] Update `updateProviderProfile()` - return `requiresLogin` on auth failure
- [ ] Update `requestWithdrawal()` - return `requiresLogin` on auth failure

### AC12.6.2.4: Admin Actions Update

- [ ] Update `approveProvider()` - return `requiresLogin` on auth failure
- [ ] Update `rejectProvider()` - return `requiresLogin` on auth failure
- [ ] Update admin settings actions
- [ ] Update order management actions

### AC12.6.2.5: Standardize Error Response Type

- [ ] Create shared `ActionResult<T>` type with `requiresLogin` flag
- [ ] Apply to all server actions consistently
- [ ] Document pattern in project-context.md or architecture

## Technical Approach

### Standard Action Result Type

```typescript
// src/lib/actions/types.ts
export type ActionResult<T> =
  | { success: true; data: T }
  | { success: false; error: string; requiresLogin?: boolean };

// Usage in any action
export async function someAction(): Promise<ActionResult<SomeData>> {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { success: false, error: "Session expired", requiresLogin: true };
  }

  // ... action logic
}
```

### Client-Side Handler

```typescript
// src/lib/utils/action-handler.ts
import { useRouter } from "next/navigation";

export function useActionHandler() {
  const router = useRouter();

  async function handleAction<T>(
    action: () => Promise<ActionResult<T>>,
    options?: { returnTo?: string }
  ): Promise<T | null> {
    const result = await action();

    if (!result.success) {
      if (result.requiresLogin) {
        const returnTo = options?.returnTo || window.location.pathname;
        router.push(`/login?returnTo=${encodeURIComponent(returnTo)}&expired=true`);
        return null;
      }
      // Handle other errors
      toast.error(result.error);
      return null;
    }

    return result.data;
  }

  return { handleAction };
}
```

## Tasks/Subtasks

### Task 1: Audit Server Actions
- [ ] 1.1 List all files in `src/lib/actions/`
- [ ] 1.2 Document each action's current auth pattern
- [ ] 1.3 Identify actions missing auth checks (if any)
- [ ] 1.4 Create audit report

### Task 2: Create Shared Types
- [ ] 2.1 Create `src/lib/actions/types.ts`
- [ ] 2.2 Define `ActionResult<T>` type
- [ ] 2.3 Create `useActionHandler` hook
- [ ] 2.4 Document usage pattern

### Task 3: Update Consumer Actions
- [ ] 3.1 Update request actions
- [ ] 3.2 Update offer selection actions
- [ ] 3.3 Update any profile actions
- [ ] 3.4 Test consumer flows

### Task 4: Update Provider Actions
- [ ] 4.1 Update offer actions
- [ ] 4.2 Update delivery actions
- [ ] 4.3 Update profile/document actions
- [ ] 4.4 Update settlement actions
- [ ] 4.5 Test provider flows

### Task 5: Update Admin Actions
- [ ] 5.1 Update verification actions
- [ ] 5.2 Update settings actions
- [ ] 5.3 Update order actions
- [ ] 5.4 Test admin flows

### Task 6: Update Components
- [ ] 6.1 Update consumer components to use `useActionHandler`
- [ ] 6.2 Update provider components
- [ ] 6.3 Update admin components
- [ ] 6.4 Verify redirect flow works

## Definition of Done

- [ ] All server actions return consistent `ActionResult<T>` type
- [ ] All auth failures return `requiresLogin: true`
- [ ] Components handle `requiresLogin` with redirect
- [ ] No "you need to be logged in" error messages anywhere
- [ ] All three roles tested: admin, consumer, provider
- [ ] Pattern documented for future actions

## Dependencies

- **Prerequisites:** Story 12.6-1 (establishes the pattern)
- **Related:** All authenticated features
- **Affects:** Every server action in the app

## Files to Modify

### Create
- `src/lib/actions/types.ts` - Shared action result types
- `src/lib/hooks/use-action-handler.ts` - Client-side handler hook

### Modify (Audit Required)
- `src/lib/actions/request.ts`
- `src/lib/actions/offers.ts`
- `src/lib/actions/delivery.ts`
- `src/lib/actions/provider-profile.ts`
- `src/lib/actions/service-areas.ts`
- `src/lib/actions/settlement.ts`
- `src/lib/actions/admin.ts`
- `src/lib/actions/admin-settings.ts`
- `src/lib/actions/orders.ts`
- Various components that call these actions

## Success Metrics

- Consistent session handling across 100% of server actions
- Zero role-specific "need to be logged in" errors
- All roles redirect to login gracefully on session expiry
- Pattern documented and easy to follow for new actions

---

_Story created 2025-12-29_
_Depends on: Story 12.6-1 (establishes the session validation pattern)_
