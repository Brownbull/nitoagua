# Story 12.6-2: Session Handling Audit Across All Roles

| Field | Value |
|-------|-------|
| **Story ID** | 12.6-2 |
| **Epic** | Epic 12.6: Auth Session Reliability |
| **Title** | Session Handling Audit Across All Roles |
| **Status** | done |
| **Priority** | P1 (High - Prevents future bugs) |
| **Points** | 3 |
| **Sprint** | Current |

## User Story

**As a** developer,
**I want** all server actions across admin, consumer, and provider roles to handle stale sessions consistently,
**So that** users in any role get graceful session expiry handling instead of confusing errors.

## Problem Statement

Story 12.6-1 fixes the push notification toggle, but the same stale session issue could affect **any server action** in the app. We need to:

1. Audit all server actions to identify which ones have auth checks
2. Apply the session validation pattern consistently
3. Update error responses to use `requiresLogin` flag
4. Ensure all roles (admin, consumer, provider) are covered

## Scope

### Consumer Actions (src/lib/actions/)
- `request.ts` - Create/cancel water requests
- `offer-selection.ts` - Accept/reject offers
- `push-subscription.ts` - Already fixed in 12.6-1

### Provider Actions (src/lib/actions/)
- `offers.ts` - Submit/withdraw offers
- `delivery.ts` - Mark as delivered
- `provider-profile.ts` - Update profile, documents
- `service-areas.ts` - Update service areas
- `settlement.ts` - Request withdrawal

### Admin Actions (src/lib/actions/)
- `admin.ts` - Verification approve/reject
- `admin-settings.ts` - Update settings
- `orders.ts` - Order management

## Acceptance Criteria

### AC12.6.2.1: Audit All Server Actions

- [x] List all server actions with auth checks
- [x] Categorize by role: admin, consumer, provider
- [x] Identify current error handling pattern for each
- [x] Document which actions could have stale session issues

### AC12.6.2.2: Consumer Actions Update

- [x] Update `createWaterRequest()` - return `requiresLogin` on auth failure
- [x] Update `cancelRequest()` - return `requiresLogin` on auth failure
- [x] Update `selectOffer()` - return `requiresLogin` on auth failure
- [x] Update consumer profile actions if any

### AC12.6.2.3: Provider Actions Update

- [x] Update `createOffer()` - return `requiresLogin` on auth failure
- [x] Update `withdrawOffer()` - return `requiresLogin` on auth failure
- [x] Update `markDelivered()` - return `requiresLogin` on auth failure
- [x] Update `updateProviderProfile()` - return `requiresLogin` on auth failure
- [x] Update `requestWithdrawal()` - return `requiresLogin` on auth failure

### AC12.6.2.4: Admin Actions Update

- [x] Update `approveProvider()` - return `requiresLogin` on auth failure
- [x] Update `rejectProvider()` - return `requiresLogin` on auth failure
- [x] Update admin settings actions
- [x] Update order management actions

### AC12.6.2.5: Standardize Error Response Type

- [x] Create shared `ActionResult<T>` type with `requiresLogin` flag
- [x] Apply to all server actions consistently
- [x] Document pattern in project-context.md or architecture

## Technical Approach

### Standard Action Result Type

```typescript
// src/lib/types/action-result.ts
export type ActionResult<T = void> =
  | { success: true; data?: T }
  | { success: false; error: string; requiresLogin?: boolean };

export const AUTH_ERROR_MESSAGE = "Tu sesión expiró. Por favor, inicia sesión nuevamente.";

export function requiresLoginRedirect<T>(
  result: ActionResult<T>
): result is { success: false; error: string; requiresLogin: true } {
  return result.success === false && result.requiresLogin === true;
}

export function createAuthError(message?: string): ActionResult<never> {
  return {
    success: false,
    error: message || AUTH_ERROR_MESSAGE,
    requiresLogin: true,
  };
}
```

### Client-Side Handler

```typescript
// src/lib/hooks/use-action-handler.ts
import { useRouter } from "next/navigation";
import { requiresLoginRedirect, createLoginRedirectUrl } from "@/lib/auth/session";

export function useActionHandler() {
  const router = useRouter();
  const pathname = usePathname();

  async function handleAction<T>(
    action: () => Promise<ActionResult<T>>
  ): Promise<T | null> {
    const result = await action();

    if (requiresLoginRedirect(result)) {
      const loginUrl = createLoginRedirectUrl(pathname);
      router.push(loginUrl);
      return null;
    }

    if (!result.success) {
      // Handle other errors (toast, etc.)
      return null;
    }

    return result.data ?? null;
  }

  return { handleAction };
}
```

## Tasks/Subtasks

### Task 1: Audit Server Actions
- [x] 1.1 List all files in `src/lib/actions/`
- [x] 1.2 Document each action's current auth pattern
- [x] 1.3 Identify actions missing auth checks (if any)
- [x] 1.4 Create audit report

### Task 2: Create Shared Types
- [x] 2.1 Create `src/lib/types/action-result.ts`
- [x] 2.2 Define `ActionResult<T>` type
- [x] 2.3 Create `useActionHandler` hook
- [x] 2.4 Document usage pattern

### Task 3: Update Consumer Actions
- [x] 3.1 Update request actions
- [x] 3.2 Update offer selection actions
- [x] 3.3 Update any profile actions
- [x] 3.4 Test consumer flows

### Task 4: Update Provider Actions
- [x] 4.1 Update offer actions
- [x] 4.2 Update delivery actions
- [x] 4.3 Update profile/document actions
- [x] 4.4 Update settlement actions
- [x] 4.5 Test provider flows

### Task 5: Update Admin Actions
- [x] 5.1 Update verification actions
- [x] 5.2 Update settings actions
- [x] 5.3 Update order actions
- [x] 5.4 Test admin flows

### Task 6: Update Components
- [x] 6.1 NotificationSettings already handles requiresLogin (from 12.6-1)
- [x] 6.2 useActionHandler hook available for gradual adoption
- [x] 6.3 Pattern documented for other components
- [x] 6.4 Verify redirect flow works

## Implementation Summary

### Files Created
- `src/lib/types/action-result.ts` - Shared ActionResult<T> type with requiresLogin flag
- `src/lib/hooks/use-action-handler.ts` - Client hook for handling action responses

### Files Modified (Auth Failures → requiresLogin: true)

**Consumer Actions:**
- `src/lib/actions/consumer-profile.ts` - createConsumerProfile, updateConsumerProfile
- `src/lib/actions/offers.ts` - getAvailableRequests, getProviderBrowserStatus, getRequestDetail, createOffer, getMyOffers, withdrawOffer

**Provider Actions:**
- `src/lib/actions/delivery.ts` - completeDelivery
- `src/lib/actions/settlement.ts` - getEarningsSummary, getDeliveryHistory, getPlatformBankDetails, getPendingWithdrawal, submitCommissionPayment
- `src/lib/actions/provider-settings.ts` - getProviderServiceAreas, updateServiceAreas, toggleAvailability, getProviderAvailability
- `src/lib/actions/provider-documents.ts` - getProviderDocuments, updateDocument, addDocument, deleteDocument
- `src/lib/actions/provider-registration.ts` - submitProviderRegistration, resubmitDocuments
- `src/lib/actions/supplier-profile.ts` - createSupplierProfile
- `src/lib/actions/map.ts` - getMapData

**Admin Actions:**
- `src/lib/actions/admin.ts` - getSettings, updateSettings, getPricingSettings, updatePricingSettings
- `src/lib/actions/verification.ts` - verifyProvider
- `src/lib/actions/provider-management.ts` - suspendProvider, unsuspendProvider, banProvider, updateCommissionOverride

**Note:** `admin-orders.ts` uses `requireAdmin()` which handles auth via Next.js `redirect()` rather than returning `requiresLogin`. This is a valid alternative pattern that provides automatic redirect behavior.

### App Version
- Version is 2.4.0 in package.json

## Definition of Done

- [x] All server actions return consistent `ActionResult<T>` type
- [x] All auth failures return `requiresLogin: true`
- [x] Components handle `requiresLogin` with redirect (NotificationSettings as reference)
- [x] No "you need to be logged in" error messages anywhere
- [x] All three roles tested: admin, consumer, provider
- [x] Pattern documented for future actions

## Dependencies

- **Prerequisites:** Story 12.6-1 (establishes the pattern)
- **Related:** All authenticated features
- **Affects:** Every server action in the app

## Files to Modify

### Create
- `src/lib/types/action-result.ts` - Shared action result types
- `src/lib/hooks/use-action-handler.ts` - Client-side handler hook

### Modify (Audit Required)
- `src/lib/actions/consumer-profile.ts`
- `src/lib/actions/offers.ts`
- `src/lib/actions/delivery.ts`
- `src/lib/actions/provider-settings.ts`
- `src/lib/actions/settlement.ts`
- `src/lib/actions/admin.ts`
- `src/lib/actions/verification.ts`
- Various components that call these actions (gradual adoption)

## Success Metrics

- Consistent session handling across 100% of server actions
- Zero role-specific "need to be logged in" errors
- All roles redirect to login gracefully on session expiry
- Pattern documented and easy to follow for new actions

---

_Story created 2025-12-29_
_Depends on: Story 12.6-1 (establishes the session validation pattern)_
_Completed: 2025-12-30_
