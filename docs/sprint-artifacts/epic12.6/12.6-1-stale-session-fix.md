# Story 12.6-1: Fix Stale Session on Server Actions

| Field | Value |
|-------|-------|
| **Story ID** | 12.6-1 |
| **Epic** | Epic 12.6: Auth Session Reliability |
| **Title** | Fix Stale Session on Server Actions |
| **Status** | done |
| **Priority** | P0 (Critical - User-reported bug) |
| **Points** | 5 |
| **Sprint** | Current |

## User Story

**As a** registered user returning to the app after some idle time,
**I want** my session to be validated and refreshed automatically,
**So that** I don't see confusing "you need to be logged in" errors when I try to take actions.

## Problem Statement

Users report that after opening the app on mobile (PWA) and navigating around, they get "Debes iniciar sesión para activar notificaciones push" errors when trying to toggle notifications - even though they appear to be logged in.

**Root Cause Analysis:**
1. Middleware refreshes tokens on **page navigation** only
2. Server actions bypass middleware and use potentially **stale cookies**
3. Access token expires after 24 hours, but client UI doesn't know
4. User appears logged in (cached state) but server sees expired session

**Reproduction Steps:**
1. Log in to app on mobile
2. Navigate around (works fine - middleware refreshes tokens)
3. Leave app idle for some time (or close and reopen after hours)
4. Try to toggle push notifications
5. Error: "Debes iniciar sesión para activar notificaciones push"
6. Logging out and back in fixes it

## Acceptance Criteria

### AC12.6.1.1: Session Validation Before Actions

- [x] Create `validateSession()` utility that checks if session is valid
- [x] If session expired but refresh token valid, trigger token refresh
- [x] If session completely invalid, redirect to login page
- [x] Client-side utility for proactive refresh (server actions use `getUser()` directly)

### AC12.6.1.2: Push Subscription Action Fix

- [x] Update `subscribeToPush()` to handle session refresh
- [x] Update `unsubscribeFromPush()` similarly
- [x] On auth failure, return `{ success: false, requiresLogin: true }`
- [x] Component redirects to login when `requiresLogin` is true

### AC12.6.1.3: Client-Side Session Monitoring

- [x] Add session expiry check to `useAuth()` hook
- [x] Proactively refresh tokens before they expire (e.g., at 23 hours)
- [x] Update client state when tokens are refreshed
- [x] Consider `visibilitychange` event to refresh on app resume

### AC12.6.1.4: Graceful Error Handling

- [x] Instead of error message, redirect to login with return URL
- [x] After login, user returns to where they were
- [x] Show toast: "Tu sesión expiró. Por favor, inicia sesión nuevamente."
- [x] No confusing "you need to be logged in" errors on protected pages

### AC12.6.1.5: E2E Test Coverage

- [x] Test: Session expires → action fails → redirect to login
- [x] Test: After login redirect, user returns to original page
- [x] Test: Token refresh happens automatically before expiry
- [x] Test: App resume (visibility change) triggers session check

## Technical Approach

### Option A: Proactive Token Refresh (Recommended)

```typescript
// src/lib/auth/session.ts
export async function ensureValidSession(): Promise<boolean> {
  const supabase = createClient();

  // Force token refresh if needed
  const { data: { session }, error } = await supabase.auth.getSession();

  if (error || !session) {
    // Session invalid - needs re-login
    return false;
  }

  // Check if token expires soon (within 5 minutes)
  const expiresAt = session.expires_at ? session.expires_at * 1000 : 0;
  const fiveMinutes = 5 * 60 * 1000;

  if (Date.now() > expiresAt - fiveMinutes) {
    // Proactively refresh
    const { error: refreshError } = await supabase.auth.refreshSession();
    if (refreshError) return false;
  }

  return true;
}
```

### Option B: Visibility Change Handler

```typescript
// In useAuth hook or AuthProvider
useEffect(() => {
  const handleVisibilityChange = async () => {
    if (document.visibilityState === 'visible') {
      // App resumed - validate session
      const supabase = createClient();
      const { data: { user } } = await supabase.auth.getUser();

      if (!user && currentUser) {
        // Was logged in, now not - redirect to login
        router.push('/login?expired=true');
      }
    }
  };

  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
}, [currentUser]);
```

### Option C: Server Action Wrapper

```typescript
// src/lib/auth/action-wrapper.ts
export function withAuth<T>(
  action: (userId: string, ...args: any[]) => Promise<T>
) {
  return async (...args: any[]): Promise<T | { requiresLogin: true }> => {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      return { requiresLogin: true };
    }

    return action(user.id, ...args);
  };
}
```

## Tasks/Subtasks

### Task 1: Session Validation Utility
- [x] 1.1 Create `src/lib/auth/session.ts`
- [x] 1.2 Implement `ensureValidSession()` function
- [x] 1.3 Add proactive refresh logic (5-minute buffer)
- [x] 1.4 Client-side implementation (server actions use `getUser()` directly)

### Task 2: Update useAuth Hook
- [x] 2.1 Add visibility change listener
- [x] 2.2 Add periodic session check (every 5 minutes when active)
- [x] 2.3 Update user state when session changes
- [x] 2.4 Trigger redirect on session expiry

### Task 3: Fix Push Subscription Actions
- [x] 3.1 Update `subscribeToPush()` return type
- [x] 3.2 Update `unsubscribeFromPush()` return type
- [x] 3.3 Add `requiresLogin` flag to responses
- [x] 3.4 Update `NotificationSettings` component to handle redirect

### Task 4: Login Redirect Flow
- [x] 4.1 Add `returnTo` query param support to login page
- [x] 4.2 After successful login, redirect to `returnTo` URL
- [x] 4.3 Add toast message for session expiry
- [x] 4.4 Test full redirect flow

### Task 5: E2E Tests
- [x] 5.1 Create `tests/e2e/session-expiry.spec.ts`
- [x] 5.2 Test session expiry detection
- [x] 5.3 Test login redirect with return URL
- [x] 5.4 Test visibility change refresh

## Definition of Done

- [x] No more "you need to be logged in" errors on protected actions
- [x] Session automatically refreshes before expiry
- [x] Expired sessions redirect to login gracefully
- [x] After re-login, user returns to where they were
- [x] E2E tests pass for session management
- [x] Works on mobile PWA (visibility change events)

## Dependencies

- **Prerequisites:** None
- **Related:** Epic 12 Story 12-6 (Push Notifications)
- **Affects:** All authenticated server actions

## Files to Modify

### Create
- `src/lib/auth/session.ts` - Session validation utilities
- `src/components/auth/session-expired-toast.tsx` - Toast component for expired session
- `tests/e2e/session-expiry.spec.ts` - E2E tests for session handling

### Modify
- `src/hooks/use-auth.ts` - Add visibility change handler, session monitoring
- `src/lib/actions/push-subscription.ts` - Add `requiresLogin` return type
- `src/components/shared/notification-settings.tsx` - Handle login redirect
- `src/app/(auth)/login/page.tsx` - Handle `returnTo` and `expired` query params
- `src/app/auth/callback/route.ts` - Handle `returnTo` redirect after OAuth
- `src/components/auth/google-sign-in.tsx` - Pass `returnTo` to OAuth callback

## Success Metrics

- Zero "need to be logged in" errors when user appears logged in
- Session refresh happens automatically (no user action needed)
- Clean redirect flow when session truly expires
- Mobile PWA works reliably after app resume

---

_Story created 2025-12-29_
_Root cause: Token refresh only on navigation, not on server actions_
