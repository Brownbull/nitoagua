# Story 12.8-3: Provider "Mis Ofertas" Fix

| Field | Value |
|-------|-------|
| **Story ID** | 12.8-3 |
| **Epic** | Epic 12.8: Round 2 Manual Testing Bug Fixes |
| **Title** | Provider "Mis Ofertas" Fix |
| **Status** | backlog |
| **Priority** | P2 (Medium) |
| **Points** | 5 |
| **Bug References** | BUG-R2-009, BUG-R2-018 |

## User Story

**As a** water delivery provider,
**I want** my "Mis Ofertas" page to show only active deliveries with correct status,
**So that** I can focus on pending work without seeing completed deliveries.

## Problem Statement

### BUG-R2-009: Wrong Default Filter and Status Display

The Provider's "Mis Ofertas" page has two issues:
1. **Default filter applied:** Page loads with a status filter pre-selected, hiding some offers
2. **Wrong status displayed:** Completed deliveries show "Aceptada" instead of actual status

### BUG-R2-018: Completed Deliveries Still Visible

After completing a delivery, the offer continues to appear in the "Mis Ofertas" list as an active delivery. It should be hidden or moved to a history section.

### Root Cause

Both bugs stem from the same issue: **using `offers.status` instead of `water_requests.status`**

- `offers.status` = 'accepted' → Never changes after consumer accepts
- `water_requests.status` = 'in_transit', 'delivered', etc. → Updated during delivery flow

The UI displays `offers.status` when it should display `water_requests.status` for the actual delivery state.

**Screenshot showed:** "Estado 1" filter with 2 offers, both showing "Aceptada" even though one was delivered.

## Technical Context

### Current Query (Suspected)

```typescript
// Current: Only looks at offers.status
const { data: offers } = await supabase
  .from("offers")
  .select("*, request:water_requests(*)")
  .eq("supplier_id", userId)
  .eq("status", "accepted");  // Only gets accepted offers
  // Does NOT filter by water_requests.status
```

### Files to Modify

| File | Current Issue | Required Change |
|------|--------------|-----------------|
| `src/app/provider/offers/page.tsx` | Pre-selected filter, shows all | Remove default filter, filter out delivered |
| `src/lib/actions/offers.ts` | Query returns all accepted | Filter by water_requests.status |
| `src/components/provider/offer-card.tsx` | Shows offers.status | Show water_requests.status |

## Acceptance Criteria

### AC12.8.3.1: No Default Filter on Page Load
**Given** a provider navigating to "Mis Ofertas"
**When** the page loads
**Then** no status filter is pre-selected
**And** the provider sees all relevant offers immediately

### AC12.8.3.2: Hide Completed Deliveries
**Given** an offer where the associated water request has status "delivered"
**When** the provider views "Mis Ofertas"
**Then** that offer is NOT visible in the list
**And** only active offers (accepted, in_transit) are shown

### AC12.8.3.3: Hide Cancelled Requests
**Given** an offer where the associated water request has status "cancelled"
**When** the provider views "Mis Ofertas"
**Then** that offer is NOT visible in the list

### AC12.8.3.4: Correct Status Display
**Given** an offer in the active list
**When** the status badge is rendered
**Then** it shows the water_requests.status, not offers.status
**And** "En Camino" shows for in_transit, "Pendiente" for accepted, etc.

### AC12.8.3.5: Status Filter Works Correctly
**Given** offers with different water_requests.status values
**When** the provider selects a status filter
**Then** only offers matching that water_requests.status are shown
**And** the filter counts reflect water_requests.status, not offers.status

### AC12.8.3.6: Real-Time Updates
**Given** a provider viewing "Mis Ofertas"
**When** a delivery status changes (e.g., accepted → in_transit → delivered)
**Then** the list updates automatically
**And** completed deliveries disappear from the list

## Implementation

### Step 1: Update Offers Query

```typescript
// src/lib/actions/offers.ts

/**
 * Get provider's active offers (accepted, not yet delivered)
 */
export async function getProviderActiveOffers(
  userId: string
): Promise<OfferWithRequest[]> {
  const supabase = await createClient();

  const { data: offers, error } = await supabase
    .from("offers")
    .select(`
      *,
      request:water_requests!inner(
        id,
        status,
        created_at,
        liters,
        address,
        comuna,
        consumer_id,
        consumer:profiles!consumer_id(name, phone)
      )
    `)
    .eq("supplier_id", userId)
    .eq("status", "accepted")
    // Filter by water_requests.status - only show active deliveries
    .not("request.status", "in", "(delivered,cancelled)")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("[Offers] Error fetching active offers:", error);
    return [];
  }

  return offers || [];
}
```

### Step 2: Update Offer Card Status Display

```typescript
// src/components/provider/offer-card.tsx

interface OfferCardProps {
  offer: {
    id: string;
    status: string;  // offers.status (always 'accepted' for shown items)
    request: {
      id: string;
      status: string;  // water_requests.status (actual delivery state)
      // ... other fields
    };
  };
}

export function OfferCard({ offer }: OfferCardProps) {
  // Use water_requests.status for display, not offers.status
  const deliveryStatus = offer.request?.status || offer.status;

  // Status label mapping
  const statusLabels: Record<string, string> = {
    accepted: "Aceptada",
    in_transit: "En Camino",
    delivered: "Entregada",  // Should not appear due to filter
    pending: "Pendiente",
  };

  // Status color mapping
  const statusColors: Record<string, string> = {
    accepted: "bg-blue-100 text-blue-800",
    in_transit: "bg-amber-100 text-amber-800",
    delivered: "bg-green-100 text-green-800",
    pending: "bg-gray-100 text-gray-800",
  };

  return (
    <div className="bg-white rounded-xl p-4 shadow-sm">
      {/* ... other card content ... */}

      {/* Status badge - use deliveryStatus, not offer.status */}
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColors[deliveryStatus]}`}>
        {statusLabels[deliveryStatus]}
      </span>
    </div>
  );
}
```

### Step 3: Remove Default Filter

```typescript
// src/app/provider/offers/page.tsx

export default function OffersPage() {
  // NO default filter - start with "all" or undefined
  const [statusFilter, setStatusFilter] = useState<string | undefined>(undefined);

  // Fetch offers without pre-filtering by status on client
  // The server query already filters out delivered/cancelled

  return (
    <div>
      {/* Filter buttons - none pre-selected */}
      <div className="flex gap-2 mb-4">
        <button
          onClick={() => setStatusFilter(undefined)}
          className={!statusFilter ? "bg-blue-500 text-white" : "bg-gray-100"}
        >
          Todas
        </button>
        <button
          onClick={() => setStatusFilter("accepted")}
          className={statusFilter === "accepted" ? "bg-blue-500 text-white" : "bg-gray-100"}
        >
          Aceptadas
        </button>
        <button
          onClick={() => setStatusFilter("in_transit")}
          className={statusFilter === "in_transit" ? "bg-amber-500 text-white" : "bg-gray-100"}
        >
          En Camino
        </button>
      </div>

      {/* Offers list */}
      <div className="space-y-3">
        {offers
          .filter(o => !statusFilter || o.request?.status === statusFilter)
          .map(offer => (
            <OfferCard key={offer.id} offer={offer} />
          ))}
      </div>
    </div>
  );
}
```

### Step 4: Add Optional History Section

If providers want to see past deliveries, add a separate section or toggle:

```typescript
// Optional: Add "Ver historial" toggle
const [showHistory, setShowHistory] = useState(false);

// Separate query for history
const { data: historyOffers } = useQuery({
  queryKey: ["provider-offers-history", userId],
  queryFn: () => getProviderCompletedOffers(userId),
  enabled: showHistory,
});

return (
  <div>
    {/* Active offers section */}
    <h2>Entregas Activas</h2>
    {/* ... active offers list ... */}

    {/* History toggle */}
    <button onClick={() => setShowHistory(!showHistory)}>
      {showHistory ? "Ocultar Historial" : "Ver Historial"}
    </button>

    {/* History section (collapsed by default) */}
    {showHistory && (
      <div className="mt-4">
        <h2>Historial de Entregas</h2>
        {historyOffers?.map(offer => (
          <OfferCard key={offer.id} offer={offer} />
        ))}
      </div>
    )}
  </div>
);
```

## Testing Checklist

### Manual Testing

- [ ] **Test 1: No Default Filter**
  1. Log in as provider
  2. Navigate to "Mis Ofertas"
  3. Verify: No filter pre-selected, all active offers visible

- [ ] **Test 2: Completed Deliveries Hidden**
  1. Accept a consumer's request
  2. Complete the delivery (mark as delivered)
  3. Go to "Mis Ofertas"
  4. Verify: The completed delivery is NOT in the list

- [ ] **Test 3: Correct Status Display**
  1. Have an offer in "accepted" state → shows "Aceptada"
  2. Start delivery (in_transit) → shows "En Camino"
  3. Verify: Status badge reflects actual delivery status

- [ ] **Test 4: Filter Works**
  1. Have offers in different states
  2. Click "En Camino" filter
  3. Verify: Only in_transit offers shown
  4. Click "Todas" → all active offers shown

- [ ] **Test 5: Real-Time Update**
  1. Have an active offer open
  2. On another tab, complete the delivery
  3. Verify: Offer disappears from list (or status updates)

## Definition of Done

- [ ] Offers query filters out delivered/cancelled requests
- [ ] No default filter on page load
- [ ] Status badges show water_requests.status
- [ ] All acceptance criteria pass manual testing
- [ ] No TypeScript errors
- [ ] No breaking changes to existing offer flow

## Related Issues

- **BUG-R2-009** noted "wrong default filter" - this story fixes it
- **BUG-R2-018** noted "completed deliveries visible" - this story fixes it
- Both share the same root cause (offers.status vs water_requests.status)
