# Story 12.8-1: Push Notification Security - Context

## Quick Reference

| Field | Value |
|-------|-------|
| **Story** | 12.8-1: Push Notification Security & Logout Cleanup |
| **Priority** | P0 (Critical - Security) |
| **Points** | 8 |
| **Bugs** | BUG-R2-003, BUG-R2-017 |

## Problem Summary

Push notifications are sent to wrong users when accounts switch on devices. This is a **security vulnerability** causing privacy breaches and authorization bypasses.

## Root Cause (Three Issues)

1. **Missing Logout Cleanup:** `signOut()` doesn't call `unsubscribeFromPush()`
2. **Database Constraint Too Loose:** `UNIQUE(user_id, endpoint)` allows same endpoint for multiple users
3. **No Endpoint Deduplication:** Subscribe doesn't check if endpoint exists for different user

## Key Files

| File | Purpose |
|------|---------|
| `src/lib/push/logout-cleanup.ts` | **CREATE** - Reusable cleanup function |
| `src/app/provider/settings/sign-out-button.tsx` | Add cleanup before signOut |
| `src/app/consumer-profile/page.tsx` | Add cleanup before signOut |
| `src/components/admin/admin-logout-button.tsx` | Add cleanup before signOut |
| `src/lib/actions/push-subscription.ts` | Add endpoint deduplication |

## Implementation Steps

1. Create `logout-cleanup.ts` utility
2. Update provider logout to use cleanup
3. Update consumer logout to use cleanup
4. Update admin logout to use cleanup
5. Add endpoint deduplication in `subscribeToPush()`
6. (Optional) Database migration for endpoint uniqueness

## Testing Focus

- User A logs out → subscription deleted
- User B logs in on same device → only User B has subscription
- Notifications go to correct user, not previous device user

## Security Impact

**CRITICAL** - Must complete before production. Fixes:
- Privacy breach (seeing others' orders)
- Authorization bypass (wrong user links)
- Multi-tenant isolation failure
