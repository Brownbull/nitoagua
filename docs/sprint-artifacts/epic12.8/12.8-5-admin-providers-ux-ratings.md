# Story 12.8-5: Admin Providers UX & Ratings

| Field | Value |
|-------|-------|
| **Story ID** | 12.8-5 |
| **Epic** | Epic 12.8: Round 2 Manual Testing Bug Fixes |
| **Title** | Admin Providers UX & Ratings |
| **Status** | done |
| **Priority** | P2 (Medium) |
| **Points** | 5 |
| **Bug References** | BUG-R2-010, BUG-R2-011 |

## User Story

**As an** admin user,
**I want** to see provider emails, ratings, and rating history,
**So that** I can effectively manage and evaluate provider performance.

## Problem Statement

### BUG-R2-010: Filter Layout and Missing Email

Two issues with the admin Providers page:
1. **Inefficient filter layout:** Status and Area filters on separate rows (wastes space)
2. **Missing email:** Provider cards show name and phone, but NOT email

### BUG-R2-011: Missing Ratings

Provider ratings are not visible in the admin panel:
1. **No rating on cards:** Provider list cards don't show average rating
2. **No rating history:** Provider detail page has no rating section

## Technical Context

### Database Schema

```sql
-- Existing profiles table has these fields:
profiles (
  average_rating DECIMAL(2,1) DEFAULT 0,
  rating_count INTEGER DEFAULT 0,
  email TEXT,  -- From auth.users
  ...
)

-- Ratings table (already exists from Epic 12.7)
ratings (
  id UUID,
  request_id UUID,
  consumer_id UUID,
  provider_id UUID,
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMPTZ
)
```

### Files to Modify

| File | Current Issue | Required Change |
|------|--------------|-----------------|
| `src/app/admin/providers/page.tsx` | Vertical filter layout | Side-by-side filters |
| `src/components/admin/provider-card.tsx` | No email, no rating | Add email + rating badge |
| `src/app/admin/providers/[id]/page.tsx` | No ratings section | Add ratings history |
| `src/lib/actions/providers.ts` | May not include ratings | Include ratings in query |

## Acceptance Criteria

### AC12.8.5.1: Side-by-Side Filters
**Given** the admin Providers page
**When** displayed on any viewport
**Then** Status and Area filters are on the same row
**And** Search bar is on a separate row below
**And** vertical space is minimized

### AC12.8.5.2: Email on Provider Cards
**Given** a provider card in the list
**When** displayed
**Then** the provider's email is shown (with âœ‰ï¸ icon)
**And** phone is also shown (with ğŸ“ icon)
**And** contact info is easily copyable

### AC12.8.5.3: Rating on Provider Cards
**Given** a provider with ratings
**When** their card is displayed
**Then** average rating is shown (e.g., â­ 4.5)
**And** rating count is shown (e.g., (12))
**And** rating is positioned in top-right corner

### AC12.8.5.4: Zero Ratings Display
**Given** a provider with no ratings
**When** their card is displayed
**Then** rating shows "Sin calificaciones" or equivalent
**And** no misleading "0" rating is shown

### AC12.8.5.5: Provider Detail Ratings Section
**Given** the provider detail page
**When** an admin views a provider's details
**Then** a "Calificaciones" section is visible
**And** it shows the average rating and total count
**And** it lists individual ratings with date, consumer name, stars, and comment

### AC12.8.5.6: Ratings Sorted by Date
**Given** the ratings history in provider detail
**When** displayed
**Then** ratings are sorted by date (newest first)
**And** each rating shows formatted date

## Implementation

### Step 1: Side-by-Side Filter Layout

```tsx
// src/app/admin/providers/page.tsx

export default function ProvidersPage() {
  return (
    <div className="p-4">
      <h1 className="text-lg font-bold mb-4">Proveedores</h1>

      {/* Filters: Side by side */}
      <div className="space-y-2 mb-4">
        {/* Row 1: Status + Area */}
        <div className="flex gap-2">
          <Select value={statusFilter} onValueChange={setStatusFilter}>
            <SelectTrigger className="flex-1">
              <SelectValue placeholder="Estado" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos</SelectItem>
              <SelectItem value="active">Activos</SelectItem>
              <SelectItem value="inactive">Inactivos</SelectItem>
              <SelectItem value="pending">Pendientes</SelectItem>
            </SelectContent>
          </Select>

          <Select value={areaFilter} onValueChange={setAreaFilter}>
            <SelectTrigger className="flex-1">
              <SelectValue placeholder="Ãrea/Comuna" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todas</SelectItem>
              {comunas.map(comuna => (
                <SelectItem key={comuna} value={comuna}>{comuna}</SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Row 2: Search */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
          <Input
            placeholder="Buscar proveedores..."
            className="pl-9"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
          />
        </div>
      </div>

      {/* Provider cards */}
      <div className="space-y-3">
        {providers.map(provider => (
          <ProviderCard key={provider.id} provider={provider} />
        ))}
      </div>
    </div>
  );
}
```

### Step 2: Update Provider Card

```tsx
// src/components/admin/provider-card.tsx

interface ProviderCardProps {
  provider: {
    id: string;
    name: string;
    phone: string;
    email: string;
    average_rating: number;
    rating_count: number;
    status: string;
    // ...
  };
}

export function ProviderCard({ provider }: ProviderCardProps) {
  return (
    <Link
      href={`/admin/providers/${provider.id}`}
      className="block bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition"
    >
      <div className="flex justify-between">
        {/* Left: Avatar + Info */}
        <div className="flex gap-3">
          <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <User className="h-6 w-6 text-blue-600" />
          </div>

          <div>
            <h3 className="font-semibold text-gray-900">{provider.name}</h3>

            {/* Phone */}
            <div className="flex items-center gap-1 text-sm text-gray-600 mt-1">
              <Phone className="h-3 w-3" />
              <span>{provider.phone}</span>
            </div>

            {/* Email */}
            <div className="flex items-center gap-1 text-sm text-gray-600">
              <Mail className="h-3 w-3" />
              <span className="truncate max-w-[180px]">{provider.email}</span>
            </div>

            {/* Status badge */}
            <div className="mt-2">
              <StatusBadge status={provider.status} />
            </div>
          </div>
        </div>

        {/* Right: Rating */}
        <div className="text-right">
          {provider.rating_count > 0 ? (
            <div>
              <div className="flex items-center gap-1 text-amber-500">
                <Star className="h-4 w-4 fill-current" />
                <span className="font-semibold">{provider.average_rating.toFixed(1)}</span>
              </div>
              <span className="text-xs text-gray-500">({provider.rating_count})</span>
            </div>
          ) : (
            <span className="text-xs text-gray-400">Sin calificaciones</span>
          )}
        </div>
      </div>
    </Link>
  );
}
```

### Step 3: Update Provider Query

```typescript
// src/lib/actions/providers.ts

export async function getProviders(): Promise<Provider[]> {
  const supabase = await createAdminClient();

  const { data: providers, error } = await supabase
    .from("profiles")
    .select(`
      id,
      name,
      phone,
      email,
      average_rating,
      rating_count,
      status,
      created_at,
      comuna_id,
      comuna:comunas(name)
    `)
    .eq("role", "supplier")
    .order("created_at", { ascending: false });

  if (error) {
    console.error("[Providers] Error fetching providers:", error);
    return [];
  }

  return providers || [];
}
```

### Step 4: Provider Detail Ratings Section

```tsx
// src/app/admin/providers/[id]/page.tsx

interface Rating {
  id: string;
  rating: number;
  comment: string | null;
  created_at: string;
  consumer: {
    name: string;
  };
}

export default async function ProviderDetailPage({ params }: { params: { id: string } }) {
  const provider = await getProviderById(params.id);
  const ratings = await getProviderRatings(params.id);

  return (
    <div className="p-4 space-y-4">
      {/* Header */}
      <div className="flex items-center gap-2">
        <BackButton />
        <h1 className="text-lg font-bold">{provider.name}</h1>
      </div>

      {/* Provider info sections... */}

      {/* Ratings Section */}
      <section className="bg-white rounded-xl p-4 shadow-sm">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-sm font-semibold">Calificaciones</h2>
          {provider.rating_count > 0 && (
            <div className="flex items-center gap-2">
              <div className="flex items-center gap-1 text-amber-500">
                <Star className="h-4 w-4 fill-current" />
                <span className="font-semibold">{provider.average_rating.toFixed(1)}</span>
              </div>
              <span className="text-xs text-gray-500">
                ({provider.rating_count} calificaciones)
              </span>
            </div>
          )}
        </div>

        {ratings.length > 0 ? (
          <div className="space-y-3">
            {ratings.map((rating) => (
              <div key={rating.id} className="border-b border-gray-100 pb-3 last:border-0">
                <div className="flex justify-between items-start">
                  <div>
                    <p className="text-sm font-medium">{rating.consumer.name}</p>
                    <div className="flex items-center gap-1 mt-1">
                      {[1, 2, 3, 4, 5].map((star) => (
                        <Star
                          key={star}
                          className={`h-3 w-3 ${
                            star <= rating.rating
                              ? "text-amber-400 fill-current"
                              : "text-gray-200"
                          }`}
                        />
                      ))}
                    </div>
                  </div>
                  <span className="text-xs text-gray-500">
                    {formatDate(rating.created_at)}
                  </span>
                </div>
                {rating.comment && (
                  <p className="text-sm text-gray-600 mt-2 italic">
                    "{rating.comment}"
                  </p>
                )}
              </div>
            ))}
          </div>
        ) : (
          <p className="text-sm text-gray-500 text-center py-4">
            Este proveedor aÃºn no tiene calificaciones.
          </p>
        )}
      </section>
    </div>
  );
}
```

### Step 5: Get Provider Ratings Query

```typescript
// src/lib/actions/providers.ts

export async function getProviderRatings(providerId: string): Promise<Rating[]> {
  const supabase = await createAdminClient();

  const { data: ratings, error } = await supabase
    .from("ratings")
    .select(`
      id,
      rating,
      comment,
      created_at,
      consumer:profiles!consumer_id(name)
    `)
    .eq("provider_id", providerId)
    .order("created_at", { ascending: false })
    .limit(20);

  if (error) {
    console.error("[Providers] Error fetching ratings:", error);
    return [];
  }

  return ratings || [];
}
```

## Testing Checklist

### Manual Testing

- [ ] **Test 1: Side-by-Side Filters**
  1. Navigate to Admin > Providers
  2. Verify: Status and Area filters on same row
  3. Verify: Search bar below filters
  4. Test on mobile and desktop

- [ ] **Test 2: Email on Cards**
  1. View provider list
  2. Verify: Email visible with âœ‰ï¸ icon
  3. Verify: Phone also visible with ğŸ“ icon

- [ ] **Test 3: Rating on Cards**
  1. View provider with ratings
  2. Verify: Average rating shown (â­ X.X)
  3. Verify: Count shown in parentheses
  4. View provider without ratings
  5. Verify: "Sin calificaciones" shown

- [ ] **Test 4: Ratings Section in Detail**
  1. Click on provider with ratings
  2. Verify: Ratings section visible
  3. Verify: Average + count in header
  4. Verify: Individual ratings listed
  5. Verify: Date, consumer name, stars, comment shown

- [ ] **Test 5: No Ratings State**
  1. View provider detail for provider with no ratings
  2. Verify: Appropriate empty state message

## Definition of Done

- [x] Filters side-by-side
- [x] Email visible on provider cards
- [x] Rating visible on provider cards
- [x] Ratings section in provider detail
- [x] All acceptance criteria pass
- [x] No TypeScript errors

## Implementation Notes

### Completed: 2026-01-05

**Files Modified:**
1. `src/app/admin/providers/page.tsx` - Added `average_rating` and `rating_count` to query and type
2. `src/components/admin/provider-directory.tsx` - Reorganized filters (Status+Area side-by-side, search below), added email/phone/rating to mobile cards
3. `src/components/admin/provider-detail-panel.tsx` - Added ratings section with loading state, individual rating display with stars
4. `src/lib/actions/provider-management.ts` - Added `getProviderRatings()` server action with admin auth

**Key Changes:**
- Filter layout now has Status + Area dropdowns side-by-side on row 1, search input on row 2
- Mobile provider cards now show: name, status badge, rating (top-right), phone, email (if available), delivery count
- Provider detail panel includes "Calificaciones" section with average rating summary and individual ratings list
- Ratings fetched dynamically when panel opens, sorted by newest first
- "Sin calificaciones" shown for providers with no ratings

**E2E Tests:**
- Created `tests/e2e/admin-providers-ux.spec.ts` with tests for:
  - AC12.8.5.1: Side-by-side filter layout verification
  - AC12.8.5.2: Email visible on provider cards
  - AC12.8.5.3/4: Rating display and zero-rating handling
  - AC12.8.5.5/6: Provider detail ratings section

**Build Status:**
- TypeScript: âœ… No errors
- Next.js build: âœ… Successful

**Local Testing Setup Notes:**
- Local Supabase must be running (`npx supabase start`)
- Admin test user needs profile in database. If missing, run:
  ```sql
  INSERT INTO profiles (id, email, name, phone, role)
  VALUES (
    '6288587d-d0bf-4b32-ae68-5809daec89ad',
    'admin@nitoagua.cl',
    'Admin Test',
    '+56900000001',
    'consumer'
  ) ON CONFLICT (id) DO NOTHING;
  ```
- Admin access is determined by `admin_allowed_emails` table, NOT profile role
- Profile role can only be 'consumer' or 'supplier' (check constraint)

**Manual Testing Status:**
- [x] Admin login redirects to /admin/dashboard (after profile fix)
- [ ] Providers page shows filters side-by-side
- [ ] Provider cards show email, phone, rating
- [ ] Provider detail panel shows ratings section
- [ ] Ratings loading and empty state work

## Design Reference

### Provider Card

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ‘¤] Juan Proveedor      â­ 4.5 (12)â”‚
â”‚      ğŸ“ +56912345678                â”‚
â”‚      âœ‰ï¸ juan@email.com              â”‚
â”‚      [ğŸŸ¢ Activo]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Provider Detail Ratings

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calificaciones        â­ 4.5 (12)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MarÃ­a GarcÃ­a           hace 2 dÃ­as  â”‚
â”‚ â­â­â­â­â­                             â”‚
â”‚ "Excelente servicio, muy puntual"   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pedro LÃ³pez            hace 1 sem   â”‚
â”‚ â­â­â­â­â˜†                              â”‚
â”‚ "LlegÃ³ a tiempo, buen trato"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
