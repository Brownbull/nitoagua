# Story 12.8-2: Role-Based Route Guards

| Field | Value |
|-------|-------|
| **Story ID** | 12.8-2 |
| **Epic** | Epic 12.8: Round 2 Manual Testing Bug Fixes |
| **Title** | Role-Based Route Guards |
| **Status** | backlog |
| **Priority** | P0 (Critical - Security) |
| **Points** | 5 |
| **Bug References** | BUG-R2-004 |

## User Story

**As a** system administrator,
**I want** users to be automatically redirected to their role-appropriate dashboard,
**So that** users cannot access views intended for different roles (role isolation).

## Problem Statement

### BUG-R2-004: Admin Can Access Consumer View

When logged in as Admin and clicking a notification (intended for a different user due to BUG-R2-003), the admin is taken to the consumer view. After viewing an error message, navigating to the profile shows the consumer profile UI with admin account details.

**Screenshot showed:** Consumer "Mi Perfil" page displaying admin@nitoagua.cl and "Admin Test"

This is a **critical role isolation failure** - admin accounts should NEVER see consumer-only views.

### Root Cause

1. Consumer routes (`/settings`, `/request`, `/consumer-profile`) only check "is authenticated"
2. No verification that authenticated user has the correct role for the route
3. Notification click handlers navigate without role verification

### Current Behavior

```
Admin logs in → clicks consumer notification → /settings → sees consumer UI!
```

### Expected Behavior

```
Admin logs in → clicks consumer notification → redirect to /admin
Admin manually goes to /settings → redirect to /admin
```

## Technical Context

### Route Categories

| Route Pattern | Required Role | Current Guard | Status |
|--------------|---------------|---------------|--------|
| `/admin/*` | admin | Partial (checks in layout) | Needs verification |
| `/provider/*` | supplier | Partial (checks in layout) | Needs verification |
| `/request`, `/settings`, `/consumer-profile` | consumer | None | **NEEDS FIX** |
| `/login`, `/signup`, `/` | any | None (public) | OK |

### Files to Modify

| File | Change Required |
|------|-----------------|
| `src/middleware.ts` | Add role-based route guards |
| `src/app/(consumer)/layout.tsx` | Add role check, redirect if wrong role |
| `src/app/consumer-profile/page.tsx` | Add role redirect check |
| `src/app/settings/page.tsx` | Add role redirect check (or move to layout) |

## Acceptance Criteria

### AC12.8.2.1: Consumer Routes Protected
**Given** a user with role "admin" or "supplier"
**When** they navigate to `/settings`, `/request`, or `/consumer-profile`
**Then** they are redirected to their role's dashboard (`/admin` or `/provider`)
**And** they never see the consumer UI

### AC12.8.2.2: Provider Routes Protected
**Given** a user with role "admin" or "consumer"
**When** they navigate to `/provider/*` routes
**Then** they are redirected to their role's dashboard
**And** they never see the provider UI

### AC12.8.2.3: Admin Routes Protected
**Given** a user with role "consumer" or "supplier"
**When** they navigate to `/admin/*` routes
**Then** they are redirected to their role's dashboard
**And** they never see the admin UI

### AC12.8.2.4: Unauthenticated Redirect
**Given** an unauthenticated user
**When** they navigate to any protected route
**Then** they are redirected to `/login`
**And** after login they return to their role's dashboard

### AC12.8.2.5: Notification Click Handling
**Given** a logged-in user who receives a push notification
**When** they click the notification
**And** the notification URL is for a different role
**Then** they are redirected to their correct dashboard
**And** they see a toast explaining the redirect (optional)

## Implementation

### Option 1: Middleware-Level Guards (Recommended)

This is the most robust approach as it catches ALL requests before they reach the page.

```typescript
// src/middleware.ts
import { NextResponse, type NextRequest } from "next/server";
import { createServerClient } from "@supabase/ssr";

export async function middleware(request: NextRequest) {
  // Create Supabase client for middleware
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll: () => request.cookies.getAll(),
        setAll: (cookies) => {
          // Handle cookie setting
        },
      },
    }
  );

  // Get session and user
  const { data: { user } } = await supabase.auth.getUser();

  // Public routes - no guard needed
  const publicRoutes = ["/", "/login", "/signup", "/auth/callback"];
  if (publicRoutes.some(route => request.nextUrl.pathname === route)) {
    return NextResponse.next();
  }

  // If not authenticated, redirect to login
  if (!user) {
    return NextResponse.redirect(new URL("/login", request.url));
  }

  // Get user role from profile
  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();

  const role = profile?.role;

  // Define role-to-route mappings
  const roleRoutes: Record<string, string> = {
    admin: "/admin",
    supplier: "/provider",
    consumer: "/consumer-profile", // or "/" for consumer
  };

  // Consumer routes
  const consumerRoutes = ["/settings", "/request", "/consumer-profile"];
  if (consumerRoutes.some(route => request.nextUrl.pathname.startsWith(route))) {
    if (role === "admin") {
      return NextResponse.redirect(new URL("/admin", request.url));
    }
    if (role === "supplier") {
      return NextResponse.redirect(new URL("/provider", request.url));
    }
  }

  // Provider routes
  if (request.nextUrl.pathname.startsWith("/provider")) {
    if (role === "admin") {
      return NextResponse.redirect(new URL("/admin", request.url));
    }
    if (role !== "supplier") {
      return NextResponse.redirect(new URL("/", request.url));
    }
  }

  // Admin routes
  if (request.nextUrl.pathname.startsWith("/admin")) {
    if (role !== "admin") {
      const redirect = roleRoutes[role] || "/";
      return NextResponse.redirect(new URL(redirect, request.url));
    }
  }

  return NextResponse.next();
}

export const config = {
  matcher: [
    // Match all routes except static files and api
    "/((?!_next/static|_next/image|favicon.ico|icons|api|sw.js|manifest).*)",
  ],
};
```

### Option 2: Layout-Level Guards (Supplementary)

Add as a backup layer in case middleware is bypassed:

```typescript
// src/app/(consumer)/layout.tsx
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";

export default async function ConsumerLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();

  // Redirect non-consumers to their correct dashboard
  if (profile?.role === "admin") {
    redirect("/admin");
  }
  if (profile?.role === "supplier") {
    redirect("/provider");
  }

  return <>{children}</>;
}
```

### Option 3: Page-Level Guards (For Specific Pages)

For pages that aren't in a route group:

```typescript
// src/app/settings/page.tsx
import { redirect } from "next/navigation";
import { createClient } from "@/lib/supabase/server";

export default async function SettingsPage() {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect("/login");
  }

  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();

  // Redirect non-consumers
  if (profile?.role === "admin") {
    redirect("/admin");
  }
  if (profile?.role === "supplier") {
    redirect("/provider");
  }

  // Render consumer settings page...
}
```

### Utility: Role-Based Redirect Helper

```typescript
// src/lib/auth/role-redirect.ts
import { redirect } from "next/navigation";

export type UserRole = "admin" | "supplier" | "consumer";

export function getRedirectForRole(role: UserRole | undefined): string {
  switch (role) {
    case "admin":
      return "/admin";
    case "supplier":
      return "/provider";
    case "consumer":
    default:
      return "/";
  }
}

export function redirectIfWrongRole(
  actualRole: UserRole | undefined,
  requiredRole: UserRole
): void {
  if (actualRole !== requiredRole) {
    redirect(getRedirectForRole(actualRole));
  }
}
```

## Testing Checklist

### Manual Testing

- [ ] **Test 1: Admin to Consumer Route**
  1. Log in as admin@nitoagua.cl
  2. Manually navigate to /settings
  3. Verify: Redirected to /admin, never see consumer settings

- [ ] **Test 2: Admin to Provider Route**
  1. Log in as admin
  2. Navigate to /provider
  3. Verify: Redirected to /admin

- [ ] **Test 3: Provider to Consumer Route**
  1. Log in as supplier@nitoagua.cl
  2. Navigate to /settings
  3. Verify: Redirected to /provider

- [ ] **Test 4: Consumer to Admin Route**
  1. Log in as consumer
  2. Navigate to /admin
  3. Verify: Redirected to / or /consumer-profile

- [ ] **Test 5: Notification Click Cross-Role**
  1. Log in as admin
  2. Click old consumer notification link
  3. Verify: Redirected to /admin, not consumer view

- [ ] **Test 6: Unauthenticated Access**
  1. Log out
  2. Navigate to /admin, /provider, /settings
  3. Verify: All redirect to /login

## Definition of Done

- [ ] Middleware guards implemented for all route categories
- [ ] Layout guards added as backup layer
- [ ] All acceptance criteria pass manual testing
- [ ] No role can access another role's views
- [ ] Unauthenticated users redirected to login
- [ ] No TypeScript errors
- [ ] No breaking changes to existing auth flow

## Security Notes

This is a **CRITICAL SECURITY FIX** for role isolation. Multi-tenant applications MUST enforce strict separation between user roles. The current behavior could lead to:
- Data leakage (admin seeing consumer data they shouldn't)
- Privilege confusion (users performing actions in wrong context)
- Audit trail issues (actions logged under wrong role)

This story MUST be completed before production deployment.

## Related Stories

- **12.8-1 (Push Security):** Role isolation bug is partially caused by push notifications going to wrong users. Both stories should be completed together.
