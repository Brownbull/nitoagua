<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>
  <critical>Generate all documents in {document_output_language}</critical>
  <critical>Only modify the story file in these areas: Tasks/Subtasks checkboxes, Dev Agent Record (Debug Log, Completion Notes), File List,
    Change Log, and Status</critical>
  <critical>Execute ALL steps in exact order; do NOT skip steps</critical>
  <critical>Absolutely DO NOT stop because of "milestones", "significant progress", or "session boundaries". Continue in a single execution
    until the story is COMPLETE (all ACs satisfied and all tasks/subtasks checked) UNLESS a HALT condition is triggered or the USER gives
    other instruction.</critical>
  <critical>Do NOT schedule a "next session" or request review pauses unless a HALT condition applies. Only Step 6 decides completion.</critical>
  <critical>User skill level ({user_skill_level}) affects conversation style ONLY, not code updates.</critical>

  <!-- ATLAS INTEGRATION -->
  <atlas-protocol>
    <principle>Atlas provides architectural guidance and historical context - it advises, never executes</principle>
    <principle>Consult Atlas BEFORE implementation decisions to avoid repeating past mistakes</principle>
    <principle>Feed lessons learned BACK to Atlas at story completion</principle>
    <loading>
      Use INDEX-GUIDED loading: Consult {atlas_index} first, then load ONLY relevant fragments from {atlas_knowledge}/
      - Architecture decisions: 04-architecture.md
      - Testing patterns: 05-testing.md
      - Past lessons: 06-lessons.md (optional, load if hitting issues)
      - Workflow chains: 08-workflow-chains.md (for impact analysis)
    </loading>
  </atlas-protocol>

  <step n="0" goal="Atlas consultation - Load relevant knowledge" tag="atlas-init">
    <critical>This step loads Atlas knowledge BEFORE starting implementation</critical>

    <check if="{atlas_index} exists">
      <action>Load {atlas_index} to identify relevant fragments</action>
      <action>Load {atlas_knowledge}/04-architecture.md for tech patterns</action>
      <action>Load {atlas_knowledge}/05-testing.md for test patterns</action>
      <action>Store as {{atlas_architecture}} and {{atlas_testing}}</action>

      <output>üó∫Ô∏è **Atlas Knowledge Loaded**
        - Architecture patterns: {{architecture_summary}}
        - Testing patterns: {{testing_summary}}
        - Will validate implementation against documented patterns
      </output>
    </check>

    <check if="{atlas_index} does NOT exist">
      <output>‚ÑπÔ∏è Atlas not configured - proceeding with standard dev-story workflow</output>
      <action>Set {{atlas_enabled}} = false</action>
    </check>
  </step>

  <step n="1" goal="Find next ready story and load it" tag="sprint-status">
    <check if="{{story_path}} is provided">
      <action>Use {{story_path}} directly</action>
      <action>Read COMPLETE story file</action>
      <action>Extract story_key from filename or metadata</action>
      <goto> anchor with id task_check</goto>
    </check>

    <!-- Sprint-based story discovery -->
    <check if="{{sprint_status}} file exists">
      <critical>MUST read COMPLETE sprint-status.yaml file from start to end to preserve order</critical>
      <action>Load the FULL file: {{sprint_status}}</action>
      <action>Read ALL lines from beginning to end - do not skip any content</action>
      <action>Parse the development_status section completely to understand story order</action>

      <action>Find the FIRST story (by reading in order from top to bottom) where:
        - Key matches pattern: number-number-name (e.g., "1-2-user-auth")
        - NOT an epic key (epic-X) or retrospective (epic-X-retrospective)
        - Status value equals "ready-for-dev"
      </action>

      <check if="no ready-for-dev or in-progress story found">
        <output>üìã No ready-for-dev stories found in sprint-status.yaml

          **Current Sprint Status:** {{sprint_status_summary}}

          **What would you like to do?**
          1. Run `atlas-create-story` to create next story with Atlas context
          2. Run `create-story` for standard story creation
          3. Specify a particular story file to develop (provide full path)
          4. Check {{sprint_status}} file to see current sprint status
        </output>
        <ask>Choose option [1], [2], [3], or [4], or specify story file path:</ask>

        <check if="user chooses '1'">
          <action>HALT - Run atlas-create-story to create next story with Atlas context</action>
        </check>

        <check if="user chooses '2'">
          <action>HALT - Run create-story for standard story creation</action>
        </check>

        <check if="user chooses '3'">
          <ask>Provide the story file path to develop:</ask>
          <action>Store user-provided story path as {{story_path}}</action>
          <goto anchor="task_check" />
        </check>

        <check if="user chooses '4'">
          <output>Loading {{sprint_status}} for detailed status review...</output>
          <action>Display detailed sprint status analysis</action>
          <action>HALT - User can review sprint status and provide story path</action>
        </check>
      </check>
    </check>

    <!-- Non-sprint story discovery -->
    <check if="{{sprint_status}} file does NOT exist">
      <action>Search {story_dir} for stories directly</action>
      <action>Find stories with "ready-for-dev" status in files</action>
      <action>Look for story files matching pattern: *-*-*.md</action>
      <action>Read each candidate story file to check Status section</action>

      <check if="no ready-for-dev stories found in story files">
        <output>üìã No ready-for-dev stories found

          **Available Options:**
          1. Run `atlas-create-story` to create next story with Atlas context
          2. Run `create-story` for standard story creation
          3. Specify which story to develop
        </output>
        <ask>What would you like to do? Choose option [1], [2], or [3]:</ask>
      </check>
    </check>

    <action>Store the found story_key (e.g., "1-2-user-authentication") for later status updates</action>
    <action>Find matching story file in {story_dir} using story_key pattern: {{story_key}}.md</action>
    <action>Read COMPLETE story file from discovered path</action>

    <anchor id="task_check" />

    <action>Parse sections: Story, Acceptance Criteria, Tasks/Subtasks, Dev Notes, Dev Agent Record, File List, Change Log, Status</action>
    <action>Load comprehensive context from story file's Dev Notes section</action>
    <action>Extract developer guidance from Dev Notes: architecture requirements, previous learnings, technical specifications</action>
    <action>Use enhanced story context to inform implementation decisions and approaches</action>
    <action>Identify first incomplete task (unchecked [ ]) in Tasks/Subtasks</action>

    <action if="no incomplete tasks">
      <goto step="6">Completion sequence</goto>
    </action>
    <action if="story file inaccessible">HALT: "Cannot develop story without access to story file"</action>
    <action if="incomplete task or subtask requirements ambiguous">ASK user to clarify or HALT</action>
  </step>

  <step n="2" goal="Load project context and Atlas-validate story alignment" tag="atlas-validate">
    <critical>Load all available context AND validate against Atlas knowledge</critical>

    <action>Load {project_context} for coding standards and project-wide patterns (if exists)</action>
    <action>Parse sections: Story, Acceptance Criteria, Tasks/Subtasks, Dev Notes, Dev Agent Record, File List, Change Log, Status</action>
    <action>Load comprehensive context from story file's Dev Notes section</action>
    <action>Extract developer guidance from Dev Notes: architecture requirements, previous learnings, technical specifications</action>

    <!-- ATLAS VALIDATION -->
    <check if="{{atlas_enabled}} == true">
      <action>Cross-reference story requirements against {{atlas_architecture}}</action>
      <action>Check for pattern compliance with documented architectural decisions</action>
      <action>Identify any potential conflicts with existing patterns</action>

      <check if="conflicts detected">
        <output>üó∫Ô∏è **Atlas Alert:** Potential pattern conflicts detected

          **Conflicts:**
          {{conflict_list}}

          **Recommendations:**
          {{atlas_recommendations}}

          Would you like to proceed with the standard approach or adjust?
        </output>
        <ask>Proceed [P] or Adjust [A]?</ask>
      </check>

      <check if="no conflicts">
        <output>‚úÖ **Atlas Validated:** Story aligns with documented patterns</output>
      </check>
    </check>

    <output>‚úÖ **Context Loaded**
      Story and project context available for implementation
    </output>
  </step>

  <step n="3" goal="Detect review continuation and extract review context">
    <critical>Determine if this is a fresh start or continuation after code review</critical>

    <action>Check if "Senior Developer Review (AI)" section exists in the story file</action>
    <action>Check if "Review Follow-ups (AI)" subsection exists under Tasks/Subtasks</action>

    <check if="Senior Developer Review section exists">
      <action>Set review_continuation = true</action>
      <action>Extract from "Senior Developer Review (AI)" section:
        - Review outcome (Approve/Changes Requested/Blocked)
        - Review date
        - Total action items with checkboxes (count checked vs unchecked)
        - Severity breakdown (High/Med/Low counts)
      </action>
      <action>Count unchecked [ ] review follow-up tasks in "Review Follow-ups (AI)" subsection</action>
      <action>Store list of unchecked review items as {{pending_review_items}}</action>

      <output>‚èØÔ∏è **Resuming Story After Code Review** ({{review_date}})

        **Review Outcome:** {{review_outcome}}
        **Action Items:** {{unchecked_review_count}} remaining to address
        **Priorities:** {{high_count}} High, {{med_count}} Medium, {{low_count}} Low

        **Strategy:** Will prioritize review follow-up tasks (marked [AI-Review]) before continuing with regular tasks.
      </output>
    </check>

    <check if="Senior Developer Review section does NOT exist">
      <action>Set review_continuation = false</action>
      <action>Set {{pending_review_items}} = empty</action>

      <output>üöÄ **Starting Fresh Implementation**

        Story: {{story_key}}
        Story Status: {{current_status}}
        First incomplete task: {{first_task_description}}
      </output>
    </check>
  </step>

  <step n="4" goal="Mark story in-progress" tag="sprint-status">
    <check if="{{sprint_status}} file exists">
      <action>Load the FULL file: {{sprint_status}}</action>
      <action>Read all development_status entries to find {{story_key}}</action>
      <action>Get current status value for development_status[{{story_key}}]</action>

      <check if="current status == 'ready-for-dev' OR review_continuation == true">
        <action>Update the story in the sprint status report to = "in-progress"</action>
        <output>üöÄ Starting work on story {{story_key}}
          Status updated: ready-for-dev ‚Üí in-progress
        </output>
      </check>

      <check if="current status == 'in-progress'">
        <output>‚èØÔ∏è Resuming work on story {{story_key}}
          Story is already marked in-progress
        </output>
      </check>

      <action>Store {{current_sprint_status}} for later use</action>
    </check>

    <check if="{{sprint_status}} file does NOT exist">
      <output>‚ÑπÔ∏è No sprint status file exists - story progress will be tracked in story file only</output>
      <action>Set {{current_sprint_status}} = "no-sprint-tracking"</action>
    </check>
  </step>

  <step n="5" goal="Implement task with Atlas pattern guidance" tag="atlas-guided-implementation">
    <critical>FOLLOW THE STORY FILE TASKS/SUBTASKS SEQUENCE EXACTLY AS WRITTEN - NO DEVIATION</critical>
    <critical>Use Atlas patterns to guide implementation approach</critical>

    <action>Review the current task/subtask from the story file - this is your authoritative implementation guide</action>

    <!-- ATLAS PATTERN GUIDANCE -->
    <check if="{{atlas_enabled}} == true">
      <action>Consult {{atlas_architecture}} for relevant patterns for this task</action>
      <action>Consult {{atlas_testing}} for testing approach</action>
      <action>Apply documented patterns to implementation plan</action>
    </check>

    <action>Plan implementation following red-green-refactor cycle</action>

    <!-- RED PHASE -->
    <action>Write FAILING tests first for the task/subtask functionality</action>
    <action>Confirm tests fail before implementation - this validates test correctness</action>

    <!-- GREEN PHASE -->
    <action>Implement MINIMAL code to make tests pass</action>
    <action>Run tests to confirm they now pass</action>
    <action>Handle error conditions and edge cases as specified in task/subtask</action>

    <!-- REFACTOR PHASE -->
    <action>Improve code structure while keeping tests green</action>
    <action>Ensure code follows architecture patterns and coding standards from Dev Notes</action>

    <action>Document technical approach and decisions in Dev Agent Record ‚Üí Implementation Plan</action>

    <action if="new dependencies required beyond story specifications">HALT: "Additional dependencies need user approval"</action>
    <action if="3 consecutive implementation failures occur">
      <!-- ATLAS LESSON LOADING -->
      <check if="{{atlas_enabled}} == true">
        <action>Load {atlas_knowledge}/06-lessons.md for past failure patterns</action>
        <action>Check if similar issues were encountered before</action>
        <output>üó∫Ô∏è **Atlas Consulting Lessons...**
          Checking past implementation issues for guidance...
        </output>
      </check>
      <action>HALT and request guidance</action>
    </action>
    <action if="required configuration is missing">HALT: "Cannot proceed without necessary configuration files"</action>

    <critical>NEVER implement anything not mapped to a specific task/subtask in the story file</critical>
    <critical>NEVER proceed to next task until current task/subtask is complete AND tests pass</critical>
  </step>

  <step n="6" goal="Author comprehensive tests using Atlas patterns" tag="atlas-testing">
    <check if="{{atlas_enabled}} == true">
      <action>Apply testing patterns from {{atlas_testing}}</action>
      <action>Use documented seed data patterns if available</action>
    </check>

    <action>Create unit tests for business logic and core functionality introduced/changed by the task</action>
    <action>Add integration tests for component interactions specified in story requirements</action>
    <action>Include end-to-end tests for critical user flows when story requirements demand them</action>
    <action>Cover edge cases and error handling scenarios identified in story Dev Notes</action>
  </step>

  <step n="7" goal="Run validations and tests">
    <action>Determine how to run tests for this repo (infer test framework from project structure)</action>
    <action>Run all existing tests to ensure no regressions</action>
    <action>Run the new tests to verify implementation correctness</action>
    <action>Run linting and code quality checks if configured in project</action>
    <action>Validate implementation meets ALL story acceptance criteria; enforce quantitative thresholds explicitly</action>
    <action if="regression tests fail">STOP and fix before continuing - identify breaking changes immediately</action>
    <action if="new tests fail">STOP and fix before continuing - ensure implementation correctness</action>
  </step>

  <step n="8" goal="Validate and mark task complete ONLY when fully done">
    <critical>NEVER mark a task complete unless ALL conditions are met - NO LYING OR CHEATING</critical>

    <!-- VALIDATION GATES -->
    <action>Verify ALL tests for this task/subtask ACTUALLY EXIST and PASS 100%</action>
    <action>Confirm implementation matches EXACTLY what the task/subtask specifies - no extra features</action>
    <action>Validate that ALL acceptance criteria related to this task are satisfied</action>
    <action>Run full test suite to ensure NO regressions introduced</action>

    <!-- REVIEW FOLLOW-UP HANDLING -->
    <check if="task is review follow-up (has [AI-Review] prefix)">
      <action>Extract review item details (severity, description, related AC/file)</action>
      <action>Add to resolution tracking list: {{resolved_review_items}}</action>
      <action>Mark task checkbox [x] in "Tasks/Subtasks ‚Üí Review Follow-ups (AI)" section</action>
      <action>Find matching action item in "Senior Developer Review (AI) ‚Üí Action Items" section</action>
      <action>Mark that action item checkbox [x] as resolved</action>
      <action>Add to Dev Agent Record ‚Üí Completion Notes: "‚úÖ Resolved review finding [{{severity}}]: {{description}}"</action>
    </check>

    <!-- ONLY MARK COMPLETE IF ALL VALIDATION PASS -->
    <check if="ALL validation gates pass AND tests ACTUALLY exist and pass">
      <action>ONLY THEN mark the task (and subtasks) checkbox with [x]</action>
      <action>Update File List section with ALL new, modified, or deleted files</action>
      <action>Add completion notes to Dev Agent Record summarizing what was ACTUALLY implemented and tested</action>
    </check>

    <check if="ANY validation fails">
      <action>DO NOT mark task complete - fix issues first</action>
      <action>HALT if unable to fix validation failures</action>
    </check>

    <action>Save the story file</action>
    <action>Determine if more incomplete tasks remain</action>
    <action if="more tasks remain">
      <goto step="5">Next task</goto>
    </action>
    <action if="no tasks remain">
      <goto step="9">Completion</goto>
    </action>
  </step>

  <step n="9" goal="Story completion and mark for review" tag="sprint-status">
    <action>Verify ALL tasks and subtasks are marked [x] (re-scan the story document now)</action>
    <action>Run the full regression suite (do not skip)</action>
    <action>Confirm File List includes every changed file</action>
    <action>Execute enhanced definition-of-done validation</action>
    <action>Update the story Status to: "review"</action>

    <!-- Enhanced Definition of Done Validation -->
    <action>Validate definition-of-done checklist with essential requirements</action>

    <!-- Mark story ready for review - sprint status conditional -->
    <check if="{sprint_status} file exists AND {{current_sprint_status}} != 'no-sprint-tracking'">
      <action>Load the FULL file: {sprint_status}</action>
      <action>Find development_status key matching {{story_key}}</action>
      <action>Update development_status[{{story_key}}] = "review"</action>
      <action>Save file, preserving ALL comments and structure</action>
      <output>‚úÖ Story status updated to "review" in sprint-status.yaml</output>
    </check>

    <!-- Final validation gates -->
    <action if="any task is incomplete">HALT - Complete remaining tasks before marking ready for review</action>
    <action if="regression failures exist">HALT - Fix regression issues before completing</action>
  </step>

  <step n="10" goal="Atlas memory feeding - Capture lessons learned" tag="atlas-feed">
    <critical>Feed implementation insights back to Atlas memory for future reference</critical>

    <check if="{{atlas_enabled}} == true">
      <action>Prepare knowledge nugget for Atlas memory</action>

      <output>üó∫Ô∏è **Atlas Memory Update**

        Preparing to feed implementation insights to Atlas knowledge base:

        **Story:** {{story_key}}
        **Patterns Applied:** {{patterns_used}}
        **Testing Approach:** {{testing_approach}}
        **Challenges Encountered:** {{challenges}}
        **Resolution Strategies:** {{resolutions}}

        **Suggested Updates:**
        - 05-testing.md: {{testing_insights}}
        - 06-lessons.md: {{lesson_insights}}

        Would you like to update Atlas memory with these insights?
      </output>

      <ask>Update Atlas memory? [Y/N]</ask>

      <check if="user confirms">
        <action>Update {atlas_knowledge}/05-testing.md with new testing patterns (if any)</action>
        <action>Update {atlas_knowledge}/06-lessons.md with lessons learned</action>
        <action>Update {atlas_knowledge}/09-sync-history.md with sync entry</action>
        <output>‚úÖ Atlas memory updated with implementation insights</output>
      </check>
    </check>
  </step>

  <step n="11" goal="Completion communication and user support">
    <action>Execute the enhanced definition-of-done checklist using the validation framework</action>
    <action>Prepare a concise summary in Dev Agent Record ‚Üí Completion Notes</action>

    <action>Communicate to {user_name} that story implementation is complete and ready for review</action>
    <action>Summarize key accomplishments: story ID, story key, title, key changes made, tests added, files modified</action>
    <action>Provide the story file path and current status (now "review")</action>

    <action>Based on {user_skill_level}, ask if user needs any explanations</action>

    <action>Recommended next steps:
      - Review the implemented story and test the changes
      - Run `atlas-code-review` workflow for Atlas-enhanced peer review
      - Or run `code-review` for standard review
    </action>

    <output>üí° **Tip:** For best results, run `atlas-code-review` using a **different** LLM than the one that implemented this story.</output>
  </step>

</workflow>
