<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and language MUST be tailored to {user_skill_level}</critical>

  <critical>This workflow deploys a completed story through the full branch pipeline</critical>
  <critical>NEVER skip safety confirmations - each merge step requires explicit approval</critical>
  <critical>Atlas validation is REQUIRED before production deployment</critical>

  <step n="1" goal="Verify story is ready for deployment">
    <action>If {{story_path}} not provided, ask user which story to deploy</action>
    <action>Read COMPLETE story file</action>
    <action>Extract {{story_key}} from filename</action>
    <action>Extract story Status field</action>

    <check if="story status != 'done'">
      <output>**DEPLOYMENT BLOCKED**

        Story status is "{{story_status}}" - must be "done" to deploy.

        Run `code-review` first to complete the story.</output>
      <action>EXIT workflow</action>
    </check>

    <action>Run `git status --porcelain` to check for uncommitted changes</action>
    <check if="uncommitted changes exist">
      <output>**WARNING: Uncommitted Changes Detected**

        Please commit or stash changes before deployment.</output>
      <ask>Commit changes now? [Y/N]</ask>
      <check if="user says Y">
        <action>Run `git add .`</action>
        <action>Run `git commit -m "chore: pre-deployment cleanup for {{story_key}}"`</action>
      </check>
      <check if="user says N">
        <output>Deployment cancelled. Commit changes and retry.</output>
        <action>EXIT workflow</action>
      </check>
    </check>

    <action>Detect current branch with `git branch --show-current`</action>
    <action>Set {{current_branch}} = result</action>
    <action>Determine if on feature branch, develop, or other</action>

    <output>**Story Ready for Deployment**

      **Story:** {{story_key}}
      **Current Branch:** {{current_branch}}
      **Status:** done ‚úÖ

      Deployment pipeline: {{current_branch}} ‚Üí develop ‚Üí staging ‚Üí main</output>
  </step>

  <step n="2" goal="Atlas pre-deployment validation">
    <critical>Atlas validates the deployment before any merges</critical>

    <action>Load Atlas memory from {atlas_memory}</action>
    <action>Load architecture.md for pattern validation</action>

    <output>**Atlas Pre-Deployment Validation**

      Checking alignment with documented architecture and workflows...</output>

    <!-- Atlas Workflow Chain Analysis -->
    <action>Identify workflows affected by this story's changes:
      1. Parse story acceptance criteria for user journey references
      2. Map file changes to affected workflow chains
      3. Identify downstream impacts
    </action>

    <!-- Atlas Architectural Alignment -->
    <action>Check implementation against architecture.md:
      1. Verify patterns used match documented ADRs
      2. Check for undocumented architectural decisions
      3. Flag any deviations from standards
    </action>

    <check if="critical architectural conflicts found">
      <output>**ATLAS DEPLOYMENT BLOCK**

        Critical architectural conflicts detected:
        {{conflict_list}}

        Resolve these issues before deployment.</output>
      <ask>Override Atlas block? (Not recommended) [Y/N]</ask>
      <check if="user says N">
        <action>EXIT workflow</action>
      </check>
      <check if="user says Y">
        <action>Log override decision</action>
        <output>‚ö†Ô∏è Atlas block overridden by user. Proceeding with caution.</output>
      </check>
    </check>

    <output>**Atlas Validation: PASSED ‚úÖ**

      Workflow chains validated: {{chain_count}}
      Architectural alignment: Confirmed
      Downstream impacts: {{impact_summary}}</output>
  </step>

  <step n="3" goal="Merge to develop branch">
    <action>Run `git fetch origin`</action>

    <check if="{{current_branch}} != 'develop'">
      <output>**Step 1/3: Merge to develop**

        Merging {{current_branch}} ‚Üí develop

        This integrates your feature into the development branch.</output>

      <ask>Proceed with merge to develop? [Y/N]</ask>
      <check if="user says N">
        <output>Deployment paused. Resume when ready.</output>
        <action>EXIT workflow</action>
      </check>

      <action>Run `git checkout develop`</action>
      <action>Run `git pull origin develop`</action>
      <action>Run `git merge {{current_branch}} --no-ff -m "Merge {{current_branch}}: {{story_key}}"`</action>

      <check if="merge conflict">
        <output>**MERGE CONFLICT DETECTED**

          Resolve conflicts manually and re-run deploy-story.</output>
        <action>EXIT workflow</action>
      </check>

      <action>Run `git push origin develop`</action>

      <output>**Merged to develop ‚úÖ**

        Vercel will deploy to: {deployment_urls.develop}
        Wait for deployment to complete...</output>

      <action>Wait 30 seconds for Vercel deployment trigger</action>
      <ask>Verify develop deployment is working at {deployment_urls.develop}. Continue? [Y/N]</ask>
      <check if="user says N">
        <output>Deployment paused at develop. Investigate and resume when ready.</output>
        <action>EXIT workflow</action>
      </check>
    </check>

    <check if="{{current_branch}} == 'develop'">
      <output>Already on develop branch. Skipping feature merge.</output>
    </check>
  </step>

  <step n="4" goal="Promote to staging branch">
    <output>**Step 2/3: Promote to staging**

      Merging develop ‚Üí staging

      This deploys to the pre-production environment for final verification.</output>

    <ask>Proceed with promotion to staging? [Y/N]</ask>
    <check if="user says N">
      <output>Deployment paused at develop. Story is integrated but not in staging/production.</output>
      <action>Set {{final_environment}} = "develop"</action>
      <action>GOTO step 6</action>
    </check>

    <action>Run `git checkout staging`</action>
    <action>Run `git pull origin staging`</action>
    <action>Run `git merge develop --no-ff -m "Promote develop to staging: {{story_key}}"`</action>

    <check if="merge conflict">
      <output>**MERGE CONFLICT DETECTED**

        Resolve conflicts manually and re-run deploy-story.</output>
      <action>EXIT workflow</action>
    </check>

    <action>Run `git push origin staging`</action>

    <output>**Promoted to staging ‚úÖ**

      Vercel will deploy to: {deployment_urls.staging}
      Wait for deployment to complete...</output>

    <action>Wait 30 seconds for Vercel deployment trigger</action>
    <ask>Verify staging deployment is working at {deployment_urls.staging}. Continue to production? [Y/N]</ask>
    <check if="user says N">
      <output>Deployment paused at staging. Story is in pre-production but not live.</output>
      <action>Set {{final_environment}} = "staging"</action>
      <action>GOTO step 6</action>
    </check>
  </step>

  <step n="5" goal="Deploy to production">
    <output>**Step 3/3: Deploy to production**

      Merging staging ‚Üí main

      ‚ö†Ô∏è This deploys to PRODUCTION at {deployment_urls.production}</output>

    <ask>**FINAL CONFIRMATION**: Deploy to production? [Y/N]</ask>
    <check if="user says N">
      <output>Deployment paused at staging. Story is in pre-production but not live.</output>
      <action>Set {{final_environment}} = "staging"</action>
      <action>GOTO step 6</action>
    </check>

    <action>Run `git checkout main`</action>
    <action>Run `git pull origin main`</action>
    <action>Run `git merge staging --no-ff -m "Release to production: {{story_key}}

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"`</action>

    <check if="merge conflict">
      <output>**MERGE CONFLICT DETECTED**

        Resolve conflicts manually and re-run deploy-story.</output>
      <action>EXIT workflow</action>
    </check>

    <action>Run `git push origin main`</action>
    <action>Set {{final_environment}} = "production"</action>

    <output>**Deployed to production ‚úÖ**

      Live at: {deployment_urls.production}

      Verifying deployment...</output>

    <action>Wait 60 seconds for Vercel production deployment</action>
    <action>Run health check on {deployment_urls.production}</action>
  </step>

  <step n="6" goal="Clean up feature branch">
    <check if="{{current_branch}} starts with 'feature/' OR {{current_branch}} contains story key">
      <output>**Feature Branch Cleanup**

        Branch: {{current_branch}}</output>

      <ask>Delete feature branch {{current_branch}}? [Y/N]</ask>
      <check if="user says Y">
        <action>Run `git checkout develop`</action>
        <action>Run `git branch -d {{current_branch}}`</action>
        <action>Run `git push origin --delete {{current_branch}}`</action>
        <output>Feature branch deleted: {{current_branch}} ‚úÖ</output>
      </check>
      <check if="user says N">
        <output>Feature branch retained: {{current_branch}}</output>
      </check>
    </check>

    <check if="{{current_branch}} == 'develop' OR {{current_branch}} == 'staging' OR {{current_branch}} == 'main'">
      <output>No feature branch to clean up (was working directly on {{current_branch}}).</output>
    </check>
  </step>

  <step n="7" goal="Update Atlas memory and sprint status">
    <!-- Feed Atlas with deployment knowledge -->
    <action>Load {atlas_memory}</action>

    <action>Generate Atlas deployment nugget:
      ```
      ### Deployment - {{story_key}} - {{date}}

      **Summary:** {{story_key}} deployed to {{final_environment}}.

      **Changes Deployed:**
      - {{change_summary}}

      **Workflow Implications:**
      - Workflows affected: {{affected_workflows}}
      - Test scenarios validated: {{test_count}}

      **Deployment Path:** {{current_branch}} ‚Üí develop ‚Üí staging ‚Üí main

      **Source:** {{story_file_path}}
      ```
    </action>

    <ask>Update Atlas memory with deployment knowledge? [Y/N]</ask>
    <check if="user says Y">
      <action>Append nugget to Section 7 (Process &amp; Strategy) of {atlas_memory}</action>
      <action>Update Sync History table</action>
      <output>Atlas memory updated ‚úÖ</output>
    </check>

    <!-- Update sprint status -->
    <check if="{sprint_status} file exists">
      <action>Load {sprint_status}</action>
      <action>Update development_status[{{story_key}}] = "deployed"</action>
      <action>Add deployed_to: {{final_environment}}</action>
      <action>Add deployed_at: {{date}}</action>
      <action>Save file preserving structure</action>
      <output>Sprint status updated: {{story_key}} ‚Üí deployed ({{final_environment}})</output>
    </check>
  </step>

  <step n="8" goal="Deployment summary">
    <output>**DEPLOYMENT COMPLETE**

      **Story:** {{story_key}}
      **Final Environment:** {{final_environment}}
      **Production URL:** {deployment_urls.production}

      **Pipeline Executed:**
      ‚úÖ Story status verified (done)
      ‚úÖ Atlas pre-deployment validation
      ‚úÖ Merged to develop
      {{#if final_environment in ['staging', 'production']}}‚úÖ Promoted to staging{{else}}‚è∏Ô∏è Staging skipped{{/if}}
      {{#if final_environment == 'production'}}‚úÖ Deployed to production{{else}}‚è∏Ô∏è Production skipped{{/if}}
      {{#if branch_deleted}}‚úÖ Feature branch deleted{{else}}‚ÑπÔ∏è Feature branch retained{{/if}}
      ‚úÖ Atlas memory updated
      ‚úÖ Sprint status synced

      **Next Steps:**
      - Verify production functionality
      - Run `/bmad:bmm:workflows:sprint-status` to see sprint progress
      - Continue with next story via `/bmad:bmm:workflows:create-story`</output>
  </step>

</workflow>
